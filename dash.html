<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - UniAssist</title>
    <link rel="icon" type="image/jpeg" href="Logo%20F.jpeg" />
    <link rel="apple-touch-icon" href="Logo%20F.jpeg" />
    <!-- Social sharing / link preview -->
    <meta property="og:title" content="UniAssist â€¢ Study Dashboard" />
    <meta property="og:description" content="Track sessions, streaks and study groups in one place." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://uniassist-101.web.app/dash" />
    <meta property="og:image" content="https://uniassist-101.web.app/Logo%20F.jpeg" />
    <meta property="og:image:secure_url" content="https://uniassist-101.web.app/Logo%20F.jpeg" />
    <meta property="og:image:width" content="512" />
    <meta property="og:image:height" content="512" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="UniAssist â€¢ Study Dashboard" />
    <meta name="twitter:description" content="Track sessions, streaks and study groups in one place." />
    <meta name="twitter:image" content="https://uniassist-101.web.app/Logo%20F.jpeg" />

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore-compat.js"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Rainbow animated background */
        @keyframes rainbowSpin { to { transform: rotate(360deg); } }
        .rainbow-bg {
            position: fixed; inset: 0;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            overflow-x: hidden;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .rainbow-bg::before {
            content: '';
            position: absolute; inset: -25%;
            background: conic-gradient(
                from 0deg at 50% 50%,
                rgba(255, 99, 132, 0.5),
                rgba(255, 159, 67, 0.5),
                rgba(255, 220, 77, 0.5),
                rgba(72, 187, 120, 0.5),
                rgba(59, 130, 246, 0.5),
                rgba(139, 92, 246, 0.5),
                rgba(236, 72, 153, 0.5),
                rgba(255, 99, 132, 0.5)
            );
            filter: blur(80px) saturate(120%);
            animation: rainbowSpin 40s linear infinite;
            pointer-events: none;
            opacity: 0.25;
        }
        .dark .rainbow-bg {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
        }
        .dark .rainbow-bg::before {
            opacity: 0.35;
            filter: blur(90px) saturate(130%);
        }

        /* Glassmorphic cards */
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .dark .glass-card {
            background: rgba(30, 41, 59, 0.75);
            border: 1px solid rgba(71, 85, 105, 0.4);
        }

        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(20px); } }
        .animate-out { animation: fadeOut 0.3s ease-out forwards; }
        .card-hover { transition: transform 220ms ease, box-shadow 220ms ease, border-color 220ms ease; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); }
        .dark .card-hover:hover { box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); }

        /* Floating animation */
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-6px); } }
        .float-icon { animation: float 3s ease-in-out infinite; }

        /* Gradient text */
        .gradient-text { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #d946ef 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

        /* Shimmer effect */
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .shimmer { background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent); background-size: 200% 100%; animation: shimmer 2s infinite; }

        /* Header styling: frosted strip with a subtle accent bar */
        .app-header {
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(14px);
            background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.9));
            border-bottom: 1px solid rgba(148, 163, 184, 0.35);
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
        }
        .dark .app-header {
            background: linear-gradient(180deg, rgba(26, 32, 44, 0.92), rgba(17, 24, 39, 0.9));
            border-bottom-color: rgba(59, 130, 246, 0.28);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.35);
        }
        .app-header::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 2px;
            background: linear-gradient(90deg, rgba(99,102,241,0.55), rgba(56,189,248,0.55), rgba(16,185,129,0.55));
            opacity: 0.9;
        }
        .app-header-inner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 64px;
            padding: 0 24px;
        }
        /* Theme-aware logo visibility */
        :root:not(.dark) .logo-when-light { display: block; }
        :root:not(.dark) .logo-when-dark { display: none; }
        .dark .logo-when-light { display: none; }
        .dark .logo-when-dark { display: block; }

        /* Smooth modal scrollbars and prevent layout shift */
        .modal-scroll {
            overflow-y: auto;
            scrollbar-gutter: stable both-edges;
        }
        .modal-scroll::-webkit-scrollbar {
            width: 10px;
        }
        .modal-scroll::-webkit-scrollbar-thumb {
            background-color: rgba(148, 163, 184, 0.5);
            border-radius: 8px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }
        .dark .modal-scroll::-webkit-scrollbar-thumb {
            background-color: rgba(100, 116, 139, 0.5);
        }
    </style>
</head>
<body class="text-gray-900 dark:text-gray-100">

<script>
    // Dark Mode Toggle
    window.darkModeToggle = () => {
        document.documentElement.classList.toggle('dark');
        localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
    };
    
    // Initialize dark mode: default ON if unset
    (function initDark() {
        const pref = localStorage.getItem('darkMode');
        if (pref === null) {
            document.documentElement.classList.add('dark');
            localStorage.setItem('darkMode', 'true');
        } else if (pref === 'true') {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    })();

    // Initialize Firebase with global compat SDK
    (function initFirebase() {
        const cfg = {
            apiKey: "AIzaSyCa-AuFlVHpeNUJaTLAz98v7lQtdl5My8E",
            authDomain: "uniassist-101.firebaseapp.com",
            projectId: "uniassist-101",
            storageBucket: "uniassist-101.firebasestorage.app",
            messagingSenderId: "743555520176",
            appId: "1:743555520176:web:be1d9236e85933d4bacd75",
            measurementId: "G-DZQSZ7Q3W0"
        };

        if (!window.firebase) {
            console.error('Firebase SDK failed to load');
            return;
        }

        if (!window.firebase.apps.length) {
            window.firebase.initializeApp(cfg);
        }
    })();
</script>

<button 
    onclick="darkModeToggle()"
    class="hidden"
    id="floating-theme-toggle"
    title="Toggle dark mode"
>
    <svg class="w-5 h-5 text-gray-800 dark:text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
    </svg>
</button>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;
    const fb = window.firebase;
    const db = fb ? fb.firestore() : null;
    const increment = fb?.firestore?.FieldValue?.increment;
    const arrayUnion = fb?.firestore?.FieldValue?.arrayUnion;
    const auth = fb ? fb.auth() : null;

    // --- Icons ---
    const Icon = ({ path, className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
            {path}
        </svg>
    );

    const Icons = {
        ArrowLeft: (props) => <Icon {...props} path={<><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></>} />,
        BarChart3: (props) => <Icon {...props} path={<><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></>} />,
        ChevronLeft: (props) => <Icon {...props} path={<polyline points="15 18 9 12 15 6"/>} />,
        ChevronRight: (props) => <Icon {...props} path={<polyline points="9 18 15 12 9 6"/>} />,
        Trophy: (props) => <Icon {...props} path={<><path d="M6 9c0-1.657 1.343-3 3-3h6c1.657 0 3 1.343 3 3v6c0 1.657-1.343 3-3 3h-1v3h-4v-3H9c-1.657 0-3-1.343-3-3V9zm1 0v6c0 .552.448 1 1 1h6c.552 0 1-.448 1-1V9c0-.552-.448-1-1-1H8c-.552 0-1 .448-1 1z"/></>} />,
        Play: (props) => <Icon {...props} path={<polygon points="5 3 19 12 5 21 5 3"/>} />,
        Pause: (props) => <Icon {...props} path={<><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></>} />,
        SquareStop: (props) => <Icon {...props} path={<rect x="6" y="6" width="12" height="12" rx="2" ry="2"/>} />,
        Maximize2: (props) => <Icon {...props} path={<><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></>} />,
        Minimize2: (props) => <Icon {...props} path={<><polyline points="9 3 3 3 3 9"/><polyline points="15 21 21 21 21 15"/><line x1="3" y1="3" x2="10" y2="10"/><line x1="21" y1="21" x2="14" y2="14"/></>} />,
        User: (props) => <Icon {...props} path={<><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />,
        UserPlus: (props) => <Icon {...props} path={<><path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></>} />,
    };

        // --- Celebration Modal ---
        const CelebrationModal = ({ isOpen, streakCount, onClose }) => {
            if (!isOpen) return null;

            const messages = [
                "Amazing work!",
                "You're on fire!",
                "Keep it up!",
                "Fantastic!",
                "You're crushing it!",
            ];
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 animate-in">
                    {/* Backdrop blur */}
                    <div className="absolute inset-0 bg-black/40 backdrop-blur-md" onClick={onClose}></div>
                
                    {/* Modal content */}
                    <div className="relative bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 rounded-3xl shadow-2xl p-8 max-w-md w-full text-white transform scale-100 animate-in">
                        {/* Confetti/Stars decoration */}
                        <div className="absolute top-4 left-4 text-4xl animate-bounce">ðŸŽ‰</div>
                        <div className="absolute top-4 right-4 text-4xl animate-bounce" style={{animationDelay: '0.1s'}}>âœ¨</div>
                        <div className="absolute bottom-4 left-8 text-3xl animate-bounce" style={{animationDelay: '0.2s'}}>ðŸŒŸ</div>
                        <div className="absolute bottom-4 right-8 text-3xl animate-bounce" style={{animationDelay: '0.3s'}}>ðŸŽŠ</div>
                    
                        {/* Main content */}
                        <div className="text-center space-y-6 py-4">
                            {/* Trophy icon */}
                            <div className="flex justify-center">
                                <div className="bg-white/20 backdrop-blur rounded-full p-6 animate-pulse">
                                    <svg className="w-16 h-16 text-yellow-300" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                    </svg>
                                </div>
                            </div>
                        
                            {/* Message */}
                            <div>
                                <h2 className="text-4xl font-bold mb-2">{randomMessage}</h2>
                                <p className="text-xl font-semibold">Congrats on Day {streakCount}! ðŸ”¥</p>
                            </div>
                        
                            {/* Streak counter */}
                            <div className="bg-white/20 backdrop-blur rounded-2xl p-6">
                                <p className="text-6xl font-bold mb-2">{streakCount}</p>
                                <p className="text-sm uppercase tracking-wider opacity-90">Day Streak</p>
                            </div>
                        
                            {/* Motivational text */}
                            <p className="text-sm opacity-90">
                                {streakCount === 1 && "Great start! Come back tomorrow to keep the streak alive!"}
                                {streakCount > 1 && streakCount < 7 && "You're building momentum! Don't break the chain!"}
                                {streakCount >= 7 && streakCount < 30 && "Impressive dedication! You're unstoppable!"}
                                {streakCount >= 30 && "Legendary streak! You're a study champion!"}
                            </p>
                        
                            {/* Close button */}
                            <button
                                onClick={onClose}
                                className="mt-4 bg-white text-indigo-600 px-8 py-3 rounded-full font-semibold hover:bg-gray-100 transition-colors"
                            >
                                Continue Studying
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

    // --- Calendar Widget ---
    const CalendarWidget = ({ todos, onDateClick, selectedDate, compact = false }) => {
        const [currentMonth, setCurrentMonth] = useState(new Date());

        const getDateKey = (date) => {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        };

        const getDaysInMonth = (date) => {
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            return {
                daysInMonth: lastDay.getDate(),
                startingDayOfWeek: firstDay.getDay(),
                year,
                month
            };
        };

        const { daysInMonth, startingDayOfWeek, year, month } = getDaysInMonth(currentMonth);
        const monthName = currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

        const days = [];
        for (let i = 0; i < startingDayOfWeek; i++) {
            days.push(null);
        }
        for (let day = 1; day <= daysInMonth; day++) {
            days.push(day);
        }

        const hasTodos = (day) => {
            if (!day) return false;
            const dateKey = getDateKey(new Date(year, month, day));
            return (todos[dateKey] || []).length > 0;
        };

        const getTodoColor = (day) => {
            if (!day) return '';
            const dateKey = getDateKey(new Date(year, month, day));
            const tasksForDay = todos[dateKey] || [];
            if (tasksForDay.length === 0) return '';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const taskDate = new Date(year, month, day);
            taskDate.setHours(0, 0, 0, 0);
            const daysUntil = Math.floor((taskDate - today) / (1000 * 60 * 60 * 24));
            
            if (daysUntil < 0) return 'bg-gray-300 dark:bg-gray-600';
            if (daysUntil === 0) return 'bg-red-500';
            if (daysUntil <= 2) return 'bg-orange-500';
            if (daysUntil <= 5) return 'bg-yellow-500';
            return 'bg-green-500';
        };

        const isSelected = (day) => {
            if (!day || !selectedDate) return false;
            const dateKey = getDateKey(new Date(year, month, day));
            const selectedKey = getDateKey(selectedDate);
            return dateKey === selectedKey;
        };

        const isToday = (day) => {
            const today = new Date();
            return day && year === today.getFullYear() && month === today.getMonth() && day === today.getDate();
        };

        const changeMonth = (delta) => {
            const newMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + delta, 1);
            setCurrentMonth(newMonth);
        };

        const handleDayClick = (day) => {
            if (!day) return;
            const clickedDate = new Date(year, month, day);
            onDateClick(clickedDate);
        };

        return (
            <div className={`glass-card rounded-2xl shadow-lg ${compact ? 'p-4' : 'p-5'}`}>
                <div className="flex items-center justify-between mb-4">
                    <h3 className="font-bold text-gray-800 dark:text-gray-100 flex items-center gap-2">
                        <span className="text-lg">ðŸ“…</span> {monthName}
                    </h3>
                    <div className="flex gap-1">
                        <button onClick={() => changeMonth(-1)} className="p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition">
                            <Icons.ChevronLeft className="w-4 h-4" />
                        </button>
                        <button onClick={() => changeMonth(1)} className="p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition">
                            <Icons.ChevronRight className="w-4 h-4" />
                        </button>
                    </div>
                </div>
                <div className="grid grid-cols-7 gap-1 text-center text-xs">
                    {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((d, i) => (
                        <div key={i} className="font-semibold text-gray-500 dark:text-gray-400 py-1">{d}</div>
                    ))}
                    {days.map((day, idx) => {
                        const hasTask = hasTodos(day);
                        const taskColor = hasTask ? getTodoColor(day) : '';
                        return (
                            <button
                                key={idx}
                                onClick={() => handleDayClick(day)}
                                disabled={!day}
                                className={`
                                    relative aspect-square flex items-center justify-center rounded text-xs font-medium
                                    ${!day ? 'invisible' : ''}
                                    ${isToday(day) ? 'bg-indigo-600 text-white' : ''}
                                    ${isSelected(day) && !isToday(day) ? 'ring-2 ring-indigo-500 bg-indigo-50 dark:bg-indigo-900/30' : ''}
                                    ${!isSelected(day) && !isToday(day) && !hasTask ? 'hover:bg-gray-100 dark:hover:bg-gray-700' : ''}
                                    ${hasTask && !isToday(day) && !isSelected(day) ? taskColor : ''}
                                `}
                            >
                                {day}
                            </button>
                        );
                    })}
                </div>
            </div>
        );
    };

    // --- Study Timer Component ---
    const StudyTimer = ({ onStudySaved, onImmersiveChange, onStreakAchieved }) => {
        const [isOpen, setIsOpen] = useState(true); // keep the panel open to show clock always
        const [running, setRunning] = useState(false);
        const [focusSeconds, setFocusSeconds] = useState(0);
        const [totalSeconds, setTotalSeconds] = useState(0);
        const [maxFocusSeconds, setMaxFocusSeconds] = useState(0);
        const [recordedHours, setRecordedHours] = useState(0);
        const [pomodoroMode, setPomodoroMode] = useState(false);
        const [pomodoroStage, setPomodoroStage] = useState('focus'); // 'focus' | 'break'
        const [stageRemaining, setStageRemaining] = useState(0);
        const pomodoroModeRef = useRef(false);
        const pomodoroStageRef = useRef('focus');
        const stageRemainingRef = useRef(0);
        const intervalRef = useRef(null); // timeout handle
        const lastTickRef = useRef(null);
        const timerRef = useRef(null);
        const runningRef = useRef(false);
        const [focusMinutes, setFocusMinutes] = useState(25);
        const [breakMinutes, setBreakMinutes] = useState(5);
        const focusMinutesRef = useRef(25);
        const breakMinutesRef = useRef(5);
        const [clockStyle, setClockStyle] = useState('digital'); // 'digital' | 'ring'
        const [isFullscreen, setIsFullscreen] = useState(false);
        const [whiteNoiseOn, setWhiteNoiseOn] = useState(false);
        const audioCtxRef = useRef(null);
        const noiseNodeRef = useRef(null);
        const restoredRef = useRef(false);

        // Restore timer state from localStorage on mount (resume without resetting)
        useEffect(() => {
            if (restoredRef.current) return;
            restoredRef.current = true;
            try {
                const saved = localStorage.getItem('exammode_timer_state');
                if (saved) {
                    const state = JSON.parse(saved);
                    if (state.running && state.savedAt) {
                        const elapsed = Math.max(0, Math.floor((Date.now() - state.savedAt) / 1000));
                        const isFocusStage = !state.pomodoroMode || state.pomodoroStage === 'focus';
                        setTotalSeconds((state.totalSeconds || 0) + elapsed);
                        setFocusSeconds((state.focusSeconds || 0) + (isFocusStage ? elapsed : 0));
                        setMaxFocusSeconds(state.maxFocusSeconds || 0);
                        setPomodoroMode(!!state.pomodoroMode);
                        setPomodoroStage(state.pomodoroStage || 'focus');
                        setStageRemaining(Math.max(0, (state.stageRemaining || 0) - (state.pomodoroMode ? elapsed : 0)));
                        setFocusMinutes(state.focusMinutes || 25);
                        setBreakMinutes(state.breakMinutes || 5);
                        // Auto-resume the timer using current state
                        setTimeout(() => startTimer(true), 100);
                    }
                }
            } catch (e) {
                console.error('Failed to restore timer state:', e);
            }
        }, []);

        const FIVE_HOURS = 5 * 60 * 60;
        const getFocusSeconds = () => Math.max(1, Number(focusMinutesRef.current) || 1) * 60;
        const getBreakSeconds = () => Math.max(1, Number(breakMinutesRef.current) || 1) * 60;

        const fmt = (s) => {
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = s % 60;
            const pad = (n) => (n < 10 ? `0${n}` : n);
            return `${pad(h)}:${pad(m)}:${pad(sec)}`;
        };

        const fmtHHMM = (s) => {
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const pad = (n) => (n < 10 ? `0${n}` : n);
            return `${pad(h)}:${pad(m)}`;
        };

        // Keep refs in sync for accurate ticking without stale closures
        useEffect(() => { pomodoroModeRef.current = pomodoroMode; }, [pomodoroMode]);
        useEffect(() => { pomodoroStageRef.current = pomodoroStage; }, [pomodoroStage]);
        useEffect(() => { stageRemainingRef.current = stageRemaining; }, [stageRemaining]);
        useEffect(() => { runningRef.current = running; }, [running]);
        useEffect(() => { focusMinutesRef.current = focusMinutes; }, [focusMinutes]);
        useEffect(() => { breakMinutesRef.current = breakMinutes; }, [breakMinutes]);

        // Save timer state to localStorage when running (with last saved timestamp)
        useEffect(() => {
            const state = {
                running,
                savedAt: Date.now(),
                totalSeconds,
                focusSeconds,
                maxFocusSeconds,
                pomodoroMode,
                pomodoroStage,
                stageRemaining,
                focusMinutes,
                breakMinutes
            };
            if (running) {
                localStorage.setItem('exammode_timer_state', JSON.stringify(state));
            } else {
                // clear when stopped/paused to avoid auto-resume
                localStorage.removeItem('exammode_timer_state');
            }
        }, [running, totalSeconds, focusSeconds, maxFocusSeconds, pomodoroMode, pomodoroStage, stageRemaining, focusMinutes, breakMinutes]);

        const stopInterval = () => {
            if (intervalRef.current) clearTimeout(intervalRef.current);
            intervalRef.current = null;
            lastTickRef.current = null;
        };

        const startWhiteNoise = () => {
            if (!whiteNoiseOn) return;
            try {
                if (!audioCtxRef.current) {
                    audioCtxRef.current = new (window.AudioContext || window.webkitAudioContext)();
                }
                const ctx = audioCtxRef.current;
                if (ctx.state === 'suspended') {
                    ctx.resume();
                }
                const bufferSize = ctx.sampleRate * 2;
                const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = Math.random() * 0.05 - 0.025;
                }
                const source = ctx.createBufferSource();
                source.buffer = buffer;
                source.loop = true;
                source.connect(ctx.destination);
                source.start();
                noiseNodeRef.current = source;
            } catch (e) {
                console.error('White noise failed:', e);
            }
        };

        const stopWhiteNoise = () => {
            if (noiseNodeRef.current) {
                try {
                    noiseNodeRef.current.stop();
                    noiseNodeRef.current = null;
                } catch (e) {}
            }
        };

        const enterFullscreen = () => {
            const el = timerRef.current;
            if (el && el.requestFullscreen) {
                el.requestFullscreen().catch(() => {});
            }
        };

        const exitFullscreen = () => {
            if (document.fullscreenElement && document.exitFullscreen) {
                document.exitFullscreen().catch(() => {});
            }
        };

        const tick = () => {
            if (!runningRef.current) return;
            const now = Date.now();
            const last = lastTickRef.current || now;
            const deltaMs = now - last;
            const delta = Math.floor(deltaMs / 1000);
            if (delta <= 0) return;
            lastTickRef.current = last + delta * 1000; // drift-corrected anchor

            let nextStage = pomodoroStageRef.current;
            let nextRemaining = stageRemainingRef.current;

            if (pomodoroModeRef.current) {
                nextRemaining = Math.max(0, nextRemaining - delta);
                if (nextRemaining === 0) {
                    if (nextStage === 'focus') {
                        nextStage = 'break';
                        nextRemaining = getBreakSeconds();
                    } else {
                        nextStage = 'focus';
                        nextRemaining = getFocusSeconds();
                    }
                    setFocusSeconds(0);
                }
                pomodoroStageRef.current = nextStage;
                stageRemainingRef.current = nextRemaining;
                setPomodoroStage(nextStage);
                setStageRemaining(nextRemaining);
            }

            const isFocusStage = !pomodoroModeRef.current || nextStage === 'focus';

            if (isFocusStage) {
                setFocusSeconds(prev => {
                    const next = prev + delta;
                    setMaxFocusSeconds(maxPrev => Math.max(maxPrev, next));
                    if (next >= FIVE_HOURS) {
                        setMaxFocusSeconds(() => FIVE_HOURS);
                        stopInterval();
                        setRunning(false);
                        setTotalSeconds(0);
                        return 0;
                    }
                    return next;
                });
                setTotalSeconds(prev => prev + delta);
            }
        };

        const scheduleNextTick = () => {
            if (!runningRef.current) return;
            const now = Date.now();
            const last = lastTickRef.current || now;
            const nextTarget = last + 1000;
            const delay = Math.max(0, nextTarget - now);
            intervalRef.current = setTimeout(() => {
                if (!runningRef.current) return;
                tick();
                scheduleNextTick();
            }, delay);
        };

        const startTimer = (resume = false) => {
            setIsOpen(true);
            if (running) return;
            if (!resume) {
                setMaxFocusSeconds(0);
                setTotalSeconds(0);
                // Always start a new focus streak on fresh start
                setFocusSeconds(0);
                const usePomodoro = pomodoroMode;
                setPomodoroStage('focus');
                if (usePomodoro) {
                    setStageRemaining(getFocusSeconds());
                } else if (stageRemaining === 0) {
                    setStageRemaining(0);
                }
            }

            runningRef.current = true;
            setRunning(true);
            lastTickRef.current = Date.now();
            scheduleNextTick();
            
            // Start white noise if enabled
            if (whiteNoiseOn) {
                startWhiteNoise();
            }

            // Immerse the UI to focus on the timer
            if (onImmersiveChange) onImmersiveChange(true);
        };

        const pauseTimer = () => {
            stopInterval();
            stopWhiteNoise();
            runningRef.current = false;
            setRunning(false);
            setFocusSeconds(0); // reset focus on pause as requested
        };

        const stopTimer = async () => {
            stopInterval();
            stopWhiteNoise();
            runningRef.current = false;
            setRunning(false);
            setFocusSeconds(0);
            setMaxFocusSeconds(0);
            setStageRemaining(0);
            setPomodoroStage('focus');
            localStorage.removeItem('exammode_timer_state');

            if (totalSeconds > 0) {
                const hoursPrecise = totalSeconds / 3600;
                const userRaw = localStorage.getItem('exammode_user');
                let user = null;
                try { user = userRaw ? JSON.parse(userRaw) : null; } catch (e) {}

                const key = 'exammode_study_hours';
                const id = user?.uid || 'guest';
                const name = user?.username || user?.displayName || 'Student';
                const photoURL = user?.photoURL || null;
                
                console.log('stopTimer called:', { 
                    hasDb: !!db, 
                    hasIncrement: !!increment, 
                    hasAuth: !!auth, 
                    hasCurrentUser: !!(auth && auth.currentUser),
                    currentUser: auth?.currentUser ? auth.currentUser.email : 'none',
                    userId: id 
                });
                
                if (db && increment && auth && auth.currentUser) {
                    try {
                        await db.collection('study_hours').doc(id).set({
                            uid: id,
                            name,
                            photoURL,
                            hours: increment(hoursPrecise),
                            updatedAt: fb.firestore.FieldValue.serverTimestamp(),
                        }, { merge: true });

                        const docSnap = await db.collection('study_hours').doc(id).get();
                        const mine = docSnap.exists ? docSnap.data() : null;
                        setRecordedHours(mine ? Number(mine.hours || 0) : 0);

                        // Update streak
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const todayKey = today.toISOString().split('T')[0];
                        console.log('Updating streak for date:', todayKey, 'user:', id);
                        const streakRef = db.collection('streaks').doc(id);
                        const streakSnap = await streakRef.get();
                        const existing = streakSnap.exists ? streakSnap.data() : { days: [] };
                        console.log('Current streak days:', existing.days);
                        if (!existing.days.includes(todayKey)) {
                            existing.days.push(todayKey);
                            await streakRef.set({ days: existing.days, updatedAt: fb.firestore.FieldValue.serverTimestamp() }, { merge: true });
                            console.log('Streak updated! New days:', existing.days);
                                // Trigger celebration
                                if (onStreakAchieved) onStreakAchieved(existing.days.length);
                        } else {
                            console.log('Today already marked in streak');
                        }

                        if (onStudySaved) onStudySaved();
                    } catch (err) {
                        console.error('Failed to save study hours/streak:', err);
                    }
                } else {
                    console.warn('Streak not saved: Please sign in with Google to sync your streak to the server');
                    const savedRaw = localStorage.getItem(key);
                    let list = [];
                    if (savedRaw) {
                        try { list = JSON.parse(savedRaw) || []; } catch (e) { list = []; }
                    }
                    let found = false;
                    list = list.map(entry => {
                        if ((entry.uid || entry.name) === id || entry.uid === id) {
                            found = true;
                            const newHours = Number(entry.hours || 0) + hoursPrecise;
                            return { ...entry, uid: id, name, photoURL, hours: newHours };
                        }
                        return entry;
                    });
                    if (!found) {
                        list.push({ uid: id, name, photoURL, hours: hoursPrecise });
                    }
                    localStorage.setItem(key, JSON.stringify(list));
                    if (onStudySaved) onStudySaved(list);
                    const mine = list.find(e => (e.uid || e.name) === id || e.uid === id);
                    setRecordedHours(mine ? Number(mine.hours) : 0);
                }
            }
            setTotalSeconds(0);
            setIsOpen(false);
            if (onImmersiveChange) onImmersiveChange(false);
            exitFullscreen();
        };

        useEffect(() => () => stopInterval(), []);

        useEffect(() => {
            const onFs = () => setIsFullscreen(!!document.fullscreenElement);
            document.addEventListener('fullscreenchange', onFs);
            return () => document.removeEventListener('fullscreenchange', onFs);
        }, []);

        // Sync auth to local user info for consistent uid
        useEffect(() => {
            if (!auth) return;
            const unsub = auth.onAuthStateChanged(u => {
                if (u) {
                    const userObj = {
                        uid: u.uid,
                        displayName: u.displayName || 'Student',
                        photoURL: u.photoURL || null,
                        username: u.displayName || null,
                    };
                    try { localStorage.setItem('exammode_user', JSON.stringify(userObj)); } catch (e) {}
                }
            });
            return () => unsub && unsub();
        }, []);

        useEffect(() => {
            const userRaw = localStorage.getItem('exammode_user');
            let user = null;
            try { user = userRaw ? JSON.parse(userRaw) : null; } catch (e) {}
            const id = user?.uid || 'guest';
            const name = user?.username || user?.displayName || 'Student';
            const photoURL = user?.photoURL || null;
            
            // Update studying status when timer state changes
            if (db && id !== 'guest') {
                if (running) {
                    // Mark user as studying
                    db.collection('study_hours').doc(id).set({
                        uid: id,
                        name,
                        photoURL,
                        studying: true,
                        sessionStartTime: fb.firestore.FieldValue.serverTimestamp(),
                    }, { merge: true }).catch(err => console.error('Failed to update studying status', err));
                } else {
                    // Mark user as not studying
                    db.collection('study_hours').doc(id).set({
                        uid: id,
                        name,
                        photoURL,
                        studying: false,
                    }, { merge: true }).catch(err => console.error('Failed to update studying status', err));
                }
            }
        }, [running]);

        useEffect(() => {
            const userRaw = localStorage.getItem('exammode_user');
            let user = null;
            try { user = userRaw ? JSON.parse(userRaw) : null; } catch (e) {}
            const id = user?.uid || 'guest';
            if (db) {
                db.collection('study_hours').doc(id).get().then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        setRecordedHours(Number(data.hours || 0));
                    }
                }).catch(err => console.error('Failed to load study hours', err));
            } else {
                const key = 'exammode_study_hours';
                const savedRaw = localStorage.getItem(key);
                if (savedRaw) {
                    try {
                        const list = JSON.parse(savedRaw) || [];
                        const mine = list.find(e => (e.uid || e.name) === id || e.uid === id);
                        setRecordedHours(mine ? Number(mine.hours) : 0);
                    } catch (e) {}
                }
            }
        }, []);

        // Simple ring clock for a stylish view of session progress
        const RingClock = ({ label, seconds, maxSeconds, color = '#4f46e5' }) => {
            const radius = 80;
            const circumference = 2 * Math.PI * radius;
            const progress = Math.min(seconds / maxSeconds, 1);
            const offset = circumference * (1 - progress);
            return (
                <div className="flex items-center gap-6">
                    <svg width="200" height="200" className="overflow-visible">
                        <circle cx="100" cy="100" r={radius} stroke="#374151" strokeWidth="16" fill="none" />
                        <circle cx="100" cy="100" r={radius} stroke={color} strokeWidth="16" fill="none" strokeLinecap="round" strokeDasharray={circumference} strokeDashoffset={offset} />
                    </svg>
                    <div>
                        <p className="text-xs text-gray-500 dark:text-gray-400">{label}</p>
                        <p className="text-3xl font-bold text-indigo-600 dark:text-indigo-400">{fmt(seconds)}</p>
                        <p className="text-[11px] text-gray-500 dark:text-gray-400">Max: {fmt(maxSeconds)}</p>
                    </div>
                </div>
            );
        };

        const BigClock = ({ label, seconds }) => (
            <div className="flex items-start gap-4 text-center md:text-left">
                <div>
                    <p className="text-xs text-gray-500 dark:text-gray-400">{label}</p>
                    <p className="text-4xl sm:text-5xl font-bold text-indigo-500 dark:text-indigo-300 leading-tight">{fmt(seconds)}</p>
                    <p className="text-[11px] text-gray-500 dark:text-gray-400">{fmtHHMM(seconds)} hrs</p>
                </div>
            </div>
        );

        return (
            <div ref={timerRef} className={`glass-card backdrop-blur rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 sm:p-5 mb-6 card-hover animate-in w-full min-h-[360px] sm:min-h-[320px] ${isFullscreen ? 'flex flex-col items-center justify-center text-center gap-6 min-h-[70vh]' : ''}`}>
                <div className={`flex flex-col gap-3 md:flex-row md:items-center md:justify-between w-full ${isFullscreen ? 'items-center justify-center text-center gap-4 md:flex-col' : ''}`}>
                    <div>
                        <p className="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Study Timer</p>
                    </div>
                    <div className={`flex flex-wrap items-center gap-2 md:gap-3 w-full md:w-auto ${isFullscreen ? 'justify-center' : 'justify-start md:justify-end'}`}>
                        <button
                            onClick={() => !running && setPomodoroMode(!pomodoroMode)}
                            className={`px-3 py-2 rounded-lg text-xs font-semibold flex items-center gap-2 border transition ${pomodoroMode ? 'bg-rose-600 border-rose-700 text-white hover:bg-rose-700' : 'bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600'}`}
                            disabled={running}
                        >
                            <span className="w-2 h-2 rounded-full" style={{ backgroundColor: pomodoroMode ? '#fecdd3' : '#94a3b8' }}></span>
                            Use Pomodoro
                        </button>
                        <div className="flex items-center gap-2 bg-gray-100 dark:bg-gray-700 rounded-lg p-2 text-xs text-gray-700 dark:text-gray-200">
                            <label className="flex items-center gap-1">
                                <span className="text-[11px] text-gray-600 dark:text-gray-300">Focus</span>
                                <input
                                    type="number"
                                    min="1"
                                    max="180"
                                    value={focusMinutes}
                                    onChange={(e) => setFocusMinutes(Math.max(1, Math.min(180, Number(e.target.value) || 1)))}
                                    className="w-14 px-2 py-1 rounded bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 focus:outline-none"
                                    disabled={running}
                                />
                                <span>min</span>
                            </label>
                            <label className="flex items-center gap-1">
                                <span className="text-[11px] text-gray-600 dark:text-gray-300">Break</span>
                                <input
                                    type="number"
                                    min="1"
                                    max="180"
                                    value={breakMinutes}
                                    onChange={(e) => setBreakMinutes(Math.max(1, Math.min(180, Number(e.target.value) || 1)))}
                                    className="w-14 px-2 py-1 rounded bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 focus:outline-none"
                                    disabled={running}
                                />
                                <span>min</span>
                            </label>
                        </div>
                        <div className="flex items-center gap-2 bg-gray-100 dark:bg-gray-700 rounded-lg p-2">
                            <button
                                onClick={() => !running && setWhiteNoiseOn(!whiteNoiseOn)}
                                className={`px-3 py-1 rounded text-xs font-semibold transition ${whiteNoiseOn ? 'bg-cyan-600 text-white' : 'bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200'}`}
                                disabled={running}
                                title="Enable white noise for focus"
                            >
                                ðŸ”Š {whiteNoiseOn ? 'Noise ON' : 'Noise OFF'}
                            </button>
                        </div>
                        <div className="flex items-center gap-2 bg-gray-100 dark:bg-gray-700 rounded-lg p-1 px-2">
                            <span className="text-[11px] text-gray-600 dark:text-gray-300">Clock style</span>
                            <select
                                value={clockStyle}
                                onChange={(e) => setClockStyle(e.target.value)}
                                className="text-xs bg-transparent text-gray-800 dark:text-gray-100 focus:outline-none"
                            >
                                <option value="digital">Digital</option>
                                <option value="ring">Ring</option>
                            </select>
                        </div>
                        <button
                            onClick={() => (isFullscreen ? exitFullscreen() : enterFullscreen())}
                            className="px-3 py-2 bg-gray-900/80 hover:bg-gray-900 text-white text-sm font-semibold rounded-lg flex items-center gap-2 w-full sm:w-auto justify-center"
                        >
                            {isFullscreen ? <Icons.Minimize2 className="w-4 h-4"/> : <Icons.Maximize2 className="w-4 h-4"/>}
                            {isFullscreen ? 'Exit Fullscreen' : 'Fullscreen'}
                        </button>
                    </div>
                </div>

                <div className={`mt-4 p-4 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/40 min-h-[260px] ${isFullscreen ? 'w-full max-w-4xl' : ''}`}>
                    <div className={`flex flex-wrap items-center gap-6 ${isFullscreen ? 'justify-center text-center' : 'justify-center md:justify-start text-center md:text-left'}`}>
                        {clockStyle === 'ring' ? (
                            <>
                                <RingClock label="Total Session" seconds={totalSeconds} maxSeconds={FIVE_HOURS} color="#4f46e5" />
                                <RingClock label="Focus Time" seconds={focusSeconds} maxSeconds={FIVE_HOURS} color="#22c55e" />
                            </>
                        ) : (
                            <>
                                <BigClock label="Total Session" seconds={totalSeconds} />
                                <BigClock label="Focus Time" seconds={focusSeconds} />
                            </>
                        )}
                        {pomodoroMode && (
                            <div>
                                <p className="text-xs text-gray-500 dark:text-gray-400">Pomodoro Stage</p>
                                <p className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                                    {pomodoroStage === 'focus' ? 'Focus' : 'Break'} Â· {fmt(stageRemaining)}
                                </p>
                            </div>
                        )}
                    </div>
                    <div className={`mt-4 flex gap-2 flex-wrap ${isFullscreen ? 'justify-center' : ''}`}>
                        <button
                            onClick={running ? pauseTimer : () => startTimer(false)}
                            className={`px-3 py-2 rounded-lg text-sm font-semibold flex items-center gap-2 w-full sm:w-auto justify-center ${running ? 'bg-amber-500 hover:bg-amber-600 text-white' : 'bg-emerald-600 hover:bg-emerald-700 text-white'}`}
                        >
                            {running ? <><Icons.Pause className="w-4 h-4" />Pause & Reset Focus</> : <><Icons.Play className="w-4 h-4" />Start</>}
                        </button>
                        <button
                            onClick={stopTimer}
                            className="px-3 py-2 rounded-lg text-sm font-semibold flex items-center gap-2 bg-rose-600 hover:bg-rose-700 text-white w-full sm:w-auto justify-center"
                        >
                            <Icons.SquareStop className="w-4 h-4" /> Stop Studying
                        </button>
                    </div>
                    <p className="text-xs text-gray-500 dark:text-gray-400 mt-3">If focus exceeds 5 hours, the timer resets automatically. Recorded total: {recordedHours.toFixed(2)}h.</p>
                </div>
            </div>
        );
    };

    // --- Leaderboard Component ---
    const Leaderboard = ({ refreshKey }) => {
        const [leaderboardData, setLeaderboardData] = useState([]);

        useEffect(() => {
            if (db) {
                const unsub = db.collection('study_hours')
                    .orderBy('hours', 'desc')
                    .limit(20)
                    .onSnapshot(snapshot => {
                        const list = snapshot.docs.map(doc => ({ ...doc.data(), uid: doc.id }));
                        const ranked = list
                            .filter(item => item && (item.uid || item.name))
                            .map((item, idx) => ({
                                uid: item.uid || item.name,
                                name: item.name || 'Student',
                                hours: Number(item.hours) || 0,
                                photo: item.photoURL || null,
                                rank: idx + 1,
                            }));
                        setLeaderboardData(ranked);
                    }, (err) => {
                        console.error('Leaderboard subscription failed', err);
                        // fallback to local if subscription fails
                        const savedRaw = localStorage.getItem('exammode_study_hours');
                        let saved = [];
                        if (savedRaw) {
                            try { saved = JSON.parse(savedRaw); } catch (e) { saved = []; }
                        }
                        const ranked = saved
                            .filter(item => item && (item.uid || item.name))
                            .map(item => ({ ...item, uid: item.uid || item.name, hours: Number(item.hours) || 0 }))
                            .sort((a, b) => b.hours - a.hours)
                            .slice(0, 20)
                            .map((item, idx) => ({ ...item, rank: idx + 1 }));
                        setLeaderboardData(ranked);
                    });
                return () => unsub && unsub();
            }

            const savedRaw = localStorage.getItem('exammode_study_hours');
            let saved = [];
            if (savedRaw) {
                try { saved = JSON.parse(savedRaw); } catch (e) { saved = []; }
            }
            const ranked = saved
                .filter(item => item && (item.uid || item.name))
                .map(item => ({ ...item, uid: item.uid || item.name, hours: Number(item.hours) || 0 }))
                .sort((a, b) => b.hours - a.hours)
                .slice(0, 20)
                .map((item, idx) => ({ ...item, rank: idx + 1 }));
            setLeaderboardData(ranked);
        }, [refreshKey]);

        return (
            <div className="glass-card backdrop-blur rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 card-hover animate-in">
                <h3 className="font-semibold text-gray-800 dark:text-gray-100 text-sm mb-4 flex items-center gap-2">
                    <Icons.Trophy className="w-5 h-5 text-amber-600" />
                    Study Hours Leaderboard
                </h3>
                {leaderboardData.length === 0 ? (
                    <p className="text-sm text-gray-500 dark:text-gray-400">No study hours yet. Start studying to appear here.</p>
                ) : (
                    <div className="space-y-2">
                        {leaderboardData.map((student) => (
                            <div key={student.uid} className="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700/50 transition">
                                <div className="text-xl w-6 text-center">
                                    {student.rank === 1 ? 'ðŸ¥‡' : student.rank === 2 ? 'ðŸ¥ˆ' : student.rank === 3 ? 'ðŸ¥‰' : `${student.rank}`}
                                </div>
                                <div className="flex-1 min-w-0 flex items-center gap-3">
                                    {student.photo ? (
                                        <img src={student.photo} alt={student.name} className="w-8 h-8 rounded-full object-cover border border-gray-200" />
                                    ) : (
                                        <div className="w-8 h-8 rounded-full bg-indigo-100 text-indigo-700 flex items-center justify-center text-sm font-bold">
                                            {student.name?.[0]?.toUpperCase() || 'S'}
                                        </div>
                                    )}
                                    <p className="text-sm font-medium text-gray-900 dark:text-gray-100 truncate">{student.name}</p>
                                </div>
                                <div className="text-right min-w-[88px]">
                                    <p className="text-sm font-bold text-indigo-600 dark:text-indigo-400">{Number(student.hours || 0).toFixed(2)}h</p>
                                    <div className="w-24 bg-gray-200 dark:bg-gray-700 rounded-full h-1.5 mt-1">
                                        <div 
                                            className="bg-gradient-to-r from-indigo-500 to-purple-600 h-1.5 rounded-full"
                                            style={{ width: `${Math.min(100, (student.hours / 50) * 100)}%` }}
                                        ></div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );
    };

    // --- Dashboard Component ---
    const Dashboard = () => {
        const userRaw = localStorage.getItem('exammode_user');
        const user = userRaw ? (() => { try { return JSON.parse(userRaw); } catch (e) { return null; } })() : null;
        const uid = user?.uid || 'guest';
        const [streakDays, setStreakDays] = useState([]);
        const [isAuthenticated, setIsAuthenticated] = useState(false);

        useEffect(() => {
            if (!auth) return;
            const unsub = auth.onAuthStateChanged(u => {
                setIsAuthenticated(!!u);
                console.log('Auth state:', u ? `Signed in as ${u.displayName} (${u.email})` : 'Not signed in');
            });
            return () => unsub && unsub();
        }, []);

        useEffect(() => {
            if (!db || !uid) return;
            const unsub = db.collection('streaks').doc(uid).onSnapshot(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    setStreakDays(data.days || []);
                } else {
                    setStreakDays([]);
                }
            }, err => console.error('Streak listener failed', err));
            return () => unsub && unsub();
        }, [uid]);

        const last7Days = [];
        const today = new Date();
        const dayIndex = (today.getDay() + 6) % 7; // Monday=0 ... Sunday=6
        const weekStart = new Date(today);
        weekStart.setDate(today.getDate() - dayIndex);
        weekStart.setHours(0, 0, 0, 0);
        for (let i = 0; i < 7; i++) {
            const d = new Date(weekStart);
            d.setDate(weekStart.getDate() + i);
            last7Days.push(d);
        }

        const isStreakDay = (date) => {
            const key = date.toISOString().split('T')[0];
            return streakDays.includes(key);
        };

        const streakCount = streakDays.length;

        return (
            <div className="glass-card rounded-2xl shadow-lg p-5 card-hover animate-in">
                <h3 className="font-bold text-gray-800 dark:text-gray-100 mb-5 flex items-center gap-2">
                    <span className="text-2xl">â­</span>
                    <span className="gradient-text">Study Streak</span>
                </h3>
                {!isAuthenticated && (
                    <div className="mb-4 p-3 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg">
                        <p className="text-xs text-amber-800 dark:text-amber-200 flex items-center gap-2">
                            <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd"/>
                            </svg>
                            Sign in with Google to sync your streaks
                        </p>
                    </div>
                )}
                <div className="mb-4">
                    <p className="text-3xl font-bold text-indigo-600 dark:text-indigo-400">{streakCount}</p>
                    <p className="text-xs text-gray-500 dark:text-gray-400">days streak</p>
                    <p className="text-[11px] text-gray-500 dark:text-gray-400 mt-1">
                        Week {weekStart.toLocaleDateString(undefined,{month:'short', day:'numeric'})}
                        {' - '}
                        {new Date(weekStart.getFullYear(), weekStart.getMonth(), weekStart.getDate()+6).toLocaleDateString(undefined,{month:'short', day:'numeric'})}
                    </p>
                </div>
                <div className="flex gap-2 flex-wrap">
                    {last7Days.map((d, idx) => {
                        const active = isStreakDay(d);
                        const isToday = d.toDateString() === new Date().toDateString();
                        return (
                            <div key={idx} className="flex flex-col items-center gap-1">
                                <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xs font-semibold ${
                                    active ? 'bg-yellow-400 text-gray-900' : 'bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400'
                                } ${isToday ? 'ring-2 ring-indigo-500' : ''}`}>
                                    {d.getDate()}
                                </div>
                                <p className="text-[10px] text-gray-500 dark:text-gray-400">
                                    {d.toLocaleDateString('en-US', { weekday: 'short' })}
                                </p>
                            </div>
                        );
                    })}
                </div>
                <p className="text-xs text-gray-500 dark:text-gray-400 mt-4">Yellow days show your study activity. Keep it up!</p>
            </div>
        );
    };

    // --- Tabs Component ---
    const Tabs = ({ active, onChange }) => {
        const items = [
            { key: 'dashboard', label: 'Dashboard', icon: 'ðŸ“Š' },
            { key: 'timer', label: 'Study Timer', icon: 'â±ï¸' },
            { key: 'leaderboard', label: 'Leaderboard', icon: 'ðŸ†' },
            { key: 'groups', label: 'Groups', icon: 'ðŸ‘¥' },
        ];
        return (
            <div className="flex items-center glass-card rounded-2xl p-1.5 shadow-lg">
                {items.map(it => (
                    <button
                        key={it.key}
                        onClick={() => onChange(it.key)}
                        className={`flex-1 flex items-center justify-center gap-2 text-xs font-semibold px-4 py-2.5 rounded-xl transition-all duration-200 ${active === it.key ? 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg scale-[1.02]' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-100/50 dark:hover:bg-gray-700/50'}`}
                    >
                        <span className="text-sm">{it.icon}</span>
                        <span className="hidden sm:inline">{it.label}</span>
                    </button>
                ))}
            </div>
        );
    };

    // --- Join Request Item Component ---
    const JoinRequestItem = ({ request, group, onAcceptRequest, onDeclineRequest }) => {
        const [accepting, setAccepting] = useState(false);
        const [declining, setDeclining] = useState(false);
        const [actionMsg, setActionMsg] = useState('');

        const handleAccept = async () => {
            setAccepting(true);
            setActionMsg('');
            const res = await onAcceptRequest?.(group, request);
            if (res?.msg) setActionMsg(res.msg);
            setAccepting(false);
        };

        const handleDecline = async () => {
            setDeclining(true);
            setActionMsg('');
            const res = await onDeclineRequest?.(group, request);
            if (res?.msg) setActionMsg(res.msg);
            setDeclining(false);
        };

        const formatTime = (timestamp) => {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            if (minutes < 1) return 'just now';
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        };

        return (
            <div className="bg-white dark:bg-gray-800 p-3 rounded-lg border border-rose-200 dark:border-rose-700">
                <div className="flex items-center justify-between">
                    <div className="flex-1">
                        <p className="font-medium text-gray-900 dark:text-white">{request.name || 'Student'}</p>
                        <p className="text-xs text-gray-500 dark:text-gray-400">
                            {formatTime(request.requestedAt)}
                        </p>
                        {actionMsg && (
                            <p className="text-xs mt-1 text-emerald-600 dark:text-emerald-400">{actionMsg}</p>
                        )}
                    </div>
                    <div className="flex items-center gap-2">
                        <button
                            onClick={handleAccept}
                            disabled={accepting || declining}
                            className="px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold disabled:opacity-60 disabled:cursor-not-allowed"
                        >
                            {accepting ? 'Adding...' : 'Accept'}
                        </button>
                        <button
                            onClick={handleDecline}
                            disabled={accepting || declining}
                            className="px-3 py-1.5 rounded-lg bg-rose-600 hover:bg-rose-700 text-white text-sm font-semibold disabled:opacity-60 disabled:cursor-not-allowed"
                        >
                            {declining ? 'Declining...' : 'Decline'}
                        </button>
                    </div>
                </div>
            </div>
        );
    };

    // --- Groups Component ---
    // --- Group Detail Modal ---
    const GroupDetailModal = ({ group, members, onClose, studyStats, onLeave, onRemoveMember, joinRequests, onAcceptRequest, onDeclineRequest }) => {
        const userRaw = localStorage.getItem('exammode_user');
        const user = userRaw ? (() => { try { return JSON.parse(userRaw); } catch (e) { return null; } })() : null;
        const uid = user?.uid || 'guest';
        const displayName = user?.username || user?.displayName || 'You';

        const [showMembers, setShowMembers] = useState(true);
        const [weeklyLeaderboard, setWeeklyLeaderboard] = useState([]);
        const [messages, setMessages] = useState([]);
        const [newMessage, setNewMessage] = useState('');
        const [memberStudyStatus, setMemberStudyStatus] = useState({});
        const messagesEndRef = useRef(null);
        const [tab, setTab] = useState('members'); // members | leaderboard | chat
        const [memberActionMsg, setMemberActionMsg] = useState('');
        const [removingUid, setRemovingUid] = useState(null);
        const [leaving, setLeaving] = useState(false);

        // Lock background scroll while modal is open and prevent layout shift
        useEffect(() => {
            const body = document.body;
            const html = document.documentElement;
            const prevBodyOverflow = body.style.overflow;
            const prevHtmlOverflow = html.style.overflow;
            const prevBodyPaddingRight = body.style.paddingRight;
            const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
            if (scrollbarWidth > 0) body.style.paddingRight = `${scrollbarWidth}px`;
            body.style.overflow = 'hidden';
            html.style.overflow = 'hidden';
            return () => {
                body.style.overflow = prevBodyOverflow;
                html.style.overflow = prevHtmlOverflow;
                body.style.paddingRight = prevBodyPaddingRight;
            };
        }, []);

        const scrollToBottom = () => {
            messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
        };

        useEffect(() => {
            scrollToBottom();
        }, [messages]);

        // Calculate weekly hours (last 7 days)
        const calculateWeeklyHours = (totalHours) => {
            // For now, we'll show a portion of total hours as "weekly"
            // In production, you'd track daily breakdowns
            return Math.min(totalHours, totalHours);
        };

        // Load weekly leaderboard + member status from global study_hours (batched for >10 members)
        useEffect(() => {
            if (!db || !group || !group.id || !members || members.length === 0) return;

            const memberUids = members.map(m => m.uid).filter(Boolean);
            if (memberUids.length === 0) return;

            const chunks = [];
            for (let i = 0; i < memberUids.length; i += 10) {
                chunks.push(memberUids.slice(i, i + 10));
            }

            const unsubs = [];
            const aggregateMap = new Map();
            const statusMap = {};

            const handleSnapshot = (snapshot) => {
                snapshot.docs.forEach(doc => {
                    const d = doc.data();
                    aggregateMap.set(doc.id, {
                        id: doc.id,
                        name: d.name || 'Student',
                        weeklyHours: calculateWeeklyHours(d.hours || 0),
                        totalHours: d.hours || 0,
                    });
                    statusMap[doc.id] = {
                        studying: !!d.studying,
                        hours: Number(d.hours || 0),
                        name: d.name || 'Student',
                        // Preserve server timestamp for start time if available
                        sessionStartTime: d.sessionStartTime || null,
                    };
                });

                // Update state with merged results
                const merged = Array.from(aggregateMap.values())
                    .sort((a, b) => b.weeklyHours - a.weeklyHours)
                    .slice(0, 10);
                setWeeklyLeaderboard(merged);
                setMemberStudyStatus({ ...statusMap });
            };

            chunks.forEach(batch => {
                const unsub = db.collection('study_hours')
                    .where('uid', 'in', batch)
                    .onSnapshot(handleSnapshot, err => console.error('Weekly leaderboard fetch failed', err));
                unsubs.push(unsub);
            });

            return () => {
                unsubs.forEach(u => u && u());
            };
        }, [group?.id, members]);

        // Load messages
        useEffect(() => {
            if (!db || !group || !group.id) return;
            const unsubMessages = db.collection('groups').doc(group.id).collection('messages')
                .orderBy('timestamp', 'asc')
                .limit(100)
                .onSnapshot(snapshot => {
                    const msgs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setMessages(msgs);
                }, err => console.error('Messages fetch failed', err));
            
            return () => unsubMessages && unsubMessages();
        }, [group?.id]);

        const sendMessage = async () => {
            if (!newMessage.trim() || !db || !group || !group.id) return;
            try {
                await db.collection('groups').doc(group.id).collection('messages').add({
                    uid,
                    name: displayName,
                    text: newMessage.trim(),
                    timestamp: fb.firestore.FieldValue.serverTimestamp(),
                });
                setNewMessage('');
            } catch (err) {
                console.error('Send message failed', err);
            }
        };

        const deleteMessage = async (messageId) => {
            if (!db || !group || !group.id || !messageId) return;
            try {
                await db.collection('groups').doc(group.id).collection('messages').doc(messageId).delete();
            } catch (err) {
                console.error('Delete message failed', err);
            }
        };

        const roster = members || [];
        const currently_studying = roster.filter(m => memberStudyStatus[m.uid]?.studying) || [];
        const completed = roster.filter(m => !memberStudyStatus[m.uid]?.studying && memberStudyStatus[m.uid]?.hours > 0) || [];
        const isOwner = group?.ownerUid === uid;

        const removeMember = async (member) => {
            if (!isOwner || !member?.uid) return;
            setMemberActionMsg('');
            setRemovingUid(member.uid);
            try {
                const res = await onRemoveMember?.(group, member);
                if (res?.msg) setMemberActionMsg(res.msg);
            } catch (err) {
                console.error('Remove member failed', err);
                setMemberActionMsg('Failed to remove member.');
            } finally {
                setRemovingUid(null);
            }
        };

        const leaveThisGroup = async () => {
            setMemberActionMsg('');
            setLeaving(true);
            try {
                const res = await onLeave?.(group);
                if (res?.msg) setMemberActionMsg(res.msg);
                if (res?.ok) onClose();
            } catch (err) {
                console.error('Leave group failed', err);
                setMemberActionMsg('Failed to leave group.');
            } finally {
                setLeaving(false);
            }
        };

        const formatHours = (seconds) => {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            return h > 0 ? `${h}h ${m}m` : `${m}m`;
        };

        const formatTime = (timestamp) => {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            if (diffMins < 1) return 'now';
            if (diffMins < 60) return `${diffMins}m ago`;
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours}h ago`;
            return date.toLocaleDateString();
        };

        const modal = (
            <div className="fixed inset-0 bg-black/20 backdrop-blur-lg z-[1000] flex items-center justify-center p-4 md:p-6 animate-in" style={{ minHeight: '100svh' }} onClick={onClose}>
                <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-4xl w-[94vw] md:w-[85vw] max-h-[85vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
                    {/* Header */}
                    <div className="flex items-center justify-between border-b border-gray-200 dark:border-gray-700 p-6">
                        <h2 className="text-2xl font-bold text-gray-900 dark:text-white">{group.name}</h2>
                        <button onClick={onClose} className="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full">
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>

                    {/* Tabs */}
                    <div className="px-6 pt-4 border-b border-gray-200 dark:border-gray-700">
                        <div className="inline-flex rounded-lg p-1 bg-gray-100 dark:bg-gray-700/60 text-sm">
                            <button onClick={() => setTab('members')} className={`px-3 py-1.5 rounded-md font-medium transition ${tab==='members' ? 'bg-white dark:bg-gray-800 text-gray-900 dark:text-white shadow' : 'text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white'}`}>Members</button>
                            {isOwner && (
                                <button onClick={() => setTab('requests')} className={`px-3 py-1.5 rounded-md font-medium transition relative ${tab==='requests' ? 'bg-white dark:bg-gray-800 text-gray-900 dark:text-white shadow' : 'text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white'}`}>
                                    Requests
                                    {joinRequests && joinRequests.length > 0 && (
                                        <span className="ml-1 inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-rose-500 rounded-full">{joinRequests.length}</span>
                                    )}
                                </button>
                            )}
                            <button onClick={() => setTab('leaderboard')} className={`px-3 py-1.5 rounded-md font-medium transition ${tab==='leaderboard' ? 'bg-white dark:bg-gray-800 text-gray-900 dark:text-white shadow' : 'text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white'}`}>Leaderboard</button>
                            <button onClick={() => setTab('chat')} className={`px-3 py-1.5 rounded-md font-medium transition ${tab==='chat' ? 'bg-white dark:bg-gray-800 text-gray-900 dark:text-white shadow' : 'text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white'}`}>Chat {messages.length ? `(${messages.length})` : ''}</button>
                        </div>
                    </div>

                    {/* Content */}
                    <div className="flex-1 modal-scroll p-6 space-y-4">
                        {tab === 'members' && (
                        <div className="bg-gray-50 dark:bg-gray-700/50 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                            <div className="w-full flex items-center justify-between font-semibold text-gray-900 dark:text-white p-4">
                                <span>Members ({roster.length})</span>
                            </div>
                            <div className="border-t border-gray-200 dark:border-gray-700 p-4 space-y-4">
                                    {memberActionMsg && (
                                        <div className="text-xs px-3 py-2 rounded bg-indigo-50 dark:bg-indigo-900/30 border border-indigo-200 dark:border-indigo-800 text-indigo-700 dark:text-indigo-200">
                                            {memberActionMsg}
                                        </div>
                                    )}
                                    {/* Currently Studying */}
                                    <div className="bg-blue-50 dark:bg-blue-900/30 rounded-lg p-3 border border-blue-200 dark:border-blue-800">
                                        <h4 className="font-semibold text-blue-900 dark:text-blue-200 mb-2 text-sm flex items-center gap-2">
                                            <Icons.Play className="w-4 h-4" />
                                            Studying Now ({currently_studying.length})
                                        </h4>
                                        <div className="space-y-1.5">
                                            {currently_studying.length === 0 ? (
                                                <p className="text-xs text-blue-700 dark:text-blue-300">No one is studying right now</p>
                                            ) : (
                                                currently_studying.map(m => (
                                                    <div key={m.uid} className="flex items-center justify-between bg-white dark:bg-gray-700 p-2 rounded text-xs">
                                                        <p className="font-medium text-gray-900 dark:text-white">{m.name || 'Student'}</p>
                                                        <span className="font-semibold text-blue-600 dark:text-blue-300">
                                                            {(() => {
                                                                const st = memberStudyStatus[m.uid]?.sessionStartTime;
                                                                if (!st) return '0m';
                                                                const start = st.toDate ? st.toDate() : new Date(st);
                                                                const diffSec = Math.max(0, Math.floor((Date.now() - start.getTime()) / 1000));
                                                                return formatHours(diffSec);
                                                            })()}
                                                        </span>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    </div>

                                    {/* Completed Today */}
                                    <div className="bg-green-50 dark:bg-green-900/30 rounded-lg p-3 border border-green-200 dark:border-green-800">
                                        <h4 className="font-semibold text-green-900 dark:text-green-200 mb-2 text-sm flex items-center gap-2">
                                            <Icons.SquareStop className="w-4 h-4" />
                                            Finished Today ({completed.length})
                                        </h4>
                                        <div className="space-y-1.5">
                                            {completed.length === 0 ? (
                                                <p className="text-xs text-green-700 dark:text-green-300">No completed sessions yet</p>
                                            ) : (
                                                completed.map(m => (
                                                    <div key={m.uid} className="flex items-center justify-between bg-white dark:bg-gray-700 p-2 rounded text-xs">
                                                        <p className="font-medium text-gray-900 dark:text-white">{m.name || 'Student'}</p>
                                                        <span className="font-semibold text-green-600 dark:text-green-300">
                                                            {formatHours((memberStudyStatus[m.uid]?.hours || 0) * 3600)}
                                                        </span>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    </div>

                                    {/* Full roster with owner controls */}
                                    <div className="bg-white dark:bg-gray-800 rounded-lg p-3 border border-gray-200 dark:border-gray-700">
                                        <h4 className="font-semibold text-gray-900 dark:text-white mb-2 text-sm">All Members</h4>
                                        <div className="space-y-2">
                                            {roster.length === 0 ? (
                                                <p className="text-xs text-gray-500 dark:text-gray-400">No members yet.</p>
                                            ) : (
                                                roster.map(m => {
                                                    const isSelf = m.uid === uid;
                                                    const roleLabel = m.uid === group.ownerUid ? 'Owner' : 'Member';
                                                    return (
                                                        <div key={m.uid || m.name} className="flex items-center justify-between bg-gray-50 dark:bg-gray-700 px-3 py-2 rounded text-xs">
                                                            <div className="flex items-center gap-2">
                                                                <span className="font-medium text-gray-900 dark:text-white">{m.name || 'Student'}</span>
                                                                <span className="text-[10px] px-2 py-0.5 rounded-full bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-100">{roleLabel}</span>
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                {!isOwner && isSelf && (
                                                                    <button onClick={leaveThisGroup} disabled={leaving} className="px-2 py-1 rounded bg-rose-600 hover:bg-rose-700 text-white disabled:opacity-60">{leaving ? 'Leaving...' : 'Leave'}</button>
                                                                )}
                                                                {isOwner && !isSelf && (
                                                                    <button
                                                                        onClick={() => removeMember(m)}
                                                                        disabled={removingUid === m.uid}
                                                                        className="px-2 py-1 rounded bg-rose-600 hover:bg-rose-700 text-white disabled:opacity-60"
                                                                    >
                                                                        {removingUid === m.uid ? 'Removing...' : 'Remove'}
                                                                    </button>
                                                                )}
                                                            </div>
                                                        </div>
                                                    );
                                                })
                                            )}
                                        </div>
                                    </div>
                                </div>
                        </div>
                        )}

                        {tab === 'requests' && isOwner && (
                        <div className="bg-gradient-to-br from-rose-50 to-orange-50 dark:from-rose-900/20 dark:to-orange-900/20 rounded-xl p-4 border border-rose-200 dark:border-rose-800">
                            <h3 className="font-semibold text-rose-900 dark:text-rose-200 mb-3 flex items-center gap-2">
                                <Icons.UserPlus className="w-4 h-4" />
                                Pending Join Requests ({joinRequests ? joinRequests.length : 0})
                            </h3>
                            <div className="space-y-3">
                                {!joinRequests || joinRequests.length === 0 ? (
                                    <p className="text-sm text-rose-700 dark:text-rose-300">No pending requests</p>
                                ) : (
                                    joinRequests.map(request => (
                                        <JoinRequestItem
                                            key={request.id}
                                            request={request}
                                            group={group}
                                            onAcceptRequest={onAcceptRequest}
                                            onDeclineRequest={onDeclineRequest}
                                        />
                                    ))
                                )}
                            </div>
                        </div>
                        )}

                        {tab === 'leaderboard' && (
                        <div className="bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 rounded-xl p-4 border border-indigo-200 dark:border-indigo-800">
                            <h3 className="font-semibold text-indigo-900 dark:text-indigo-200 mb-3 flex items-center gap-2">
                                <Icons.Trophy className="w-4 h-4" />
                                Weekly Leaderboard
                            </h3>
                            <div className="space-y-2">
                                {weeklyLeaderboard.length === 0 ? (
                                    <p className="text-sm text-indigo-700 dark:text-indigo-300">No leaderboard data yet</p>
                                ) : (
                                    weeklyLeaderboard.map((entry, idx) => (
                                        <div key={entry.id} className="flex items-center justify-between bg-white dark:bg-gray-700 p-2.5 rounded-lg text-sm">
                                            <div className="flex items-center gap-2">
                                                <span className="font-bold w-6 h-6 flex items-center justify-center rounded-full bg-indigo-600 text-white text-xs">
                                                    {idx + 1}
                                                </span>
                                                <p className="font-medium text-gray-900 dark:text-white">{entry.name || 'Student'}</p>
                                            </div>
                                            <span className="font-semibold text-indigo-600 dark:text-indigo-300">
                                                {entry.weeklyHours ? `${entry.weeklyHours.toFixed(1)}h` : '0h'}
                                            </span>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                        )}

                        {tab === 'chat' && (
                        <div className="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden flex flex-col max-h-[45vh]">
                            <div className="border-b border-gray-200 dark:border-gray-700 p-3 bg-gray-50 dark:bg-gray-800">
                                <h3 className="font-semibold text-gray-900 dark:text-white text-sm">Group Chat ({messages.length})</h3>
                            </div>
                            
                            {/* Messages */}
                            <div className="flex-1 space-y-2 overflow-y-auto p-3">
                                {messages.length === 0 ? (
                                    <div className="flex items-center justify-center h-full text-gray-500 dark:text-gray-400">
                                        <p className="text-xs">No messages yet. Start the conversation!</p>
                                    </div>
                                ) : (
                                    messages.map((msg) => (
                                        <div key={msg.id} className={`flex gap-2 group ${msg.uid === uid ? 'flex-row-reverse' : ''}`}>
                                            <div className={`flex-1 ${msg.uid === uid ? 'text-right' : ''}`}>
                                                <div className={`text-xs text-gray-500 dark:text-gray-400 mb-0.5 flex items-center gap-2 ${msg.uid === uid ? 'justify-end' : 'justify-start'}`}>
                                                    <span>{msg.name || 'Anonymous'} â€¢ {formatTime(msg.timestamp)}</span>
                                                    {isOwner && (
                                                        <button
                                                            onClick={() => deleteMessage(msg.id)}
                                                            className="text-rose-600 hover:text-rose-700 dark:text-rose-400 dark:hover:text-rose-300 opacity-0 group-hover:opacity-100 transition-opacity"
                                                            title="Delete message"
                                                        >
                                                            <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                            </svg>
                                                        </button>
                                                    )}
                                                </div>
                                                <div className={`inline-block px-3 py-1.5 rounded-lg text-xs ${
                                                    msg.uid === uid 
                                                        ? 'bg-indigo-600 text-white rounded-br-none' 
                                                        : 'bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white rounded-bl-none'
                                                }`}>
                                                    {msg.text}
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                )}
                                <div ref={messagesEndRef} />
                            </div>

                            {/* Message Input */}
                            <div className="border-t border-gray-200 dark:border-gray-700 p-3 bg-gray-50 dark:bg-gray-800 flex gap-2">
                                <input 
                                    type="text"
                                    value={newMessage}
                                    onChange={(e) => setNewMessage(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                                    placeholder="Message..."
                                    className="flex-1 px-3 py-2 rounded text-xs bg-white dark:bg-gray-700 text-gray-900 dark:text-white border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                />
                                <button 
                                    onClick={sendMessage}
                                    disabled={!newMessage.trim()}
                                    className="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 text-white text-xs font-semibold rounded transition"
                                >
                                    Send
                                </button>
                            </div>
                        </div>
                        )}
                    </div>

                    <div className="border-t border-gray-200 dark:border-gray-700 p-4 flex items-center justify-end bg-white dark:bg-gray-800">
                        <button onClick={onClose} className="px-4 py-2 text-sm font-semibold rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        );
        return ReactDOM.createPortal(modal, document.body);
    };

    const GroupsManager = () => {
        const userRaw = localStorage.getItem('exammode_user');
        const user = userRaw ? (() => { try { return JSON.parse(userRaw); } catch (e) { return null; } })() : null;
        const uid = user?.uid || 'guest';
        const displayName = user?.username || user?.displayName || 'You';

        const [created, setCreated] = useState([]);
        const [joined, setJoined] = useState([]);
        const [publicGroups, setPublicGroups] = useState([]);
        const [members, setMembers] = useState({});
        const [createName, setCreateName] = useState('');
        const [createPublic, setCreatePublic] = useState(true);
        const [joinCode, setJoinCode] = useState('');
        const createNameInputRef = useRef(null);
        const [lastCreatedCode, setLastCreatedCode] = useState('');
        const [message, setMessage] = useState('');
        const [error, setError] = useState('');
        const [loading, setLoading] = useState(false);
        const [leaveBusy, setLeaveBusy] = useState(null);
        const [selectedGroup, setSelectedGroup] = useState(null);
        const [studyStats, setStudyStats] = useState({});
        const [showActions, setShowActions] = useState(false);
        const [actionTab, setActionTab] = useState('create');
        const [joinRequests, setJoinRequests] = useState({});

        // Keep the cursor anchored in the group name field while typing
        useEffect(() => {
            if (showActions && actionTab === 'create' && createNameInputRef.current) {
                const el = createNameInputRef.current;
                requestAnimationFrame(() => {
                    el.focus();
                    const len = el.value.length;
                    el.setSelectionRange(len, len);
                });
            }
        }, [showActions, actionTab, createName]);

        useEffect(() => {
            if (!db) return;
            const unsubMine = db.collection('groups')
                .where('memberIds', 'array-contains', uid)
                .onSnapshot(snapshot => {
                    const all = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setMembers(all.reduce((acc, g) => ({ ...acc, [g.id]: g.members || [] }), {}));
                    setCreated(all.filter(g => g.ownerUid === uid));
                    setJoined(all.filter(g => g.ownerUid !== uid));
                }, err => console.error('Groups listener failed', err));

            const unsubPublic = db.collection('groups')
                .where('isPublic', '==', true)
                .onSnapshot(snapshot => {
                    setPublicGroups(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }, err => console.error('Public groups listener failed', err));

            return () => {
                unsubMine && unsubMine();
                unsubPublic && unsubPublic();
            };
        }, [uid]);

        useEffect(() => {
            if (!db || !selectedGroup?.id) return;
            const unsubStats = db.collection('groups').doc(selectedGroup.id).collection('memberStats')
                .onSnapshot(snapshot => {
                    const stats = {};
                    snapshot.docs.forEach(doc => {
                        stats[doc.id] = doc.data();
                    });
                    setStudyStats(stats);
                }, err => console.error('Study stats fetch failed', err));

            return () => unsubStats && unsubStats();
        }, [selectedGroup?.id]);

        // Listen to join requests for all created groups
        useEffect(() => {
            if (!db || created.length === 0) return;
            const unsubs = [];
            const allRequests = {};
            
            created.forEach(group => {
                const unsub = db.collection('groups').doc(group.id).collection('joinRequests')
                    .where('status', '==', 'pending')
                    .onSnapshot(snapshot => {
                        const requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        allRequests[group.id] = requests;
                        setJoinRequests({ ...allRequests });
                    }, err => console.error('Join requests fetch failed', err));
                unsubs.push(unsub);
            });

            return () => unsubs.forEach(u => u && u());
        }, [created.map(g => g.id).join(',')]);

        const createGroup = async () => {
            setMessage('');
            setError('');
            if (!createName.trim()) {
                setError('Enter a group name');
                return;
            }
            if (created.length >= 2) {
                setError('Limit reached: You can create only 2 groups.');
                return;
            }
            if (!db || !arrayUnion || !auth || !auth.currentUser) {
                setError('Firebase is not ready.');
                return;
            }
            setLoading(true);
            const id = `g-${Date.now()}`;
            const docRef = db.collection('groups').doc(id);
            try {
                await docRef.set({
                    name: createName.trim(),
                    isPublic: !!createPublic,
                    ownerUid: uid,
                    ownerName: displayName,
                    memberIds: [uid],
                    members: [{ uid, name: displayName }],
                    createdAt: fb.firestore.FieldValue.serverTimestamp(),
                });
                setCreateName('');
                setLastCreatedCode(id);
                setJoinCode(id); // prefill join with new code
                setActionTab('join');
                setShowActions(true);
                setMessage(`Group created. Code: ${id}`);
            } catch (err) {
                console.error('Create group failed', err);
                setError('Failed to create group.');
            } finally {
                setLoading(false);
            }
        };

        const fetchGroupByCodeOrName = async (code) => {
            if (!db) return null;
            const byId = await db.collection('groups').doc(code).get();
            if (byId.exists) return { id: byId.id, ...byId.data() };
            const byName = await db.collection('groups').where('name', '==', code).limit(1).get();
            if (!byName.empty) {
                const doc = byName.docs[0];
                return { id: doc.id, ...doc.data() };
            }
            return null;
        };

        const joinGroup = async (groupIdOrName) => {
            setMessage('');
            setError('');
            const code = (groupIdOrName || joinCode || '').trim();
            if (!code) {
                setError('Enter or pick a group to join');
                return;
            }
            if (joined.length >= 2) {
                setError('Limit reached: You can join only 2 groups.');
                return;
            }
            if (!db || !arrayUnion || !auth || !auth.currentUser) {
                setError('Firebase is not ready.');
                return;
            }
            try {
                const target = await fetchGroupByCodeOrName(code);
                if (!target) {
                    setError('Group not found.');
                    return;
                }
                if (!target.isPublic && target.ownerUid !== uid) {
                    setError('This group is private.');
                    return;
                }
                const alreadyOwned = created.some(g => g.id === target.id);
                const alreadyJoined = joined.some(g => g.id === target.id);
                if (alreadyOwned || alreadyJoined) {
                    setError('You are already in this group.');
                    return;
                }
                
                // Check if user already has a pending request
                const existingRequests = await db.collection('groups').doc(target.id).collection('joinRequests')
                    .where('uid', '==', uid)
                    .where('status', '==', 'pending')
                    .get();
                
                if (!existingRequests.empty) {
                    setError('You already have a pending join request for this group.');
                    return;
                }
                
                // Create a join request instead of directly joining
                await db.collection('groups').doc(target.id).collection('joinRequests').add({
                    uid,
                    name: displayName,
                    status: 'pending',
                    requestedAt: fb.firestore.FieldValue.serverTimestamp(),
                });
                
                setJoinCode('');
                setMessage(`Join request sent to ${target.name}. Waiting for owner approval.`);
            } catch (err) {
                console.error('Join request failed', err);
                setError('Failed to send join request.');
            }
        };

        const leaveGroup = async (group) => {
            setMessage('');
            setError('');
            if (!group?.id) return { ok: false, msg: 'Group missing.' };
            if (group.ownerUid === uid) return { ok: false, msg: 'Owners cannot leave their own group.' };
            if (!db || !auth || !auth.currentUser) return { ok: false, msg: 'Firebase is not ready.' };
            setLeaveBusy(group.id);
            try {
                await db.runTransaction(async (tx) => {
                    const ref = db.collection('groups').doc(group.id);
                    const snap = await tx.get(ref);
                    if (!snap.exists) throw new Error('Group not found');
                    const data = snap.data() || {};
                    const memberIds = (data.memberIds || []).filter(id => id !== uid);
                    const membersArr = (data.members || []).filter(m => m.uid !== uid);
                    tx.update(ref, { memberIds, members: membersArr });
                });
                setSelectedGroup(null);
                setMessage('You left the group.');
                return { ok: true, msg: 'You left the group.' };
            } catch (err) {
                console.error('Leave group failed', err);
                setError('Failed to leave group.');
                return { ok: false, msg: 'Failed to leave group.' };
            } finally {
                setLeaveBusy(null);
            }
        };

        const removeMember = async (group, member) => {
            if (!group?.id || !member?.uid) return { ok: false, msg: 'Missing member info.' };
            if (group.ownerUid !== uid) return { ok: false, msg: 'Only the owner can remove members.' };
            if (!db || !auth || !auth.currentUser) return { ok: false, msg: 'Firebase is not ready.' };
            try {
                await db.runTransaction(async (tx) => {
                    const ref = db.collection('groups').doc(group.id);
                    const snap = await tx.get(ref);
                    if (!snap.exists) throw new Error('Group not found');
                    const data = snap.data() || {};
                    const memberIds = (data.memberIds || []).filter(id => id !== member.uid);
                    const membersArr = (data.members || []).filter(m => m.uid !== member.uid);
                    tx.update(ref, { memberIds, members: membersArr });
                });
                setMessage(`${member.name || 'Member'} removed.`);
                return { ok: true, msg: `${member.name || 'Member'} removed.` };
            } catch (err) {
                console.error('Remove member failed', err);
                setError('Failed to remove member.');
                return { ok: false, msg: 'Failed to remove member.' };
            }
        };

        const acceptJoinRequest = async (group, request) => {
            if (!group?.id || !request?.id) return { ok: false, msg: 'Missing request info.' };
            if (group.ownerUid !== uid) return { ok: false, msg: 'Only the owner can accept requests.' };
            if (!db || !arrayUnion || !auth || !auth.currentUser) return { ok: false, msg: 'Firebase is not ready.' };
            try {
                const firebase = window.firebase;
                // Add user to group
                await db.collection('groups').doc(group.id).set({
                    memberIds: arrayUnion(request.uid),
                    members: arrayUnion({ uid: request.uid, name: request.name }),
                }, { merge: true });
                
                // Update request status
                await db.collection('groups').doc(group.id).collection('joinRequests').doc(request.id).update({
                    status: 'accepted',
                    respondedAt: firebase.firestore.FieldValue.serverTimestamp(),
                });
                
                return { ok: true, msg: `${request.name} added to group.` };
            } catch (err) {
                console.error('Accept request failed', err);
                return { ok: false, msg: 'Failed to accept request.' };
            }
        };

        const declineJoinRequest = async (group, request) => {
            if (!group?.id || !request?.id) return { ok: false, msg: 'Missing request info.' };
            if (group.ownerUid !== uid) return { ok: false, msg: 'Only the owner can decline requests.' };
            if (!db || !auth || !auth.currentUser) return { ok: false, msg: 'Firebase is not ready.' };
            try {
                const firebase = window.firebase;
                await db.collection('groups').doc(group.id).collection('joinRequests').doc(request.id).update({
                    status: 'declined',
                    respondedAt: firebase.firestore.FieldValue.serverTimestamp(),
                });
                return { ok: true, msg: 'Request declined.' };
            } catch (err) {
                console.error('Decline request failed', err);
                return { ok: false, msg: 'Failed to decline request.' };
            }
        };

        const ActionModal = () => (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4" onClick={() => setShowActions(false)}>
                <div className="absolute inset-0 bg-black/50 backdrop-blur-sm" />
                <div className="relative bg-white dark:bg-gray-900 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 w-full max-w-xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
                    <div className="flex items-center justify-between px-4 py-3 border-b border-gray-200 dark:border-gray-700">
                        <div className="flex items-center gap-2">
                            <button className={`px-3 py-1.5 rounded-lg text-sm font-semibold ${actionTab === 'create' ? 'bg-indigo-600 text-white' : 'bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-200'}`} onClick={() => setActionTab('create')}>Create</button>
                            <button className={`px-3 py-1.5 rounded-lg text-sm font-semibold ${actionTab === 'join' ? 'bg-emerald-600 text-white' : 'bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-200'}`} onClick={() => setActionTab('join')}>Join</button>
                        </div>
                        <button onClick={() => setShowActions(false)} className="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg">âœ•</button>
                    </div>

                    <div className="p-4 space-y-4">
                        {actionTab === 'create' && (
                            <div className="space-y-3">
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={createName}
                                        onChange={(e) => setCreateName(e.target.value)}
                                        ref={createNameInputRef}
                                        className="flex-1 px-3 py-2 text-sm rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        placeholder="Group name"
                                    />
                                    <button
                                        onClick={createGroup}
                                        disabled={loading}
                                        className="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold rounded-lg"
                                    >Create</button>
                                </div>
                                <label className="flex items-center gap-2 text-xs text-gray-600 dark:text-gray-300">
                                    <input
                                        type="checkbox"
                                        checked={createPublic}
                                        onChange={(e) => setCreatePublic(e.target.checked)}
                                        className="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                                    />
                                    Make group public (listed for others)
                                </label>
                                <p className="text-xs text-gray-500 dark:text-gray-400">Remaining creates: {Math.max(0, 2 - created.length)}</p>
                            </div>
                        )}

                        {actionTab === 'join' && (
                            <div className="space-y-3">
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={joinCode}
                                        onChange={(e) => setJoinCode(e.target.value)}
                                        className="flex-1 px-3 py-2 text-sm rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                        placeholder="Group code or name"
                                    />
                                    <button
                                        onClick={() => joinGroup()}
                                        className="px-3 py-2 bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold rounded-lg"
                                    >Join</button>
                                </div>
                                <p className="text-xs text-gray-500 dark:text-gray-400">Remaining joins: {Math.max(0, 2 - joined.length)}</p>
                                {lastCreatedCode && (
                                    <div className="text-xs text-indigo-100 bg-indigo-900/40 border border-indigo-700 rounded-lg p-2 flex items-center justify-between">
                                        <span className="font-semibold">Your latest code: {lastCreatedCode}</span>
                                        <button onClick={() => navigator?.clipboard?.writeText(lastCreatedCode)} className="text-[11px] px-2 py-1 rounded bg-indigo-600 hover:bg-indigo-700 text-white">Copy</button>
                                    </div>
                                )}
                            </div>
                        )}

                        <div className="border-t border-gray-200 dark:border-gray-700 pt-3">
                            <p className="text-[11px] font-semibold text-gray-500 dark:text-gray-400 mb-1">Public groups</p>
                            {publicGroups.length === 0 ? (
                                <p className="text-xs text-gray-400">No public groups yet</p>
                            ) : (
                                <div className="space-y-1 max-h-40 overflow-y-auto pr-1">
                                    {publicGroups.map(g => (
                                        <div key={g.id} className="flex items-center justify-between text-sm text-gray-900 dark:text-gray-100 bg-gray-50 dark:bg-gray-800 rounded-lg px-2 py-1 border border-gray-200 dark:border-gray-700">
                                            <div>
                                                <p className="font-semibold">{g.name}</p>
                                                <p className="text-[11px] text-gray-500">Code: {g.id}</p>
                                            </div>
                                            <button
                                                onClick={() => { setJoinCode(g.id); setActionTab('join'); joinGroup(g.id); }}
                                                disabled={joined.length >= 2}
                                                className="text-xs px-2 py-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded"
                                            >Join</button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            </div>
        );

        return (
            <div className="glass-card backdrop-blur rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 card-hover animate-in relative">
                <div className="flex items-center justify-between mb-3 flex-wrap gap-2">
                    <h3 className="font-semibold text-gray-800 dark:text-gray-100 text-sm">Groups</h3>
                    <div className="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
                        <span>Create max 2 â€¢ Join max 2</span>
                        <button onClick={() => { setShowActions(true); setActionTab('create'); }} className="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-xs font-semibold">Create group</button>
                        <button onClick={() => { setShowActions(true); setActionTab('join'); }} className="px-3 py-1.5 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-xs font-semibold">Join group</button>
                    </div>
                </div>

                <div className="space-y-3">
                    {message && <div className="text-xs text-emerald-600 bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 rounded-lg p-2">{message}</div>}
                    {error && <div className="text-xs text-rose-600 bg-rose-50 dark:bg-rose-900/20 border border-rose-200 dark:border-rose-800 rounded-lg p-2">{error}</div>}

                    <div className="border border-gray-200 dark:border-gray-700 rounded-lg p-3">
                        <p className="text-xs font-semibold text-gray-500 dark:text-gray-400 mb-2">Your Groups</p>
                        {created.length === 0 && joined.length === 0 ? (
                            <p className="text-xs text-gray-400">None yet. Use the menu to create or join.</p>
                        ) : (
                            <div className="space-y-2">
                                {[...created, ...joined].map((g, idx) => {
                                    const gid = g.id || g.code || g.name || `legacy-${idx}`;
                                    const roster = members[gid] || [];
                                    const isOwner = g.ownerUid === uid;
                                    return (
                                        <div
                                            key={`${gid}-${idx}`}
                                            role="button"
                                            tabIndex={0}
                                            onClick={() => setSelectedGroup(g)}
                                            onKeyDown={(e) => { if (e.key === 'Enter') setSelectedGroup(g); }}
                                            className="w-full text-left border border-gray-200 dark:border-gray-700 rounded-lg p-3 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 hover:border-indigo-300 dark:hover:border-indigo-700 transition focus:outline-none"
                                        >
                                            <div className="flex items-center justify-between mb-1">
                                                <p className="text-sm font-semibold text-gray-900 dark:text-gray-100">{g.name || g.code}</p>
                                                <div className="flex items-center gap-2">
                                                    <span className="text-[11px] text-gray-500">{g.isPublic ? 'Public' : 'Private'}</span>
                                                    {!isOwner && (
                                                        <button
                                                            onClick={(e) => { e.stopPropagation(); leaveGroup(g); }}
                                                            disabled={leaveBusy === g.id}
                                                            className="text-[11px] px-2 py-1 rounded bg-rose-600 hover:bg-rose-700 text-white disabled:opacity-60"
                                                        >
                                                            {leaveBusy === g.id ? 'Leaving...' : 'Leave'}
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                            <p className="text-[11px] text-gray-500 mb-2">Members: {roster.length}</p>
                                            <div className="flex flex-wrap gap-1">
                                                {roster.length === 0 ? (
                                                    <span className="text-[11px] text-gray-400">(none yet)</span>
                                                ) : roster.slice(0, 3).map(m => (
                                                    <span key={`${gid}-${m.uid || m.name}`} className="text-[11px] px-2 py-0.5 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-100">
                                                        {m.name || 'Student'}
                                                    </span>
                                                ))}
                                                {roster.length > 3 && <span className="text-[11px] px-2 py-0.5 text-gray-500">+{roster.length - 3} more</span>}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                </div>

                {selectedGroup && (
                    <GroupDetailModal 
                        group={selectedGroup} 
                        members={members[selectedGroup.id] || []} 
                        studyStats={studyStats}
                        onLeave={leaveGroup}
                        onRemoveMember={removeMember}
                        joinRequests={joinRequests[selectedGroup.id] || []}
                        onAcceptRequest={acceptJoinRequest}
                        onDeclineRequest={declineJoinRequest}
                        onClose={() => setSelectedGroup(null)} 
                    />
                )}

                {showActions && <ActionModal />}
            </div>
        );
    };

    // --- Reminder Modal Component ---
    const ReminderModal = ({ reminder, onDone, onNotDone, onClose }) => {
        const audioContextRef = React.useRef(null);
        const oscillatorsRef = React.useRef([]);
        
        React.useEffect(() => {
            if (reminder && reminder.task) {
                try {
                    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    audioContextRef.current = audioCtx;
                    oscillatorsRef.current = [];
                    
                    // Play continuous beeps every 400ms
                    const beepInterval = setInterval(() => {
                        if (audioCtx.state === 'running') {
                            const osc = audioCtx.createOscillator();
                            const gain = audioCtx.createGain();
                            osc.connect(gain);
                            gain.connect(audioCtx.destination);
                            osc.frequency.value = 800;
                            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                            gain.gain.setValueAtTime(0, audioCtx.currentTime + 0.2);
                            osc.start();
                            osc.stop(audioCtx.currentTime + 0.2);
                            oscillatorsRef.current.push(osc);
                        }
                    }, 400);
                    
                    return () => {
                        clearInterval(beepInterval);
                        oscillatorsRef.current.forEach(osc => {
                            try { osc.stop(); } catch (e) {}
                        });
                    };
                } catch (e) {}
            }
        }, [reminder]);

        if (!reminder || !reminder.task) return null;

        const modalContent = (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[999] p-4" onClick={onClose}>
                <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full p-6" onClick={(e) => e.stopPropagation()}>
                    <h2 className="text-xl font-bold text-gray-900 dark:text-white mb-2">Task Reminder ðŸ””</h2>
                    <p className="text-gray-600 dark:text-gray-300 mb-1 font-semibold">{reminder.task.text}</p>
                    {reminder.task.time && <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">Scheduled for {reminder.task.time}</p>}
                    <p className="text-sm text-gray-600 dark:text-gray-300 mb-6">Have you completed this task?</p>
                    <div className="flex gap-3">
                        <button onClick={() => { onDone(reminder.task); onClose(); }} className="flex-1 px-4 py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-lg transition">
                            âœ“ Done
                        </button>
                        <button onClick={() => { onNotDone(reminder.task); onClose(); }} className="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition">
                            âœ— Not Done
                        </button>
                    </div>
                </div>
            </div>
        );

        return ReactDOM.createPortal(modalContent, document.body);
    };

    // --- Main App ---
    function App() {
        const [todos, setTodos] = useState(() => {
            const saved = localStorage.getItem('exammode_todos');
            console.log('ðŸ“¦ Loading todos from localStorage:', saved);
            return saved ? JSON.parse(saved) : {};
        });
        const [selectedDate, setSelectedDate] = useState(new Date());
        const [inputValue, setInputValue] = useState('');
        const [inputTime, setInputTime] = useState('09:00');
        const [leaderboardRefreshKey, setLeaderboardRefreshKey] = useState(0);
        const [activeTab, setActiveTab] = useState('dashboard');
        const [immersive, setImmersive] = useState(false);
        const [showCelebration, setShowCelebration] = useState(false);
        const [celebrationStreakCount, setCelebrationStreakCount] = useState(0);
        const [reminder, setReminder] = useState(null);
        const reminderCheckRef = React.useRef(null);

        const [userProfile, setUserProfile] = useState(() => {
            const raw = localStorage.getItem('exammode_user');
            try { return raw ? JSON.parse(raw) : null; } catch (e) { return null; }
        });
        const profileName = userProfile?.username || userProfile?.displayName || 'You';
        const profileBranch = userProfile?.branch || 'Branch not set';

        // Sync user data from Firestore on mount
        useEffect(() => {
            const syncUserFromDatabase = async () => {
                const localUser = localStorage.getItem('exammode_user');
                if (!localUser) return;
                
                try {
                    const userData = JSON.parse(localUser);
                    if (!userData.uid) return;

                    if (!db) return;

                    const userDoc = await db.collection('users').doc(userData.uid).get();
                    
                    if (userDoc.exists) {
                        const dbData = userDoc.data();
                        const syncedUser = {
                            ...userData,
                            username: dbData.username || userData.username,
                            branch: dbData.branch || userData.branch,
                        };
                        
                        // Update localStorage and state with database data
                        localStorage.setItem('exammode_user', JSON.stringify(syncedUser));
                        setUserProfile(syncedUser);
                    }
                } catch (e) {
                    console.error('Failed to sync user from database:', e);
                }
            };

            syncUserFromDatabase();
        }, []);

        const handleStreakAchieved = (count) => {
            setCelebrationStreakCount(count);
            setShowCelebration(true);
        };

        const saveTodos = (newTodos) => {
            setTodos(newTodos);
            localStorage.setItem('exammode_todos', JSON.stringify(newTodos));
        };

        const getTodayKey = () => {
            const today = new Date();
            return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        };
        
        const getDateKey = (date) => {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        };
        
        const dateKey = getDateKey(selectedDate);
        const todayKey = getTodayKey();
        const todaysItems = todos[dateKey] || [];
        React.useEffect(() => {
            const checkReminders = () => {
                const now = new Date();
                const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                const todayKey = getTodayKey();
                const todayTodos = todos[todayKey] || [];
                
                if (!reminder) {
                    for (const todo of todayTodos) {
                        if (todo.time && todo.time === currentTime && !todo.completed && todo.status !== 'missed') {
                            setReminder({ task: todo, dateKey: todayKey });
                            break;
                        }
                    }
                } else {
                    console.log('Reminder already showing, skipping check');
                }
            };
            checkReminders();
            const intervalId = setInterval(checkReminders, 1000);
            return () => clearInterval(intervalId);
        }, [todos, reminder]);

        const addTodo = () => {
            if (!inputValue.trim()) return;
            const newTodos = { ...todos };
            newTodos[dateKey] = [...(newTodos[dateKey] || []), { 
                id: Date.now(), 
                text: inputValue, 
                time: inputTime, 
                completed: false,
                status: 'pending'
            }];
            saveTodos(newTodos);
            setInputValue('');
        };

        const toggleTodo = (id) => {
            const newTodos = { ...todos };
            newTodos[dateKey] = newTodos[dateKey].map(t => t.id === id ? { ...t, completed: !t.completed, status: !t.completed ? 'completed' : 'pending' } : t);
            saveTodos(newTodos);
        };

        const handleReminderDone = (task) => {
            const newTodos = { ...todos };
            const dateKey = reminder.dateKey;
            newTodos[dateKey] = newTodos[dateKey].map(t => t.id === task.id ? { ...t, completed: true, status: 'completed' } : t);
            saveTodos(newTodos);
        };

        const handleReminderNotDone = (task) => {
            const newTodos = { ...todos };
            const dateKey = reminder.dateKey;
            newTodos[dateKey] = newTodos[dateKey].map(t => t.id === task.id ? { ...t, status: 'missed' } : t);
            saveTodos(newTodos);
        };

        const deleteTodo = (id) => {
            const newTodos = { ...todos };
            newTodos[dateKey] = newTodos[dateKey].filter(t => t.id !== id);
            if (newTodos[dateKey].length === 0) delete newTodos[dateKey];
            saveTodos(newTodos);
        };

        return (
            <>
                {reminder && (
                    <ReminderModal 
                        reminder={reminder} 
                        onDone={handleReminderDone} 
                        onNotDone={handleReminderNotDone} 
                        onClose={() => setReminder(null)} 
                    />
                )}
            <div className="min-h-screen rainbow-bg">
                {/* Header */}
                <header className="app-header">
                    <div className="app-header-inner w-full flex items-center justify-between gap-4">
                        <div className="flex items-center gap-3">
                            <button onClick={() => window.location.href = '/'} className="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition" title="Back to Home">
                                <Icons.ArrowLeft className="w-5 h-5 text-gray-600 dark:text-gray-400" />
                            </button>
                            <div className="w-9 h-9 rounded-xl bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center shadow-lg">
                                <span className="text-white text-lg">ðŸ“Š</span>
                            </div>
                            <div>
                                <h1 className="text-lg font-bold tracking-tight text-gray-900 dark:text-white">Study Dashboard</h1>
                                <p className="text-xs text-gray-500 dark:text-gray-400 -mt-0.5">Track your progress</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-3">
                            <div className="hidden sm:block text-right">
                                <p className="text-sm font-semibold text-gray-900 dark:text-white">{profileName || 'Student'}</p>
                                <p className="text-xs text-gray-500 dark:text-gray-400">{profileBranch || 'Set your branch'}</p>
                            </div>
                            <button
                                onClick={() => window.darkModeToggle()}
                                className="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition"
                                title="Toggle dark/light mode"
                            >
                                <svg className="w-5 h-5 text-gray-600 dark:text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                                </svg>
                            </button>
                            <button
                                onClick={() => window.location.href = 'profile'}
                                className="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition"
                                title="Profile"
                            >
                                <Icons.User className="w-5 h-5 text-gray-600 dark:text-gray-300" />
                            </button>
                        </div>
                    </div>
                </header>

                {/* Main Content */}
                <div className="w-full px-6 py-8 lg:px-10 min-h-[calc(100vh-4rem)]">
                    <div className={`grid grid-cols-1 ${immersive ? 'lg:grid-cols-1' : activeTab === 'dashboard' ? 'lg:grid-cols-3' : 'lg:grid-cols-1'} gap-6 lg:gap-8 transition-all duration-300`}>
                        {/* Left Column - Tabs with Panels */}
                        <div className={`${immersive ? 'lg:col-span-1' : activeTab === 'dashboard' ? 'lg:col-span-2' : 'lg:col-span-1'} space-y-3`}>
                            <Tabs active={activeTab} onChange={(key)=>{ setActiveTab(key); if (key !== 'timer') setImmersive(false); }} />
                            {activeTab === 'dashboard' && (
                                <Dashboard />
                            )}
                            {activeTab === 'timer' && (
                                    <StudyTimer 
                                        onStudySaved={() => setLeaderboardRefreshKey(k => k + 1)} 
                                        onImmersiveChange={setImmersive}
                                        onStreakAchieved={handleStreakAchieved}
                                    />
                            )}
                            {activeTab === 'leaderboard' && (
                                <Leaderboard refreshKey={leaderboardRefreshKey} />
                            )}
                            {activeTab === 'groups' && (
                                <GroupsManager />
                            )}
                        </div>

                        {/* Right Column - Compact Calendar + Tasks */}
                        {!immersive && activeTab === 'dashboard' && (
                        <div className="lg:col-span-1 space-y-3 animate-in">
                            <CalendarWidget 
                                todos={todos}
                                selectedDate={selectedDate}
                                onDateClick={setSelectedDate}
                                compact
                            />
                            <div className="glass-card backdrop-blur rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-3 card-hover animate-in">
                                <p className="text-[11px] font-semibold text-gray-500 dark:text-gray-400 uppercase mb-2">Add Task</p>
                                <div className="space-y-2">
                                    <input 
                                        type="text"
                                        value={inputValue}
                                        onChange={(e) => setInputValue(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && addTodo()}
                                        placeholder="Task name..."
                                        className="w-full px-2.5 py-1.5 text-xs rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border-0 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    />
                                    <input 
                                        type="time"
                                        value={inputTime}
                                        onChange={(e) => setInputTime(e.target.value)}
                                        className="w-full px-2.5 py-1.5 text-xs rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border-0 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    />
                                    <button 
                                        onClick={addTodo}
                                        className="w-full px-2.5 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-semibold rounded-lg transition"
                                    >
                                        Add Task
                                    </button>
                                </div>
                            </div>
                            <div className="glass-card backdrop-blur rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-3 card-hover animate-in">
                                <p className="text-[11px] font-semibold text-gray-500 dark:text-gray-400 uppercase mb-2">Tasks for {selectedDate.toLocaleDateString()}</p>
                                <div className="space-y-1.5">
                                    {todaysItems.length === 0 ? (
                                        <p className="text-[11px] text-gray-400 text-center py-3">No tasks yet</p>
                                    ) : (
                                        todaysItems.map(todo => (
                                            <div key={todo.id} className="flex items-start gap-2 p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700/50 group">
                                                <input 
                                                    type="checkbox"
                                                    checked={todo.completed}
                                                    onChange={() => toggleTodo(todo.id)}
                                                    className="mt-0.5 w-4 h-4 rounded text-indigo-600 cursor-pointer"
                                                />
                                                    <div className="flex-1 min-w-0">
                                                    <p className={`text-xs font-medium ${
                                                        todo.status === 'missed' ? 'line-through text-red-500 dark:text-red-400 font-semibold' :
                                                        todo.completed ? 'line-through text-green-500 dark:text-green-400 font-semibold' : 'text-gray-900 dark:text-gray-100'
                                                    }`}>
                                                        {todo.text}
                                                    </p>
                                                    <p className="text-[11px] text-gray-500 dark:text-gray-400">{todo.time}</p>
                                                </div>
                                                <button 
                                                    onClick={() => deleteTodo(todo.id)}
                                                    className="opacity-0 group-hover:opacity-100 p-1 hover:bg-red-100 dark:hover:bg-red-900/30 rounded transition"
                                                >
                                                    <svg className="w-3.5 h-3.5 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        </div>
                        )}
                    </div>
                </div>
                
                    {/* Celebration Modal */}
                    <CelebrationModal 
                        isOpen={showCelebration} 
                        streakCount={celebrationStreakCount}
                        onClose={() => setShowCelebration(false)}
                    />
            </div>
            </>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>

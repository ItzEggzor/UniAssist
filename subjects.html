<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>UniAssist - AI Prep</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Marked.js for markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- KaTeX for math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" integrity="sha384-2KgKOuD1FYbIQdV8ZkJq0zcKXyVFzEGeYf6y+NTEsWsv97nKJ9PeVtLWFFK0y+zq" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" integrity="sha384-9l3YFKSf2zb6pYHHZ74iRNRGLNh+k0T1PDdt31IWAmkI4DS2CLn5F5FWLrNx7B6i" crossorigin="anonymous"></script>
    <script>
        // Setup markdown + math rendering
        window.setupMarkdownAndMath = function() {
            if (window.marked) {
                // Configure marked for better output
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                });
            }
        };
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupMarkdownAndMath);
        } else {
            setupMarkdownAndMath();
        }
    </script>

    <style>
        html, body { 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden;
            max-width: 100vw;
        }
        * { box-sizing: border-box; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar for Chat */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* Subtle card hover polish */
        .card-hover { transition: transform 220ms ease, box-shadow 220ms ease, border-color 220ms ease; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); }
        .dark .card-hover:hover { box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); }
        
        /* Floating animation for icons */
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-6px); } }
        .float-icon { animation: float 3s ease-in-out infinite; }
        
        /* Pulse glow effect */
        @keyframes pulseGlow { 0%, 100% { box-shadow: 0 0 5px rgba(99, 102, 241, 0.4); } 50% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.6); } }
        .pulse-glow { animation: pulseGlow 2s ease-in-out infinite; }
        
        /* Gradient text */
        .gradient-text { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #d946ef 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        
        /* Helper for rounded tab pills */
        .tab-pill { border-radius: 12px; }

        /* Rainbow animated background */
        @keyframes rainbowSpin { to { transform: rotate(360deg); } }
        .rainbow-bg {
            position: fixed; inset: 0;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            overflow-x: hidden;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            max-width: 100vw;
        }
        .rainbow-bg::before {
            content: '';
            position: absolute; inset: -25%;
            background: conic-gradient(
                from 0deg at 50% 50%,
                rgba(255, 99, 132, 0.5),
                rgba(255, 159, 67, 0.5),
                rgba(255, 220, 77, 0.5),
                rgba(72, 187, 120, 0.5),
                rgba(59, 130, 246, 0.5),
                rgba(139, 92, 246, 0.5),
                rgba(236, 72, 153, 0.5),
                rgba(255, 99, 132, 0.5)
            );
            filter: blur(80px) saturate(120%);
            animation: rainbowSpin 40s linear infinite;
            pointer-events: none;
            opacity: 0.25;
        }
        .dark .rainbow-bg {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
        }
        .dark .rainbow-bg::before {
            opacity: 0.35;
            filter: blur(90px) saturate(130%);
        }

        /* Glassmorphic cards */
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .dark .glass-card {
            background: rgba(30, 41, 59, 0.75);
            border: 1px solid rgba(71, 85, 105, 0.4);
        }

        /* Header styling: frosted glass with accent bar */
        .app-header {
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(14px);
            background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.9));
            border-bottom: 1px solid rgba(148, 163, 184, 0.35);
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
        }
        .dark .app-header {
            background: linear-gradient(180deg, rgba(26, 32, 44, 0.92), rgba(17, 24, 39, 0.9));
            border-bottom-color: rgba(59, 130, 246, 0.28);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.35);
        }
        .app-header::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 2px;
            background: linear-gradient(90deg, rgba(99,102,241,0.55), rgba(56,189,248,0.55), rgba(16,185,129,0.55));
            opacity: 0.9;
        }
        
        /* Prose styling for markdown content */
        .prose { color: #374151; line-height: 1.7; }
        .prose p { margin: 0.75rem 0; }
        .prose p:first-child { margin-top: 0; }
        .prose p:last-child { margin-bottom: 0; }
        .prose table { border-collapse: collapse; width: 100%; margin: 1rem 0; font-size: 0.9em; }
        .prose th, .prose td { border: 1px solid #e5e7eb; padding: 0.5rem 1rem; text-align: left; }
        .prose th { background: #f9fafb; font-weight: 600; color: #1f2937; }
        .prose h1 { font-size: 1.5rem; font-weight: 700; margin: 1.5rem 0 1rem; color: #111827; }
        .prose h2 { font-size: 1.25rem; font-weight: 600; margin: 1.25rem 0 0.75rem; color: #1f2937; }
        .prose h3 { font-size: 1.1rem; font-weight: 600; margin: 1rem 0 0.5rem; color: #374151; }
        .prose h4 { font-size: 1rem; font-weight: 600; margin: 0.75rem 0 0.5rem; color: #4b5563; }
        .prose h1:first-child, .prose h2:first-child, .prose h3:first-child, .prose h4:first-child { margin-top: 0; }
        .prose ul, .prose ol { margin: 0.75rem 0; padding-left: 1.75rem; }
        .prose ul { list-style-type: disc; }
        .prose ol { list-style-type: decimal; }
        .prose li { margin: 0.35rem 0; }
        .prose li > ul, .prose li > ol { margin: 0.25rem 0; }
        .prose li::marker { color: #6366f1; }
        .prose strong { font-weight: 700; color: #1f2937; }
        .prose em { font-style: italic; color: #4b5563; }
        .prose code { background: #f3f4f6; padding: 0.2rem 0.4rem; border-radius: 0.375rem; font-size: 0.875em; font-family: 'Fira Code', monospace; color: #be185d; }
        .prose pre { background: #1f2937; color: #f9fafb; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 1rem 0; }
        .prose pre code { background: transparent; color: inherit; padding: 0; }
        .prose blockquote { border-left: 4px solid #6366f1; padding-left: 1rem; margin: 1rem 0; color: #4b5563; font-style: italic; background: #f3f4f6; padding: 0.75rem 1rem; border-radius: 0 0.5rem 0.5rem 0; }
        .prose a { color: #4f46e5; text-decoration: underline; }
        .prose a:hover { color: #4338ca; }
        .prose hr { border-top: 1px solid #e5e7eb; margin: 1.5rem 0; }
        .prose img { max-width: 100%; border-radius: 0.5rem; margin: 1rem 0; }
        
        /* Dark mode prose */
        .dark .prose { color: #e5e7eb; }
        .dark .prose p { color: #d1d5db; }
        .dark .prose h1 { color: #f9fafb; }
        .dark .prose h2 { color: #f3f4f6; }
        .dark .prose h3 { color: #e5e7eb; }
        .dark .prose h4 { color: #d1d5db; }
        .dark .prose th { background: #374151; border-color: #4b5563; color: #f3f4f6; }
        .dark .prose td { border-color: #4b5563; color: #d1d5db; }
        .dark .prose strong { color: #f9fafb; }
        .dark .prose em { color: #9ca3af; }
        .dark .prose code { background: #374151; color: #f472b6; }
        .dark .prose pre { background: #111827; }
        .dark .prose blockquote { background: #1f2937; border-color: #818cf8; color: #9ca3af; }
        .dark .prose a { color: #818cf8; }
        .dark .prose a:hover { color: #a5b4fc; }
        .dark .prose hr { border-color: #4b5563; }
        .dark .prose li { color: #d1d5db; }
        .dark .prose li::marker { color: #818cf8; }
        
        /* KaTeX display math spacing */
        .katex-display { margin: 1rem 0; overflow-x: auto; }
        .katex { font-size: 1.1em; }
        .dark .katex { color: #e5e7eb; }
    </style>
</head>
<body class="bg-gradient-to-b from-indigo-50 to-white dark:from-gray-900 dark:to-gray-950 text-gray-900 dark:text-gray-100">
<script type="module" src="script.js"></script>
<script>
    
    // Dark Mode Toggle
    window.darkModeToggle = () => {
        document.documentElement.classList.toggle('dark');
        localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
    };
    
    // Initialize dark mode from localStorage
    if (localStorage.getItem('darkMode') === 'true') {
        document.documentElement.classList.add('dark');
    }
</script>

<button 
    onclick="darkModeToggle()"
    class="hidden"
    id="floating-theme-toggle"
    title="Toggle dark mode"
>
    <svg class="w-5 h-5 text-gray-800 dark:text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
    </svg>
</button>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Configuration ---
        // To use AI features, get a key from aistudio.google.com and paste it here
        const apiKey = "secret"; 

        // --- Icons (SVG Components) ---
        const Icon = ({ path, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            BookOpen: (props) => <Icon {...props} path={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>} />,
            Cpu: (props) => <Icon {...props} path={<><rect x="4" y="4" width="16" height="16" rx="2"/><rect x="9" y="9" width="6" height="6"/><path d="M9 1v3"/><path d="M15 1v3"/><path d="M9 20v3"/><path d="M15 20v3"/><path d="M20 9h3"/><path d="M20 14h3"/><path d="M1 9h3"/><path d="M1 14h3"/></>} />,
            Code: (props) => <Icon {...props} path={<><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></>} />,
            Zap: (props) => <Icon {...props} path={<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>} />,
            ChevronRight: (props) => <Icon {...props} path={<polyline points="9 18 15 12 9 6"/>} />,
            ArrowLeft: (props) => <Icon {...props} path={<><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></>} />,
            BarChart3: (props) => <Icon {...props} path={<><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></>} />,
            Mic: (props) => <Icon {...props} path={<><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></>} />,
            FileText: (props) => <Icon {...props} path={<><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></>} />,
            HelpCircle: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></>} />,
            TrendingUp: (props) => <Icon {...props} path={<><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></>} />,
            AlertCircle: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>} />,
            Sparkles: (props) => <Icon {...props} path={<><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 7h4"/><path d="M3 5h4"/></>} />,
            Bot: (props) => <Icon {...props} path={<><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></>} />,
            Send: (props) => <Icon {...props} path={<><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>} />,
            Loader2: (props) => <Icon {...props} className={`${props.className} animate-spin`} path={<path d="M21 12a9 9 0 1 1-6.219-8.56" />} />,
            X: (props) => <Icon {...props} path={<><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>} />,
            Heart: (props) => <Icon {...props} path={<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />} />,
            Dna: (props) => <Icon {...props} path={<><path d="M2 15c6.667-6 13.333 0 20-6"/><path d="M9 22c1.798-1.998 2.518-3.995 2.807-5.993"/><path d="M15 2c-1.798 1.998-2.518 3.995-2.807 5.993"/><path d="M17 12a5.002 5.002 0 0 0-.213-1.619"/><path d="M22 17c-1.025.922-2.148 1.637-3.328 2.115"/><path d="M22 7c-1.293-1.164-2.67-1.997-4.088-2.48"/><path d="M2 7c1.025-.922 2.148-1.637 3.328-2.115"/><path d="M7 22c1.293 1.164 2.67 1.997 4.088 2.48"/></>} />,
            Calculator: (props) => <Icon {...props} path={<><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="14"/><line x1="16" y1="18" x2="16" y2="18"/><line x1="12" y1="14" x2="12" y2="14"/><line x1="12" y1="18" x2="12" y2="18"/><line x1="8" y1="14" x2="8" y2="14"/><line x1="8" y1="18" x2="8" y2="18"/></>} />,
            Hammer: (props) => <Icon {...props} path={<><path d="m15 12-8.5 8.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0a2.12 2.12 0 0 1 0-3L12 9"/><path d="M17.64 15 22 10.64"/><path d="m20.91 11.7-1.25-1.25c-.6-.6-.93-1.4-.93-2.25V7.86c0-.55.45-1 1-1h.14c.55 0 1-.45 1-1V2a2 2 0 0 0-2-2H2a2 2 0 0 0-2 2v2.5c0 .55.45 1 1 1h.36c.55 0 1 .45 1 1v1.28c0 .55.45 1 1 1h3.35c.85 0 1.65.33 2.25.93l1.25 1.25"/></>} />,
            Microscope: (props) => <Icon {...props} path={<><path d="M6 18h8"/><path d="M3 22h18"/><path d="M14 22a7 7 0 1 0 0-14h-1"/><path d="M9 14h2"/><path d="M9 12a2 2 0 0 1 2-2V6h6v4a2 2 0 0 1 2 2Z"/><path d="M12 6V3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v3"/></>} />,
            Terminal: (props) => <Icon {...props} path={<><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></>} />,
            Activity: (props) => <Icon {...props} path={<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>} />,
            Calendar: (props) => <Icon {...props} path={<><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>} />,
            CheckSquare: (props) => <Icon {...props} path={<><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></>} />,
            Clock: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />,
            Link: (props) => <Icon {...props} path={<><path d="M10 13a5 5 0 0 0 7.07 0l3.54-3.54a5 5 0 0 0-7.07-7.07l-1.41 1.41"/><path d="M14 11a5 5 0 0 0-7.07 0L3.39 14.54a5 5 0 0 0 7.07 7.07l1.41-1.41"/></>} />,
            User: (props) => <Icon {...props} path={<><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />,
        };

        // --- Mock Data ---

        const THEORY_SUBJECTS = [
            {
                id: 'sub_stat_qm',
                title: 'Statistical & Quantum Mechanics',
                icon: <Icons.Activity className="w-6 h-6" />,
                totalPyqs: 28,
                color: 'text-purple-600',
                bg: 'bg-purple-50',
                // Grouped chapters for separate sections (new layout)
                groupedChapters: {
                    quantum: [
                        { id: 'qm_rad', title: 'Particle Nature of Radiation', pyqCount: 4, importance: 'High', prob: 90, description: 'Planck, photoelectric, Compton, pair production.' },
                        { id: 'qm_xray', title: 'X-Rays & Bragg’s Law', pyqCount: 2, importance: 'High', prob: 88, description: 'X-ray spectra (W, Mo), Bragg scattering/plane spacing.' },
                        { id: 'qm_wave', title: 'Wave Nature of Matter', pyqCount: 7, importance: 'High', prob: 90, description: 'Davisson–Germer, de Broglie, macroscopic waves.' },
                        { id: 'qm_packet', title: 'Wave Packets & Velocity', pyqCount: 2, importance: 'High', prob: 85, description: 'Phase vs group velocity; ripple/group velocity numericals.' },
                        { id: 'qm_uncertainty', title: 'Uncertainty Principle', pyqCount: 3, importance: 'Medium', prob: 70, description: 'Position-momentum estimates; KE in nucleus scale.' },
                        { id: 'qm_schrod', title: 'Schrödinger Equation & Applications', pyqCount: 6, importance: 'High', prob: 88, description: 'Acceptable wavefunctions, normalization, 1D box energies.' },
                    ],
                    statistical: [
                        { id: 'sm_dist', title: 'Statistical Distributions', pyqCount: 1, importance: 'High', prob: 80, description: 'MB, BE, FD distributions and limits.' },
                        { id: 'sm_fermi', title: 'Fermi Systems', pyqCount: 1, importance: 'Medium', prob: 65, description: 'Fermi energy at T=0K and T>0K.' },
                        { id: 'sm_kinetic', title: 'Kinetic Theory & Solids', pyqCount: 1, importance: 'Medium', prob: 60, description: 'RMS speeds, Dulong–Petit law and deviations.' },
                        { id: 'sm_quantum', title: 'Quantum Statistics', pyqCount: 1, importance: 'Low', prob: 50, description: 'Bosons vs distinguishable particles probability differences.' },
                    ],
                },
                // Flat list for other views
                chapters: [
                    { id: 'qm_rad', title: 'Particle Nature of Radiation', pyqCount: 4, importance: 'High', prob: 90, description: 'Planck, photoelectric, Compton, pair production.' },
                    { id: 'qm_xray', title: 'X-Rays & Bragg’s Law', pyqCount: 2, importance: 'High', prob: 88, description: 'X-ray spectra (W, Mo), Bragg scattering/plane spacing.' },
                    { id: 'qm_wave', title: 'Wave Nature of Matter', pyqCount: 7, importance: 'High', prob: 90, description: 'Davisson–Germer, de Broglie, macroscopic waves.' },
                    { id: 'qm_packet', title: 'Wave Packets & Velocity', pyqCount: 2, importance: 'High', prob: 85, description: 'Phase vs group velocity; ripple/group velocity numericals.' },
                    { id: 'qm_uncertainty', title: 'Uncertainty Principle', pyqCount: 3, importance: 'Medium', prob: 70, description: 'Position-momentum estimates; KE in nucleus scale.' },
                    { id: 'qm_schrod', title: 'Schrödinger Equation & Applications', pyqCount: 6, importance: 'High', prob: 88, description: 'Acceptable wavefunctions, normalization, 1D box energies.' },
                    { id: 'sm_dist', title: 'Statistical Distributions', pyqCount: 1, importance: 'High', prob: 80, description: 'MB, BE, FD distributions and limits.' },
                    { id: 'sm_fermi', title: 'Fermi Systems', pyqCount: 1, importance: 'Medium', prob: 65, description: 'Fermi energy at T=0K and T>0K.' },
                    { id: 'sm_kinetic', title: 'Kinetic Theory & Solids', pyqCount: 1, importance: 'Medium', prob: 60, description: 'RMS speeds, Dulong–Petit law and deviations.' },
                    { id: 'sm_quantum', title: 'Quantum Statistics', pyqCount: 1, importance: 'Low', prob: 50, description: 'Bosons vs distinguishable particles probability differences.' },
                ],
                viva: [
                { id: 'v1', question: 'What is the physical significance of the wave function?', answer: 'The square of the absolute magnitude of the wave function gives the probability density of finding a particle.' },
                { id: 'v2', question: 'Define a Hermitian Operator.', answer: 'An operator is Hermitian if it is equal to its self-adjoint. Its eigenvalues are always real.' }
                ]
            },
            {
                id: 'sub_values',
                title: 'Value Education And Ethics',
                icon: <Icons.Heart className="w-6 h-6" />,
                totalPyqs: 85,
                color: 'text-pink-600',
                bg: 'bg-pink-50',
                chapters: [
                { id: 'c1', title: 'Human Values', pyqCount: 40, importance: 'High', prob: 90, description: 'Self-exploration, Happiness, Prosperity.' },
                { id: 'c2', title: 'Professional Ethics', pyqCount: 30, importance: 'Medium', prob: 70, description: 'Ethical codes, Moral dilemmas in engineering.' },
                { id: 'c3', title: 'Harmony in Society', pyqCount: 15, importance: 'Low', prob: 40, description: 'Universal human order, Trust, Respect.' },
                ],
                viva: [
                { id: 'v1', question: 'What is the difference between "Sukh" and "Suvidha"?', answer: 'Sukh (Happiness) is a state of mind, while Suvidha (Physical Facility) is related to material comforts.' }
                ]
            },
            {
                id: 'sub_bio',
                title: 'Biology',
                icon: <Icons.Dna className="w-6 h-6" />,
                totalPyqs: 110,
                color: 'text-emerald-600',
                bg: 'bg-emerald-50',
                chapters: [
                { id: 'c1', title: 'Genetics', pyqCount: 50, importance: 'High', prob: 95, description: 'Mendel’s laws, DNA replication, Transcription.' },
                { id: 'c2', title: 'Cell Biology', pyqCount: 35, importance: 'Medium', prob: 65, description: 'Mitosis, Meiosis, Cell structure.' },
                { id: 'c3', title: 'Biomolecules', pyqCount: 25, importance: 'Low', prob: 45, description: 'Proteins, Carbohydrates, Enzymes.' },
                ],
                viva: [
                { id: 'v1', question: 'Difference between Mitosis and Meiosis?', answer: 'Mitosis results in two identical daughter cells, while Meiosis results in four sex cells.' }
                ]
            },
            {
                id: 'sub_bee',
                title: 'Basic Electronics Eng.',
                icon: <Icons.Cpu className="w-6 h-6" />,
                totalPyqs: 450,
                color: 'text-amber-600',
                bg: 'bg-amber-50',
                groupedChapters: {
                    'Digital Electronics': [
                        { id: 'c1', title: 'Base Conversions', pyqCount: 15, importance: 'High', prob: 85, description: 'Hex, Octal, Binary, Decimal conversions; unknown base problems.' },
                        { id: 'c2', title: 'Complements', pyqCount: 12, importance: 'High', prob: 85, description: "2's complement (Binary), 10's complement (Decimal) subtraction." },
                        { id: 'c3', title: 'Simplification', pyqCount: 18, importance: 'Medium', prob: 60, description: 'Boolean algebra laws, function complements.' },
                        { id: 'c4', title: 'K-Maps', pyqCount: 25, importance: 'Very High', prob: 95, description: "SOP/POS simplification, Don't Care conditions." },
                        { id: 'c5', title: 'Logic Gates', pyqCount: 14, importance: 'Medium', prob: 65, description: 'NAND/NOR gate implementations.' }
                    ],
                    'Analog Electronics - Diodes': [
                        { id: 'c6', title: 'PN Junction', pyqCount: 22, importance: 'High', prob: 82, description: 'Construction, V-I characteristics, forward/reverse bias.' },
                        { id: 'c7', title: 'Rectifiers', pyqCount: 28, importance: 'Very High', prob: 92, description: 'Bridge/Center-tapped rectifiers, PIV, waveforms.' },
                        { id: 'c8', title: 'Clippers/Clampers', pyqCount: 30, importance: 'Very High', prob: 95, description: 'Output waveforms for sinusoidal/square inputs.' },
                        { id: 'c9', title: 'Zener Diodes', pyqCount: 16, importance: 'Medium', prob: 68, description: 'Avalanche vs Zener breakdown, voltage models.' },
                        { id: 'c10', title: 'Diode Numericals', pyqCount: 20, importance: 'High', prob: 80, description: 'Current/voltage calculations for ideal/Si-diode circuits.' }
                    ],
                    'Analog Electronics - Transistors': [
                        { id: 'c11', title: 'BJT Theory', pyqCount: 35, importance: 'High', prob: 88, description: 'NPN/PNP construction, CE configuration I/O characteristics.' },
                        { id: 'c12', title: 'BJT Numericals', pyqCount: 42, importance: 'Very High', prob: 98, description: 'IB, IC, IE, α, β, VCE, Q-point, load-line analysis.' },
                        { id: 'c13', title: 'BJT Applications', pyqCount: 12, importance: 'Medium', prob: 55, description: 'Transistor as switch and amplifier.' },
                        { id: 'c14', title: 'MOSFET Theory', pyqCount: 32, importance: 'High', prob: 85, description: 'n-channel enhancement MOSFET, I-V characteristics, pinch-off.' },
                        { id: 'c15', title: 'MOSFET Numericals', pyqCount: 18, importance: 'High', prob: 82, description: 'Drain current ID, fabrication parameter kn calculations.' }
                    ],
                    'Analog Electronics - Op-Amps': [
                        { id: 'c16', title: 'Ideal Op-Amp', pyqCount: 15, importance: 'High', prob: 80, description: 'Characteristics, virtual ground/short concept.' },
                        { id: 'c17', title: 'Op-Amp Numericals', pyqCount: 38, importance: 'Very High', prob: 96, description: 'Vo for inverting, non-inverting, difference, cascaded amplifiers.' },
                        { id: 'c18', title: 'Complex Op-Amps', pyqCount: 20, importance: 'Medium', prob: 62, description: 'Logarithmic, anti-logarithmic amplifiers, multipliers.' },
                        { id: 'c19', title: 'CMRR', pyqCount: 8, importance: 'Low', prob: 35, description: 'Common Mode Rejection Ratio in dB for difference amplifiers.' }
                    ]
                },
                chapters: [
                    { id: 'c1', title: 'Base Conversions', pyqCount: 15, importance: 'High', prob: 85, description: 'Hex, Octal, Binary, Decimal conversions; unknown base problems.' },
                    { id: 'c2', title: 'Complements', pyqCount: 12, importance: 'High', prob: 85, description: "2's complement (Binary), 10's complement (Decimal) subtraction." },
                    { id: 'c3', title: 'Simplification', pyqCount: 18, importance: 'Medium', prob: 60, description: 'Boolean algebra laws, function complements.' },
                    { id: 'c4', title: 'K-Maps', pyqCount: 25, importance: 'Very High', prob: 95, description: "SOP/POS simplification, Don't Care conditions." },
                    { id: 'c5', title: 'Logic Gates', pyqCount: 14, importance: 'Medium', prob: 65, description: 'NAND/NOR gate implementations.' },
                    { id: 'c6', title: 'PN Junction', pyqCount: 22, importance: 'High', prob: 82, description: 'Construction, V-I characteristics, forward/reverse bias.' },
                    { id: 'c7', title: 'Rectifiers', pyqCount: 28, importance: 'Very High', prob: 92, description: 'Bridge/Center-tapped rectifiers, PIV, waveforms.' },
                    { id: 'c8', title: 'Clippers/Clampers', pyqCount: 30, importance: 'Very High', prob: 95, description: 'Output waveforms for sinusoidal/square inputs.' },
                    { id: 'c9', title: 'Zener Diodes', pyqCount: 16, importance: 'Medium', prob: 68, description: 'Avalanche vs Zener breakdown, voltage models.' },
                    { id: 'c10', title: 'Diode Numericals', pyqCount: 20, importance: 'High', prob: 80, description: 'Current/voltage calculations for ideal/Si-diode circuits.' },
                    { id: 'c11', title: 'BJT Theory', pyqCount: 35, importance: 'High', prob: 88, description: 'NPN/PNP construction, CE configuration I/O characteristics.' },
                    { id: 'c12', title: 'BJT Numericals', pyqCount: 42, importance: 'Very High', prob: 98, description: 'IB, IC, IE, α, β, VCE, Q-point, load-line analysis.' },
                    { id: 'c13', title: 'BJT Applications', pyqCount: 12, importance: 'Medium', prob: 55, description: 'Transistor as switch and amplifier.' },
                    { id: 'c14', title: 'MOSFET Theory', pyqCount: 32, importance: 'High', prob: 85, description: 'n-channel enhancement MOSFET, I-V characteristics, pinch-off.' },
                    { id: 'c15', title: 'MOSFET Numericals', pyqCount: 18, importance: 'High', prob: 82, description: 'Drain current ID, fabrication parameter kn calculations.' },
                    { id: 'c16', title: 'Ideal Op-Amp', pyqCount: 15, importance: 'High', prob: 80, description: 'Characteristics, virtual ground/short concept.' },
                    { id: 'c17', title: 'Op-Amp Numericals', pyqCount: 38, importance: 'Very High', prob: 96, description: 'Vo for inverting, non-inverting, difference, cascaded amplifiers.' },
                    { id: 'c18', title: 'Complex Op-Amps', pyqCount: 20, importance: 'Medium', prob: 62, description: 'Logarithmic, anti-logarithmic amplifiers, multipliers.' },
                    { id: 'c19', title: 'CMRR', pyqCount: 8, importance: 'Low', prob: 35, description: 'Common Mode Rejection Ratio in dB for difference amplifiers.' }
                ],
                viva: [
                    { id: 'v1', question: 'What is the knee voltage of a Silicon diode?', answer: 'Approximately 0.7 Volts.' },
                    { id: 'v2', question: 'Why is the BJT called a current-controlled device?', answer: 'Because the output current (Ic) is controlled by the input current (Ib).' },
                    { id: 'v3', question: 'What is a K-map?', answer: 'Karnaugh Map - a graphical method to simplify Boolean expressions by grouping minterms/maxterms.' },
                    { id: 'v4', question: 'Difference between MOSFET and BJT?', answer: 'MOSFET is voltage-controlled, BJT is current-controlled. MOSFET has higher input impedance.' },
                    { id: 'v5', question: 'What is virtual ground in op-amp?', answer: 'In ideal op-amp with negative feedback, both inputs are at same voltage (≈0V) but no current flows between them.' },
                    { id: 'v6', question: 'What is PIV in rectifiers?', answer: 'Peak Inverse Voltage - maximum reverse voltage across a diode when it is off.' }
                ]
            },
            {
                id: 'sub_math1',
                title: 'Mathematics 1',
                icon: <Icons.Calculator className="w-6 h-6" />,
                totalPyqs: 300,
                color: 'text-blue-600',
                bg: 'bg-blue-50',
                chapters: [
                { id: 'c1', title: 'Matrices', pyqCount: 100, importance: 'High', prob: 98, description: 'Rank, Eigenvalues, Cayley-Hamilton Theorem.' },
                { id: 'c2', title: 'Differential Calculus', pyqCount: 90, importance: 'High', prob: 95, description: 'Leibnitz theorem, Partial differentiation.' },
                { id: 'c3', title: 'Infinite Series', pyqCount: 50, importance: 'Medium', prob: 55, description: 'Convergence tests, Fourier series.' },
                ],
                viva: [
                { id: 'v1', question: 'State Cayley-Hamilton Theorem.', answer: 'Every square matrix satisfies its own characteristic equation.' }
                ]
            },
            {
                id: 'sub_c',
                title: 'C Language',
                icon: <Icons.Terminal className="w-6 h-6" />,
                totalPyqs: 180,
                color: 'text-slate-600',
                bg: 'bg-slate-50',
                chapters: [
                { id: 'c1', title: 'Pointers', pyqCount: 70, importance: 'High', prob: 92, description: 'Pointer arithmetic, Double pointers.' },
                { id: 'c2', title: 'Arrays & Strings', pyqCount: 50, importance: 'Medium', prob: 75, description: '1D/2D Arrays, String handling functions.' },
                { id: 'c3', title: 'Structures', pyqCount: 30, importance: 'Medium', prob: 60, description: 'Struct vs Union, Nested structures.' },
                ],
                viva: [
                { id: 'v1', question: 'Difference between Structure and Union?', answer: 'In Structure, each member gets separate memory. In Union, all members share the same memory space.' },
                { id: 'v2', question: 'What is a dangling pointer?', answer: 'A pointer that points to a memory location that has been deleted (or freed).' }
                ]
            },
        ];

        const LAB_SUBJECTS = [
            {
                id: 'lab_workshop',
                title: 'Workshop Practice',
                icon: <Icons.Hammer className="w-6 h-6" />,
                totalPyqs: 50,
                color: 'text-orange-600',
                bg: 'bg-orange-50',
                chapters: [
                { id: 'c1', title: 'Welding Shop', pyqCount: 20, importance: 'High', prob: 85, description: 'Arc welding, Gas welding safety.' },
                { id: 'c2', title: 'Fitting Shop', pyqCount: 15, importance: 'Medium', prob: 70, description: 'Files, Hacksaws, Measuring tools.' },
                { id: 'c3', title: 'Carpentry', pyqCount: 15, importance: 'Low', prob: 50, description: 'Joints, Wood types, Planing.' },
                ],
                viva: [
                { id: 'v1', question: 'What is the difference between Arc and Gas welding?', answer: 'Arc welding uses electricity to create heat, while Gas welding uses a flame from fuel gases.' },
                { id: 'v2', question: 'Name three types of carpentry joints.', answer: 'Mortise and Tenon, Dovetail, Lap joint.' }
                ]
            },
            {
                id: 'lab_physics',
                title: 'Physics Lab',
                icon: <Icons.Microscope className="w-6 h-6" />,
                totalPyqs: 60,
                color: 'text-indigo-600',
                bg: 'bg-indigo-50',
                chapters: [
                { id: 'c1', title: 'Newton\'s Rings', pyqCount: 25, importance: 'High', prob: 90, description: 'Interference, Wavelength calculation.' },
                { id: 'c2', title: 'Hall Effect', pyqCount: 20, importance: 'Medium', prob: 80, description: 'Semiconductors, Charge carriers.' },
                { id: 'c3', title: 'Optical Fibre', pyqCount: 15, importance: 'Low', prob: 60, description: 'Numerical Aperture, Acceptance angle.' },
                ],
                viva: [
                { id: 'v1', question: 'Why is the center of Newton’s rings dark?', answer: 'Due to the phase change of 180 degrees (Pi) upon reflection from the denser medium.' },
                { id: 'v2', question: 'What is Numerical Aperture?', answer: 'It is a dimensionless number that characterizes the range of angles over which the system can accept or emit light.' }
                ]
            },
        ];

        const MOCK_QUESTIONS = [
            { id: 'gen1', year: '2023', marks: '10', text: 'Find the eigenvalues and eigenvectors of the given matrix. Verify Cayley-Hamilton theorem.', tags: ['Core', 'Long Answer'] },
            { id: 'gen2', year: '2022', marks: '5', text: 'Explain the working of a Full Wave Rectifier with a circuit diagram.', tags: ['Concept'] },
            { id: 'gen3', year: '2021', marks: '10', text: 'Write a C program to implement bubble sort using pointers.', tags: ['Coding'] },
            { id: 'gen4', year: '2020', marks: '5', text: 'What is the difference between intrinsic and extrinsic semiconductors?', tags: ['Definition'] },
            { id: 'gen5', year: '2019', marks: '15', text: 'Derive the time-independent Schrodinger wave equation for a non-relativistic particle.', tags: ['Derivation'] },
        ];

        // Subject-specific PYQs (used when available)
        const SUBJECT_QUESTIONS = {
            sub_bee: [
                // Digital Electronics - Base Conversions
                { id: 'bee_d1', chapterId: 'c1', year: '2022-26', marks: '1-2', probability: 'High', text: 'Convert the hexadecimal number 2A9 to decimal, octal, and binary.', tags: ['Base Conversion', 'Numerical'] },
                { id: 'bee_d2', chapterId: 'c1', year: '2023-26', marks: '2', probability: 'High', text: 'Find the unknown base b if (34)b = (21)9.', tags: ['Unknown Base', 'Numerical'] },
                { id: 'bee_d3', chapterId: 'c1', year: '2024-26', marks: '1', probability: 'High', text: 'Convert (0.625)10 to binary up to 4 decimal places.', tags: ['Decimal to Binary', 'Fractional'] },

                // Digital Electronics - Complements
                { id: 'bee_d4', chapterId: 'c2', year: '2022-26', marks: '2', probability: 'High', text: "Subtract (101101)2 from (110010)2 using 2's complement method.", tags: ['2s Complement', 'Subtraction'] },
                { id: 'bee_d5', chapterId: 'c2', year: '2023-25', marks: '1', probability: 'High', text: "Perform (325)10 - (176)10 using 10's complement.", tags: ['10s Complement', 'Decimal'] },

                // Digital Electronics - Simplification
                { id: 'bee_d6', chapterId: 'c3', year: '2023-26', marks: '2', probability: 'Medium', text: "Simplify F = A'B + AB' + AB using Boolean algebra laws.", tags: ['Boolean Algebra', 'Simplification'] },
                { id: 'bee_d7', chapterId: 'c3', year: '2024-26', marks: '3', probability: 'Medium', text: "Find the complement of F(A,B,C) = AB + A'C + BC.", tags: ['Function Complement', 'Boolean'] },
                { id: 'bee_d8', chapterId: 'c3', year: '2025-26', marks: '2', probability: 'Medium', text: "Prove using Boolean algebra: A + A'B = A + B.", tags: ['Boolean Laws', 'Proof'] },

                // Digital Electronics - K-Maps
                { id: 'bee_d9', chapterId: 'c4', year: '2022-26', marks: '3', probability: 'Very High', text: 'Simplify F(A,B,C,D) = Σm(0,1,2,5,8,9,10) using K-map and write SOP form.', tags: ['K-Map', '4-Variable', 'SOP'] },
                { id: 'bee_d10', chapterId: 'c4', year: '2023-26', marks: '3', probability: 'Very High', text: 'Simplify using K-map: F(A,B,C,D) = ΠM(0,2,5,7,8,10,13,15) and write POS form.', tags: ['K-Map', 'POS'] },
                { id: 'bee_d11', chapterId: 'c4', year: '2024-26', marks: '2.5', probability: 'Very High', text: "Simplify F(A,B,C) = Σm(1,3,5,7) + d(2,6) where d represents don't care conditions.", tags: ['K-Map', "Don't Care"] },
                { id: 'bee_d12', chapterId: 'c4', year: '2025-26', marks: '1.5', probability: 'Very High', text: 'Draw K-map for 3 variables and identify all prime implicants for F = Σm(0,2,4,5,6).', tags: ['K-Map', 'Prime Implicants'] },

                // Digital Electronics - Logic Gates
                { id: 'bee_d13', chapterId: 'c5', year: '2022-24', marks: '2', probability: 'Medium', text: 'Implement F = AB + CD using only NAND gates.', tags: ['NAND Gates', 'Implementation'] },
                { id: 'bee_d14', chapterId: 'c5', year: '2023-24', marks: '3', probability: 'Medium', text: "Implement XOR gate (A ⊕ B) using only NOR gates.", tags: ['NOR Gates', 'XOR'] },
                { id: 'bee_d15', chapterId: 'c5', year: '2024-24', marks: '1', probability: 'Medium', text: 'Draw the NAND gate realization of F = (A+B)(C+D).', tags: ['NAND', 'Circuit'] },

                // Analog - PN Junction
                { id: 'bee_a1', chapterId: 'c6', year: '2022-25', marks: '3', probability: 'High', text: 'Explain the construction and working of a PN junction diode with energy band diagrams.', tags: ['PN Junction', 'Construction'] },
                { id: 'bee_a2', chapterId: 'c6', year: '2023-25', marks: '2', probability: 'High', text: 'Draw and explain V-I characteristics of PN junction in forward and reverse bias.', tags: ['V-I Characteristics', 'Diode'] },
                { id: 'bee_a3', chapterId: 'c6', year: '2024-25', marks: '3', probability: 'High', text: 'What is depletion region? Explain how it changes in forward and reverse bias.', tags: ['Depletion Region', 'Bias'] },

                // Analog - Rectifiers
                { id: 'bee_a4', chapterId: 'c7', year: '2022-26', marks: '3', probability: 'Very High', text: 'Explain the working of bridge rectifier with circuit diagram and output waveforms.', tags: ['Bridge Rectifier', 'Waveforms'] },
                { id: 'bee_a5', chapterId: 'c7', year: '2023-26', marks: '3', probability: 'Very High', text: 'Draw center-tapped full-wave rectifier and derive the PIV across each diode.', tags: ['Center-Tapped', 'PIV'] },
                { id: 'bee_a6', chapterId: 'c7', year: '2024-26', marks: '2', probability: 'Very High', text: 'Compare half-wave, full-wave center-tapped, and bridge rectifiers in terms of efficiency and PIV.', tags: ['Rectifier Comparison'] },
                { id: 'bee_a7', chapterId: 'c7', year: '2025-26', marks: '2', probability: 'Very High', text: 'For a bridge rectifier with Vm = 20V, find DC output voltage and PIV across diodes.', tags: ['Bridge Rectifier', 'Numerical'] },

                // Analog - Clippers/Clampers
                { id: 'bee_a8', chapterId: 'c8', year: '2022-26', marks: '3', probability: 'Very High', text: 'For a positive clipper circuit with bias voltage 5V, sketch output waveform for sinusoidal input (Vm = 10V).', tags: ['Positive Clipper', 'Waveform'] },
                { id: 'bee_a9', chapterId: 'c8', year: '2023-26', marks: '4', probability: 'Very High', text: 'Draw positive clamper circuit and sketch output for square wave input (±8V).', tags: ['Positive Clamper', 'Square Wave'] },
                { id: 'bee_a10', chapterId: 'c8', year: '2024-26', marks: '2', probability: 'Very High', text: 'Explain the difference between clipper and clamper circuits with examples.', tags: ['Clipper vs Clamper'] },
                { id: 'bee_a11', chapterId: 'c8', year: '2025-26', marks: '3', probability: 'Very High', text: 'For a biased negative clipper with Vref = -3V and sinusoidal input (10V peak), draw output waveform.', tags: ['Negative Clipper', 'Biased'] },

                // Analog - Zener Diodes
                { id: 'bee_a12', chapterId: 'c9', year: '2025-26', marks: '2', probability: 'Medium', text: 'Explain the differences between Avalanche and Zener breakdown mechanisms.', tags: ['Zener', 'Avalanche', 'Breakdown'] },
                { id: 'bee_a13', chapterId: 'c9', year: '2025-26', marks: '3', probability: 'Medium', text: 'A Zener diode (Vz = 6.8V) is used in voltage regulation. If supply is 12V and load current is 50mA, find series resistance.', tags: ['Zener', 'Voltage Regulation', 'Numerical'] },

                // Analog - Diode Numericals
                { id: 'bee_a14', chapterId: 'c10', year: '2022-26', marks: '2', probability: 'High', text: 'For the circuit with Si diode (Vγ = 0.7V), find current I and voltage across 2kΩ resistor if Vin = 5V.', tags: ['Diode Circuit', 'Numerical'] },
                { id: 'bee_a15', chapterId: 'c10', year: '2023-26', marks: '3', probability: 'High', text: 'Two diodes D1 and D2 (both Si) are connected in series with 10V supply and 1kΩ resistor. Find I and Vout.', tags: ['Series Diodes', 'Numerical'] },
                { id: 'bee_a16', chapterId: 'c10', year: '2024-26', marks: '2', probability: 'High', text: 'Determine if diode is ON or OFF for given circuit and calculate all voltages assuming ideal diode model.', tags: ['Diode Analysis', 'Ideal Model'] },

                // Transistors - BJT Theory
                { id: 'bee_t1', chapterId: 'c11', year: '2022-26', marks: '4', probability: 'High', text: 'Explain construction and working of NPN transistor with proper energy band diagrams.', tags: ['NPN', 'Construction'] },
                { id: 'bee_t2', chapterId: 'c11', year: '2023-26', marks: '3', probability: 'High', text: 'Draw input and output characteristics of BJT in CE configuration and mark active, saturation, and cutoff regions.', tags: ['CE Configuration', 'Characteristics'] },
                { id: 'bee_t3', chapterId: 'c11', year: '2024-26', marks: '4', probability: 'High', text: 'Compare NPN and PNP transistors in terms of construction, working, and current flow.', tags: ['NPN vs PNP'] },
                { id: 'bee_t4', chapterId: 'c11', year: '2025-26', marks: '3', probability: 'High', text: 'Explain Early effect in BJT with output characteristics and its impact on transistor performance.', tags: ['Early Effect', 'BJT'] },

                // Transistors - BJT Numericals
                { id: 'bee_t5', chapterId: 'c12', year: '2022-26', marks: '2', probability: 'Very High', text: 'For a BJT with β = 100, if IB = 50μA, find IC, IE, α, and VCE given VCC = 12V and RC = 2kΩ.', tags: ['BJT Numericals', 'DC Analysis'] },
                { id: 'bee_t6', chapterId: 'c12', year: '2023-26', marks: '3', probability: 'Very High', text: 'Draw DC load line for CE amplifier with VCC = 15V, RC = 1.5kΩ, and locate Q-point if IC = 5mA.', tags: ['Load Line', 'Q-point'] },
                { id: 'bee_t7', chapterId: 'c12', year: '2024-26', marks: '2', probability: 'Very High', text: 'If α = 0.98, find β. Also calculate IC if IE = 10mA.', tags: ['Alpha Beta', 'Current Relations'] },
                { id: 'bee_t8', chapterId: 'c12', year: '2025-26', marks: '3', probability: 'Very High', text: 'For voltage divider bias circuit, find VB, VE, IE, IC, VCE and verify if transistor is in active region.', tags: ['Voltage Divider Bias', 'Analysis'] },
                { id: 'bee_t9', chapterId: 'c12', year: '2022-26', marks: '1', probability: 'Very High', text: 'Derive relationship between α and β. Prove β = α/(1-α).', tags: ['Alpha Beta', 'Derivation'] },

                // Transistors - BJT Applications
                { id: 'bee_t10', chapterId: 'c13', year: '2024-25', marks: '3', probability: 'Medium', text: 'Explain how a transistor acts as a switch with circuit diagram. What are saturation and cutoff conditions?', tags: ['BJT Switch', 'Saturation'] },
                { id: 'bee_t11', chapterId: 'c13', year: '2025-25', marks: '3', probability: 'Medium', text: 'Explain transistor as an amplifier in CE configuration. Derive voltage gain expression.', tags: ['CE Amplifier', 'Gain'] },

                // Transistors - MOSFET Theory
                { id: 'bee_t12', chapterId: 'c14', year: '2022-26', marks: '4', probability: 'High', text: 'Explain construction, working, and I-V characteristics of n-channel enhancement MOSFET.', tags: ['MOSFET', 'n-channel', 'Enhancement'] },
                { id: 'bee_t13', chapterId: 'c14', year: '2023-26', marks: '3', probability: 'High', text: 'What is pinch-off in MOSFET? Explain with drain characteristics.', tags: ['Pinch-off', 'MOSFET'] },
                { id: 'bee_t14', chapterId: 'c14', year: '2024-26', marks: '5', probability: 'High', text: 'Compare enhancement and depletion mode MOSFETs in terms of construction and operation.', tags: ['Enhancement vs Depletion'] },
                { id: 'bee_t15', chapterId: 'c14', year: '2025-26', marks: '3', probability: 'High', text: 'Draw transfer characteristics (ID vs VGS) for n-channel enhancement MOSFET and mark threshold voltage.', tags: ['Transfer Characteristics'] },

                // Transistors - MOSFET Numericals
                { id: 'bee_t16', chapterId: 'c15', year: '2023-26', marks: '2', probability: 'High', text: 'For n-MOSFET with kn = 0.5 mA/V², VT = 2V, if VGS = 4V and VDS = 5V, calculate ID.', tags: ['MOSFET Numericals', 'Drain Current'] },
                { id: 'bee_t17', chapterId: 'c15', year: '2024-26', marks: '2', probability: 'High', text: 'Given VGS = 3V, VT = 1.5V, VDS = 6V, and ID = 4.5mA, find fabrication parameter kn.', tags: ['kn Parameter', 'MOSFET'] },
                { id: 'bee_t18', chapterId: 'c15', year: '2025-26', marks: '2', probability: 'High', text: 'Determine region of operation (cutoff/linear/saturation) for MOSFET with VGS = 5V, VT = 2V, VDS = 2V.', tags: ['Region of Operation'] },

                // Op-Amps - Ideal Op-Amp
                { id: 'bee_o1', chapterId: 'c16', year: '2022-26', marks: '2', probability: 'High', text: 'List characteristics of an ideal operational amplifier (input impedance, output impedance, gain, bandwidth).', tags: ['Ideal Op-Amp', 'Characteristics'] },
                { id: 'bee_o2', chapterId: 'c16', year: '2023-26', marks: '2', probability: 'High', text: 'Explain virtual ground and virtual short concepts in op-amp with negative feedback.', tags: ['Virtual Ground', 'Virtual Short'] },

                // Op-Amps - Numericals
                { id: 'bee_o3', chapterId: 'c17', year: '2022-26', marks: '2', probability: 'Very High', text: 'For inverting amplifier with Rf = 100kΩ, Rin = 10kΩ, and Vin = 0.5V, find Vo.', tags: ['Inverting Amplifier', 'Numerical'] },
                { id: 'bee_o4', chapterId: 'c17', year: '2023-26', marks: '3', probability: 'Very High', text: 'Design non-inverting amplifier with gain of 11. If R1 = 1kΩ, find Rf. Calculate Vo for Vin = 2V.', tags: ['Non-inverting', 'Design'] },
                { id: 'bee_o5', chapterId: 'c17', year: '2024-26', marks: '3', probability: 'Very High', text: 'For difference amplifier with R1 = R2 = 10kΩ, Rf = 100kΩ, V1 = 3V, V2 = 2V, find Vo.', tags: ['Difference Amplifier'] },
                { id: 'bee_o6', chapterId: 'c17', year: '2025-26', marks: '2', probability: 'Very High', text: 'Two op-amps are cascaded: first is inverting (gain -5), second is non-inverting (gain 3). Find overall gain and Vo for Vin = 0.4V.', tags: ['Cascaded Amplifiers'] },

                // Op-Amps - Complex
                { id: 'bee_o7', chapterId: 'c18', year: '2024-26', marks: '3', probability: 'Medium', text: 'Explain working of logarithmic amplifier with circuit diagram and output expression.', tags: ['Logarithmic Amplifier'] },
                { id: 'bee_o8', chapterId: 'c18', year: '2025-26', marks: '2', probability: 'Medium', text: 'Draw and explain anti-logarithmic (exponential) amplifier circuit.', tags: ['Anti-logarithmic'] },
                { id: 'bee_o9', chapterId: 'c18', year: '2024-26', marks: '3', probability: 'Medium', text: 'Design an analog multiplier using op-amps with log and antilog amplifiers.', tags: ['Multiplier', 'Analog'] },

                // Op-Amps - CMRR
                { id: 'bee_o10', chapterId: 'c19', year: '2023-24', marks: '4', probability: 'Low', text: 'For difference amplifier with Ad = 1000 and Ac = 0.5, calculate CMRR in dB.', tags: ['CMRR', 'Numerical'] },
                { id: 'bee_o11', chapterId: 'c19', year: '2024-24', marks: '4', probability: 'Low', text: 'Define Common Mode Rejection Ratio (CMRR). Why is high CMRR desirable in instrumentation amplifiers?', tags: ['CMRR', 'Definition'] },
            ],
            sub_stat_qm: [
                // Quantum Mechanics — High / Very High
                { id: 'qm_high_1', chapterId: 'qm_rad', year: '2023-24, 2024-25, 2025-26 (Mid)', marks: '1-2', probability: 'High', text: 'Planck’s Formula: Convert Planck’s radiation formula from frequency to wavelength or explain how it fixes the UV catastrophe.', tags: ['Planck', 'Concept/Numerical'] },
                { id: 'qm_high_2', chapterId: 'qm_rad', year: '2023-24 (End), 2025-26 (Mid)', marks: '2-3', probability: 'High', text: 'Compton Scattering Angle: Calculate the scattering angle for a photon that loses a specific % of energy (e.g., 10%).', tags: ['Compton', 'Numerical'] },
                { id: 'qm_high_3', chapterId: 'qm_rad', year: '2024-25, 2025-26 (Mid)', marks: '2', probability: 'Medium', text: 'Photoelectric Effect: Explain why classical physics fails to explain it or how stopping potential changes with frequency.', tags: ['Photoelectric', 'Concept/Numerical'] },
                { id: 'qm_high_4', chapterId: 'qm_rad', year: '2024-25, 2025-26 (Mid)', marks: '2', probability: 'Medium', text: 'Pair Production Proof: Prove that pair production cannot occur in empty space.', tags: ['Pair Production', 'Proof'] },

                { id: 'qm_high_5', chapterId: 'qm_xray', year: '2023-24, 2024-25, 2025-26 (Mid)', marks: '2', probability: 'High', text: 'X-ray Spectra Plot: Plot spectra for Tungsten/Molybdenum and identify non-classical features.', tags: ['X-ray', 'Plot'] },
                { id: 'qm_high_6', chapterId: 'qm_xray', year: '2023-24, 2024-25, 2025-26 (Mid)', marks: '1', probability: 'Medium', text: 'Bragg’s Law: Calculate distance between atomic planes (d) or the smallest scattering angle for X-rays.', tags: ['Bragg', 'Numerical'] },

                { id: 'qm_high_7', chapterId: 'qm_wave', year: '2023-24, 2024-25, 2025-26 (Mid)', marks: '2-3', probability: 'High', text: 'Davisson–Germer experiment plots and inferences; de Broglie wavelength vs Compton wavelength; qualitative explanation of macroscopic waves.', tags: ['Wave Nature', 'Concept/Plot'] },
                { id: 'qm_high_8', chapterId: 'qm_wave', year: '2024-25, 2025-26 (Mid)', marks: '2', probability: 'Medium', text: 'Macroscopic Waves: Can a human/macroscopic object be described as a wave? Explain qualitatively.', tags: ['Conceptual', 'Waves'] },
                { id: 'qm_high_9', chapterId: 'qm_wave', year: '2024-25, 2025-26 (Mid)', marks: '2', probability: 'Medium', text: 'De Broglie Speed: Find the speed of a particle if its de Broglie wavelength equals its Compton wavelength.', tags: ['De Broglie', 'Numerical'] },

                // Wave Nature of Matter (additional)
                { id: 'qm_wave_1', chapterId: 'qm_wave', year: '23-24, 24-25, 25-26', marks: '3', probability: 'Very High', text: 'Davisson–Germer Plot: Plot scattering angle distribution for different incident energies and state inferences.', tags: ['Wave Nature', 'Plot'] },
                { id: 'qm_wave_2', chapterId: 'qm_wave', year: '23-24, 24-25, 25-26', marks: '2', probability: 'Very High', text: 'Ripple Velocity Derivation: Given phase velocity v_p = sqrt(2πS/(λρ)), find the group velocity.', tags: ['Wave Nature', 'Numerical'] },
                { id: 'qm_wave_3', chapterId: 'qm_wave', year: '23-24, 24-25, 25-26', marks: '1', probability: 'High', text: 'Wave Packets: What is a wave packet? Why must a matter wave be a group of waves?', tags: ['Wave Nature', 'Concept'] },
                { id: 'qm_wave_4', chapterId: 'qm_wave', year: '24-25, 25-26', marks: '2', probability: 'High', text: 'Speed vs. Wavelength: Find particle speed if de Broglie wavelength equals Compton wavelength.', tags: ['Wave Nature', 'Numerical'] },

                { id: 'qm_high_10', chapterId: 'qm_packet', year: '2023-24, 2024-25, 2025-26 (Mid)', marks: '1-2', probability: 'High', text: 'Wave Packets & Velocity: Difference between phase and group velocity; numerical on group velocity of ripples v_g = 2πS/(λρ).', tags: ['Waves', 'Numerical'] },
                { id: 'qm_high_11', chapterId: 'qm_packet', year: '2023-24 (End/Mid), 2025-26 (Mid)', marks: '1', probability: 'Medium', text: 'Wave Packet Definition: Define "Wave Packet" and explain why matter waves must be groups of waves.', tags: ['Definition', 'Concept'] },

                { id: 'qm_high_12', chapterId: 'qm_uncertainty', year: '2023-24 (End)', marks: '1-3', probability: 'Medium', text: 'Uncertainty Principle: Position–momentum estimates; estimating minimum KE of an electron in a nucleus (R ≈ 10⁻¹⁵ m).', tags: ['Uncertainty', 'Numerical'] },

                // Uncertainty add-ons
                { id: 'qm_unc_2', chapterId: 'qm_uncertainty', year: '23-24', marks: '01+01', probability: 'Medium', text: "Uncertainty Principle (Theory): State Heisenberg's relation and why it is not observed in macroscopic objects.", tags: ['Uncertainty', 'Concept'] },
                { id: 'qm_unc_3', chapterId: 'qm_uncertainty', year: '23-24', marks: '03', probability: 'Medium', text: 'Uncertainty Numerical: Electron inside nucleus (R = 10⁻15 m). Estimate minimum kinetic energy.', tags: ['Uncertainty', 'Numerical'] },

                // Schrödinger Equation & Applications (6 questions)
                { id: 'qm_sch_1', chapterId: 'qm_schrod', year: '23-24', marks: '02', probability: 'Medium', text: 'Acceptable ψ: Identify if A sec(x), A tan(x), Ae^x, or A e^{-x^2} are acceptable and justify.', tags: ['Schrödinger', 'Acceptable ψ'] },
                { id: 'qm_sch_2', chapterId: 'qm_schrod', year: '23-24', marks: '02', probability: 'Medium', text: 'Normalization: Find normalization constant A for ψ = A x e^{-x^2/2}.', tags: ['Schrödinger', 'Normalization'] },
                { id: 'qm_sch_3', chapterId: 'qm_schrod', year: '23-24', marks: '02', probability: 'High', text: '1D Box (Smallest Energy): Lowest energy in infinite well is 5.6 eV. Find new energy if width is halved.', tags: ['1D Box', 'Energy'] },
                { id: 'qm_sch_4', chapterId: 'qm_schrod', year: '23-24, 24-25', marks: '01', probability: 'Medium', text: '1D Box (Find L): Find length L if zero-point energy is 10.00 eV.', tags: ['1D Box', 'Length'] },
                { id: 'qm_sch_5', chapterId: 'qm_schrod', year: '25-26', marks: '02', probability: 'Medium', text: '1D Box (Proton): Find dimension L if a proton in first excited state has 400 keV energy.', tags: ['1D Box', 'Proton'] },
                { id: 'qm_sch_6', chapterId: 'qm_schrod', year: '23-24', marks: '03', probability: 'Medium', text: 'Momentum Eigenvalues: Derive expression for momentum eigenvalues and functions for a 1D box.', tags: ['Momentum', 'Eigenvalues'] },

                // Statistical Mechanics
                { id: 'sm_high_1', chapterId: 'sm_dist', year: '2023-24 (End)', marks: '1-3', probability: 'High', text: 'Statistical Distributions: MB, BE, FD formulas; conditions under which BE/FD reduce to MB.', tags: ['MB', 'BE', 'FD'] },
                { id: 'sm_med_1', chapterId: 'sm_fermi', year: '2023-24 (End)', marks: '2', probability: 'Medium', text: 'Fermi Systems: Significance of Fermi energy at T = 0K and T > 0K.', tags: ['Fermi Energy', 'Concept'] },
                { id: 'sm_med_2', chapterId: 'sm_kinetic', year: '2023-24 (End)', marks: '2', probability: 'Medium', text: 'Kinetic Theory & Solids: RMS speed of gases; Dulong–Petit’s Law and its deviations.', tags: ['Kinetic Theory', 'Solid State'] },
                { id: 'sm_low_1', chapterId: 'sm_quantum', year: '2023-24 (End)', marks: '2', probability: 'Low', text: 'Quantum Statistics: Probability differences between indistinguishable Bosons and distinguishable particles.', tags: ['Quantum Stats', 'Bosons'] },
            ],
        };

        // Build a concise PYQ context for prompts so Gemini can ask/grade from real questions
        const buildPyqContext = (subject, limit = 12) => {
            const list = SUBJECT_QUESTIONS[subject?.id] || MOCK_QUESTIONS;
            const trimmed = list.slice(0, limit); // keep prompt small
            return trimmed.map(q => `- [${q.year}] ${q.text} (${q.marks} marks; ${q.probability || 'Prob N/A'})`).join('\n');
        };

        // Teacher-like system instruction for advanced viva interaction
        const TEACHER_SYSTEM_INSTRUCTION = `You are an empathetic but rigorous academic mentor preparing a student for exams. Your role:
1) Ask ONE question at a time from provided PYQ pool, gradually increasing difficulty.
2) Listen carefully to student answers. If they struggle, offer a hint rather than direct answer.
3) Give constructive feedback: identify strengths, areas needing work, and why their answer missed/succeeded.
4) Use Socratic method: ask follow-up questions that guide deeper understanding ("Why do you think...?", "Can you connect this to...?").
5) Provide a score (0-5) and explain it clearly.
6) Adapt: if student is strong, ask harder questions; if struggling, provide scaffolding and hints.
7) Be encouraging and specific. Avoid generic praise. Help them understand concepts, not just memorize.
8) Track their progress mentally and note weak areas to revisit.
`;

        // --- Text-to-Speech Helper ---
        let currentSpeechUtterance = null;
        let isSpeaking = false;

        const speakText = (text, onEnd = () => {}) => {
            if (isSpeaking) {
                window.speechSynthesis.cancel();
                isSpeaking = false;
                return;
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 1;
            utterance.pitch = 1.4;
            utterance.volume = 1;
            
            utterance.onstart = () => { isSpeaking = true; };
            utterance.onend = () => { isSpeaking = false; onEnd(); };
            utterance.onerror = () => { isSpeaking = false; };
            
            currentSpeechUtterance = utterance;
            window.speechSynthesis.speak(utterance);
        };

        const stopSpeaking = () => {
            window.speechSynthesis.cancel();
            isSpeaking = false;
        };

        // --- API Helper ---
        async function callGemini(prompt, systemInstruction = "") {
            if (!apiKey) {
                alert("Please add your API Key in the code to use AI features.");
                return "API Key missing. Open the HTML file in a text editor and add your key.";
            }
            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemInstruction }] },
                        }),
                    }
                );

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response generated.";
            } catch (error) {
                console.error("Gemini API Error:", error);
                return "Sorry, I encountered an error. Check console/API key.";
            }
        }

        // --- AI Text Helpers ---
        const cleanAiText = (text = "") => {
            return text.trim();
        };

        const AiText = ({ text, className = "" }) => {
            if (!text) return null;
            
            // Simple text cleaning - remove markdown symbols but keep the content readable
            let cleaned = text
                // Remove headers (# ## ### etc) but keep the text
                .replace(/^#{1,6}\s*/gm, '')
                // Convert **bold** to just the text
                .replace(/\*\*([^*]+)\*\*/g, '$1')
                // Convert *italic* to just the text
                .replace(/\*([^*]+)\*/g, '$1')
                // Convert __bold__ to just the text
                .replace(/__([^_]+)__/g, '$1')
                // Convert _italic_ to just the text
                .replace(/_([^_]+)_/g, '$1')
                // Remove inline code backticks
                .replace(/`([^`]+)`/g, '$1')
                // Remove code blocks
                .replace(/```[\s\S]*?```/g, '')
                // Clean up bullet points - keep them simple
                .replace(/^[\s]*[-*+]\s+/gm, '• ')
                // Clean up numbered lists
                .replace(/^[\s]*\d+\.\s+/gm, '• ')
                // Remove horizontal rules
                .replace(/^[-*_]{3,}$/gm, '')
                // Clean up extra whitespace
                .replace(/\n{3,}/g, '\n\n')
                .trim();
            
            // Split by newlines and render as paragraphs
            const paragraphs = cleaned.split(/\n\n+/);
            
            return (
                <div className={className}>
                    {paragraphs.map((para, idx) => {
                        // Check if it's a list (contains bullet points)
                        if (para.includes('• ')) {
                            const items = para.split('\n').filter(line => line.trim());
                            return (
                                <ul key={idx} className="list-disc list-inside space-y-1 my-2">
                                    {items.map((item, i) => (
                                        <li key={i} className="text-gray-700 dark:text-gray-300">
                                            {item.replace(/^•\s*/, '')}
                                        </li>
                                    ))}
                                </ul>
                            );
                        }
                        // Regular paragraph - handle line breaks within
                        const lines = para.split('\n');
                        return (
                            <p key={idx} className="mb-3 text-gray-700 dark:text-gray-300 last:mb-0">
                                {lines.map((line, i) => (
                                    <React.Fragment key={i}>
                                        {line}
                                        {i < lines.length - 1 && <br />}
                                    </React.Fragment>
                                ))}
                            </p>
                        );
                    })}
                </div>
            );
        };

        // --- Reusable UI Components ---

        const ImportanceBadge = ({ level }) => {
            const styles = {
                'Very High': 'bg-red-100 text-red-700 border-red-200 dark:bg-red-950 dark:text-red-300 dark:border-red-800',
                High: 'bg-orange-100 text-orange-700 border-orange-200 dark:bg-orange-950 dark:text-orange-300 dark:border-orange-800',
                Medium: 'bg-yellow-100 text-yellow-700 border-yellow-200 dark:bg-yellow-950 dark:text-yellow-300 dark:border-yellow-800',
                Low: 'bg-emerald-100 text-emerald-700 border-emerald-200 dark:bg-emerald-950 dark:text-emerald-300 dark:border-emerald-800',
            };
            return (
                <span className={`text-xs font-bold px-2 py-0.5 rounded border ${styles[level] || styles.Low}`}>
                    {level.toUpperCase()}
                </span>
            );
        };

        const ProgressBar = ({ percentage, colorClass }) => (
            <div className="w-full bg-gray-200 rounded-full h-2 mt-2">
                <div className={`h-2 rounded-full ${colorClass} transition-all`} style={{ width: `${percentage}%` }}></div>
            </div>
        );

        const SubjectCard = ({ subject, onClick }) => (
            <button
                onClick={onClick}
                className="group relative flex flex-col p-6 glass-card rounded-2xl shadow-sm hover:shadow-xl transition-all text-left h-full w-full card-hover overflow-hidden"
            >
                {/* Gradient border effect on hover */}
                <div className="absolute inset-0 rounded-2xl bg-gradient-to-br from-indigo-500/0 via-purple-500/0 to-pink-500/0 group-hover:from-indigo-500/20 group-hover:via-purple-500/20 group-hover:to-pink-500/20 transition-all duration-300 pointer-events-none" />
                
                <div className={`w-14 h-14 rounded-xl flex items-center justify-center mb-4 ${subject.bg} ${subject.color} group-hover:scale-110 transition-transform duration-300 shadow-lg`}>
                    {subject.icon}
                </div>
                <h3 className="text-lg font-bold text-gray-900 dark:text-white group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors">
                    {subject.title}
                </h3>
                <div className="mt-auto pt-3 flex items-center text-sm text-gray-500 dark:text-gray-400 gap-4">
                    <span className="flex items-center gap-1.5 bg-gray-100 dark:bg-gray-700/50 px-2.5 py-1 rounded-full">
                        <Icons.FileText className="w-3.5 h-3.5" /> {subject.totalPyqs} Qs
                    </span>
                    <span className="flex items-center gap-1.5 bg-gray-100 dark:bg-gray-700/50 px-2.5 py-1 rounded-full">
                        <Icons.TrendingUp className="w-3.5 h-3.5" /> {subject.chapters.length} Ch
                    </span>
                </div>
                <div className="absolute top-6 right-6 opacity-0 group-hover:opacity-100 transition-all transform group-hover:translate-x-1">
                    <Icons.ChevronRight className="w-5 h-5 text-indigo-500" />
                </div>
            </button>
        );

        // --- Views (Defined Outside App to Prevent Remounting/Focus Loss) ---

        // --- Bookmarks Modal ---
        const BookmarksModal = ({ open, onClose, bookmarks, onGo }) => {
            if (!open) return null;
            const list = Object.values(bookmarks || {});
            return (
                <div className="fixed inset-0 z-50 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="w-full max-w-lg bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-xl overflow-hidden">
                        <div className="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                            <h3 className="text-lg font-bold text-gray-900 dark:text-gray-100 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" className="w-5 h-5 text-yellow-600" fill="currentColor"><path d="M6 2h12a1 1 0 011 1v18l-7-4-7 4V3a1 1 0 011-1z"/></svg>
                                Bookmarked Questions
                            </h3>
                            <button onClick={onClose} className="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800"><Icons.X className="w-4 h-4" /></button>
                        </div>
                        <div className="p-4 max-h-[60vh] overflow-y-auto overflow-x-hidden space-y-2">
                            {list.length === 0 ? (
                                <div className="text-sm text-gray-500 dark:text-gray-400">No bookmarks yet. Use the bookmark icon on questions.</div>
                            ) : (
                                list.map((bm) => (
                                    <div key={bm.id} className="flex items-start justify-between gap-3 p-3 rounded-lg border border-gray-200 dark:border-gray-700">
                                        <div className="text-sm text-gray-800 dark:text-gray-200 min-w-0">
                                            <div className="font-semibold mb-1 break-words">{bm.text}</div>
                                            <div className="text-xs text-gray-500">Marks: {bm.marks}</div>
                                        </div>
                                        <button onClick={() => onGo(bm)} className="flex-shrink-0 px-3 py-1.5 rounded-lg bg-indigo-600 text-white text-xs font-semibold hover:bg-indigo-700">Go</button>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const SubjectsView = ({ onSelectSubject, onOpenBookmarks }) => (
            <div className="animate-in space-y-12">
                {/* Hero Section */}
                <div className="text-center mb-8">
                    <h1 className="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-3">
                        What do you want to <span className="gradient-text">study today?</span>
                    </h1>
                    <p className="text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">Choose a subject to access PYQs, AI-powered explanations, and viva practice</p>
                </div>
                
                <div>
                    <div className="flex items-center gap-3 mb-6">
                        <div className="p-2 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 text-white shadow-lg">
                            <Icons.BookOpen className="w-5 h-5" />
                        </div>
                        <h2 className="text-xl font-bold text-gray-900 dark:text-white">Theory Subjects</h2>
                        <div className="flex-1 h-px bg-gradient-to-r from-gray-200 dark:from-gray-700 to-transparent" />
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                        {THEORY_SUBJECTS.map((sub) => (
                            <SubjectCard key={sub.id} subject={sub} onClick={() => onSelectSubject(sub, 'PYQ')} />
                        ))}
                    </div>
                </div>
                <div>
                    <div className="flex items-center gap-3 mb-6">
                        <div className="p-2 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600 text-white shadow-lg">
                            <Icons.Microscope className="w-5 h-5" />
                        </div>
                        <h2 className="text-xl font-bold text-gray-900 dark:text-white">Lab & Viva Practicals</h2>
                        <div className="flex-1 h-px bg-gradient-to-r from-gray-200 dark:from-gray-700 to-transparent" />
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                        {LAB_SUBJECTS.map((sub) => (
                            <SubjectCard key={sub.id} subject={sub} onClick={() => onSelectSubject(sub, 'VIVA')} />
                        ))}
                    </div>
                </div>
                <div>
                    <div className="flex items-center gap-3 mb-6">
                        <div className="p-2 rounded-xl bg-gradient-to-br from-amber-500 to-orange-600 text-white shadow-lg">
                            <Icons.Zap className="w-5 h-5" />
                        </div>
                        <h2 className="text-xl font-bold text-gray-900 dark:text-white">Quick Tools</h2>
                        <div className="flex-1 h-px bg-gradient-to-r from-gray-200 dark:from-gray-700 to-transparent" />
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                        <button onClick={() => onOpenBookmarks?.()} className="group relative w-full text-left glass-card rounded-2xl p-5 shadow-sm hover:shadow-xl transition-all card-hover overflow-hidden">
                            <div className="absolute inset-0 rounded-2xl bg-gradient-to-br from-yellow-500/0 to-orange-500/0 group-hover:from-yellow-500/10 group-hover:to-orange-500/10 transition-all duration-300 pointer-events-none" />
                            <div className="flex items-center gap-4">
                                <div className="p-3 rounded-xl bg-gradient-to-br from-yellow-400 to-orange-500 text-white shadow-lg group-hover:scale-110 transition-transform">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" className="w-6 h-6" fill="currentColor"><path d="M6 2h12a1 1 0 011 1v18l-7-4-7 4V3a1 1 0 011-1z"/></svg>
                                </div>
                                <div>
                                    <h3 className="text-lg font-bold text-gray-900 dark:text-gray-100 group-hover:text-orange-600 dark:group-hover:text-orange-400 transition-colors">Bookmarked Questions</h3>
                                    <p className="text-sm text-gray-600 dark:text-gray-400">Quick access to saved questions</p>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        );

        const VivaModule = ({ 
            isAiVivaActive, 
            setIsAiVivaActive, 
            vivaChat, 
            vivaInput, 
            setVivaInput, 
            isVivaLoading, 
            handleVivaSubmit, 
            startAiViva, 
            chatEndRef, 
            selectedSubject 
        }) => {
            const [openCard, setOpenCard] = useState(null);
            const [speakingId, setSpeakingId] = useState(null);
            const [ttsEnabled, setTtsEnabled] = useState(true);

            // Auto speak whenever a new AI message appears
            useEffect(() => {
                const last = vivaChat[vivaChat.length - 1];
                if (!last) return;
                if (last.role === 'ai' && !last.loading && ttsEnabled && typeof speakText === 'function') {
                    speakText(last.text, () => setSpeakingId(null));
                }
            }, [vivaChat, ttsEnabled]);

            const handleSpeak = (text, id) => {
                if (speakingId === id) {
                    stopSpeaking();
                    setSpeakingId(null);
                } else {
                    speakText(text, () => setSpeakingId(null));
                    setSpeakingId(id);
                }
            };

            if (isAiVivaActive) {
                return (
                    <div className="bg-white border border-gray-200 rounded-xl shadow-sm h-[70vh] md:h-[75vh] flex flex-col overflow-hidden animate-in">
                        <div className="bg-indigo-600 p-4 text-white flex justify-between items-center shadow-md">
                            <div className="flex items-center gap-3">
                                <div className="bg-white/20 p-2 rounded-lg"><Icons.Bot className="w-5 h-5 text-white" /></div>
                                <div><h3 className="font-bold text-lg">AI Teacher</h3><p className="text-indigo-200 text-xs">Interactive Mentor</p></div>
                            </div>
                            <button onClick={() => { setIsAiVivaActive(false); stopSpeaking(); setSpeakingId(null); }} className="p-1.5 hover:bg-indigo-500 rounded-full"><Icons.X className="w-5 h-5" /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50/50">
                            {vivaChat.map((msg, idx) => (
                                <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-[85%] rounded-2xl p-4 shadow-sm ${msg.role === 'user' ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white text-gray-800 border border-gray-200 rounded-bl-none'}`}>
                                        {msg.loading ? (
                                            <Icons.Loader2 className="w-4 h-4 animate-spin" />
                                        ) : (
                                            <div className="flex gap-2 items-start">
                                                <div className="flex-1">
                                                    {msg.role === 'ai' ? (
                                                        <AiText text={msg.text} className="leading-relaxed text-sm" />
                                                    ) : (
                                                        <div className="leading-relaxed text-sm whitespace-pre-wrap">{msg.text}</div>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ))}
                            <div ref={chatEndRef} />
                        </div>
                        <form onSubmit={handleVivaSubmit} className="p-4 bg-white border-t border-gray-200 flex gap-2 items-center">
                            <input 
                                autoFocus
                                type="text" 
                                value={vivaInput} 
                                onChange={(e) => setVivaInput(e.target.value)} 
                                placeholder="Type answer..." 
                                disabled={isVivaLoading} 
                                className="flex-1 border border-gray-300 rounded-full px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                            />
                            <button type="submit" disabled={!vivaInput.trim() || isVivaLoading} className="bg-indigo-600 text-white p-3 rounded-full hover:bg-indigo-700 disabled:opacity-50">
                                {isVivaLoading ? <Icons.Loader2 className="w-5 h-5 animate-spin" /> : <Icons.Send className="w-5 h-5" />}
                            </button>
                            <button type="button" onClick={() => { const next = !ttsEnabled; setTtsEnabled(next); if (!next) stopSpeaking(); }} className={`ml-2 px-3 py-2 rounded-full text-sm font-medium border ${ttsEnabled ? 'bg-indigo-50 text-indigo-700 border-indigo-200' : 'bg-gray-100 text-gray-600 border-gray-300'}`}>Voice: {ttsEnabled ? 'On' : 'Off'}</button>
                        </form>
                    </div>
                );
            }
            return (
                <div className="space-y-6">
                    <div className="bg-indigo-50 border border-indigo-100 p-6 rounded-xl flex flex-col md:flex-row items-center justify-between gap-4">
                        <div className="flex items-start gap-3">
                            <div className="bg-white p-2 rounded-lg shadow-sm"><Icons.AlertCircle className="w-6 h-6 text-indigo-600" /></div>
                            <div><h4 className="font-bold text-indigo-900 text-lg">Interactive Viva Prep</h4><p className="text-sm text-indigo-700 mt-1">Talk with the AI teacher to practice questions, get hints, feedback and adaptive follow-ups—like a real viva.</p></div>
                        </div>
                        {/* No start button; viva chat starts automatically when tab is opened */}
                    </div>
                </div>
            );
        };

        const ChaptersView = ({ 
            selectedSubject, 
            handleSelectChapter, 
            mode, 
            setMode, 
            setIsAiVivaActive, 
            // Props for VivaModule
            isAiVivaActive, 
            vivaChat, vivaInput, setVivaInput, isVivaLoading, handleVivaSubmit, startAiViva, chatEndRef
        }) => {
            const chaptersSource = selectedSubject.groupedChapters
                ? Object.values(selectedSubject.groupedChapters).flat()
                : selectedSubject.chapters;
            const sortedChapters = [...chaptersSource].sort((a, b) => b.prob - a.prob);
            
            // Auto-start Viva when the tab is selected
            useEffect(() => {
                if (mode === 'VIVA' && !isAiVivaActive) {
                    setIsAiVivaActive(true);
                    startAiViva();
                }
            }, [mode]);
            
            const handleSelectChapterForMode = (chapter) => {
                if (mode === 'PRACTICE') {
                    handleSelectChapter({ ...chapter, isPractice: true });
                } else {
                    handleSelectChapter(chapter);
                }
            };
            
            return (
                <div className="animate-in">
                    {/* References Section */}
                    <div className="mb-6">
                        <div className="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-4">
                            <h3 className="text-sm font-bold text-gray-900 dark:text-gray-100 mb-2 flex items-center gap-2">
                                <Icons.Link className="w-4 h-4 text-indigo-600" /> References
                            </h3>
                            {Array.isArray(selectedSubject?.references) && selectedSubject.references.length > 0 ? (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                    {selectedSubject.references.map((ref, idx) => (
                                        <a key={idx} href={ref.url} target="_blank" rel="noreferrer" className="text-xs px-3 py-2 rounded-lg bg-indigo-50 text-indigo-700 dark:bg-indigo-900/40 dark:text-indigo-300 border border-indigo-100 dark:border-indigo-800 hover:underline">{ref.title}</a>
                                    ))}
                                </div>
                            ) : (
                                <p className="text-xs text-gray-600 dark:text-gray-300">No references added yet. We’ll attach Google Drive docs and YouTube playlists here.</p>
                            )}
                        </div>
                    </div>
                    <div className="bg-gray-100 dark:bg-gray-800 p-1 rounded-lg inline-flex mb-6 w-full md:w-auto overflow-x-auto">
                        <button onClick={() => { setMode('PYQ'); setIsAiVivaActive(false); }} className={`flex-1 md:flex-none px-4 md:px-6 py-2 rounded-md text-xs md:text-sm font-medium transition-all flex items-center justify-center gap-1 md:gap-2 whitespace-nowrap ${mode === 'PYQ' ? 'bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'}`}>
                            <Icons.FileText className="w-4 h-4" /> <span className="hidden sm:inline">Exam</span> PYQs
                        </button>
                        <button onClick={() => setMode('PRACTICE')} className={`flex-1 md:flex-none px-4 md:px-6 py-2 rounded-md text-xs md:text-sm font-medium transition-all flex items-center justify-center gap-1 md:gap-2 whitespace-nowrap ${mode === 'PRACTICE' ? 'bg-white dark:bg-gray-700 text-green-900 dark:text-green-300 shadow-sm' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'}`}>
                            <Icons.Zap className="w-4 h-4" /> Practice<span className="hidden sm:inline"> Qs</span>
                        </button>
                        <button onClick={() => { setMode('VIVA'); setIsAiVivaActive(true); startAiViva(); }} className={`flex-1 md:flex-none px-4 md:px-6 py-2 rounded-md text-xs md:text-sm font-medium transition-all flex items-center justify-center gap-1 md:gap-2 whitespace-nowrap ${mode === 'VIVA' ? 'bg-white dark:bg-gray-700 text-indigo-900 dark:text-indigo-300 shadow-sm' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'}`}>
                            <Icons.Mic className="w-4 h-4" /> Viva Voice
                        </button>
                    </div>
                    {mode === 'PRACTICE' && (
                        <div className="mb-6 bg-green-50 border border-green-200 p-3 sm:p-4 rounded-xl flex items-start gap-2 sm:gap-3">
                            <div className="bg-white p-2 rounded-lg shadow-sm flex-shrink-0"><Icons.Zap className="w-4 sm:w-5 h-4 sm:h-5 text-green-600" /></div>
                            <div className="min-w-0">
                                <h4 className="font-semibold text-green-900 text-sm sm:text-base">AI Practice Questions</h4>
                                <p className="text-xs sm:text-sm text-green-700 mt-1">Here you can practice questions generated by AI from chapter-wise PYQs. Select a chapter to generate 20 tailored practice questions.</p>
                            </div>
                        </div>
                    )}
                    {mode === 'PYQ' && (
                        <div className="mb-6 bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/30 dark:to-purple-900/30 border border-indigo-200 dark:border-indigo-700/50 p-3 sm:p-4 rounded-xl flex items-start gap-2 sm:gap-3">
                            <div className="bg-white dark:bg-gray-800 p-2 rounded-lg shadow-sm flex-shrink-0">
                                <svg className="w-4 sm:w-5 h-4 sm:h-5 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                </svg>
                            </div>
                            <div className="min-w-0">
                                <h4 className="font-semibold text-indigo-900 dark:text-indigo-200 flex flex-wrap items-center gap-2 text-sm sm:text-base">
                                    <span>AI-Analyzed PYQs</span>
                                    <span className="px-2 py-0.5 text-xs bg-indigo-100 dark:bg-indigo-800 text-indigo-700 dark:text-indigo-300 rounded-full">Smart Insights</span>
                                </h4>
                                <p className="text-xs sm:text-sm text-indigo-700 dark:text-indigo-300 mt-1">
                                    Topics and <strong>probability scores</strong> are determined by AI after analyzing <strong>5+ years of previous exam papers</strong>. 
                                    Focus on what matters most based on actual exam patterns.
                                </p>
                            </div>
                        </div>
                    )}
                    {mode === 'VIVA' ? (
                        <VivaModule 
                            selectedSubject={selectedSubject}
                            isAiVivaActive={isAiVivaActive}
                            setIsAiVivaActive={setIsAiVivaActive}
                            vivaChat={vivaChat}
                            vivaInput={vivaInput}
                            setVivaInput={setVivaInput}
                            isVivaLoading={isVivaLoading}
                            handleVivaSubmit={handleVivaSubmit}
                            startAiViva={startAiViva}
                            chatEndRef={chatEndRef}
                        />
                    ) : selectedSubject.groupedChapters ? (
                        Object.entries(selectedSubject.groupedChapters).map(([key, list]) => {
                            const sectionTitle = key === 'quantum' ? 'Quantum Mechanics' : key === 'statistical' ? 'Statistical Mechanics' : key;
                            const sortedList = [...list].sort((a, b) => b.prob - a.prob);
                            return (
                                <div key={key} className="space-y-3 mb-6">
                                    <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100">{sectionTitle}</h3>
                                    {sortedList.map((chapter) => (
                                            <div key={chapter.id} onClick={() => handleSelectChapterForMode(chapter)} className="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:border-blue-400 dark:hover:border-blue-500 hover:shadow-md cursor-pointer transition-all relative overflow-hidden card-hover">
                                            <div className={`absolute left-0 top-0 bottom-0 w-1 ${chapter.importance === 'Very High' ? 'bg-red-500' : chapter.importance === 'High' ? 'bg-orange-600' : chapter.importance === 'Medium' ? 'bg-yellow-500' : 'bg-emerald-500'}`} />
                                            <div className="flex justify-between items-start pl-3">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <h4 className="font-bold text-gray-900 dark:text-gray-100">{chapter.title}</h4>
                                                        <ImportanceBadge level={chapter.importance} />
                                                    </div>
                                                    <p className="text-sm text-gray-500 dark:text-gray-400 line-clamp-1">{chapter.description}</p>
                                                </div>
                                                <div className="text-right min-w-[80px]">
                                                    <span className="text-2xl font-bold text-gray-800 dark:text-gray-100">{chapter.pyqCount}</span>
                                                    <span className="text-xs text-gray-400 dark:text-gray-500 block">Questions</span>
                                                </div>
                                            </div>
                                            <div className="pl-3 mt-3 flex items-center gap-3">
                                                <ProgressBar percentage={chapter.prob} colorClass={chapter.importance === 'Very High' ? 'bg-red-500' : chapter.importance === 'High' ? 'bg-orange-600' : chapter.importance === 'Medium' ? 'bg-yellow-500' : 'bg-emerald-500'} />
                                                <span className="text-xs font-medium text-gray-400 dark:text-gray-500 w-8 text-right">{chapter.prob}%</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            );
                        })
                    ) : (
                        <div className="space-y-3">
                            {sortedChapters.map((chapter) => (
                                    <div key={chapter.id} onClick={() => handleSelectChapterForMode(chapter)} className="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:border-blue-400 dark:hover:border-blue-500 hover:shadow-md cursor-pointer transition-all relative overflow-hidden card-hover">
                                    <div className={`absolute left-0 top-0 bottom-0 w-1 ${chapter.importance === 'Very High' ? 'bg-red-500' : chapter.importance === 'High' ? 'bg-orange-600' : chapter.importance === 'Medium' ? 'bg-yellow-500' : 'bg-emerald-500'}`} />
                                    <div className="flex justify-between items-start pl-3">
                                        <div className="flex-1">
                                            <div className="flex items-center gap-2 mb-1">
                                                <h4 className="font-bold text-gray-900 dark:text-gray-100">{chapter.title}</h4>
                                                <ImportanceBadge level={chapter.importance} />
                                            </div>
                                            <p className="text-sm text-gray-500 dark:text-gray-400 line-clamp-1">{chapter.description}</p>
                                        </div>
                                        <div className="text-right min-w-[80px]">
                                            <span className="text-2xl font-bold text-gray-800 dark:text-gray-100">{chapter.pyqCount}</span>
                                            <span className="text-xs text-gray-400 dark:text-gray-500 block">Questions</span>
                                        </div>
                                    </div>
                                    <div className="pl-3 mt-3 flex items-center gap-3">
                                        <ProgressBar percentage={chapter.prob} colorClass={chapter.importance === 'Very High' ? 'bg-red-500' : chapter.importance === 'High' ? 'bg-orange-600' : chapter.importance === 'Medium' ? 'bg-yellow-500' : 'bg-emerald-500'} />
                                        <span className="text-xs font-medium text-gray-400 dark:text-gray-500 w-8 text-right">{chapter.prob}%</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const QuestionsView = ({ selectedSubject, selectedChapter, handleExplain, explanations, explainingId, bookmarks, onToggleBookmark, isBookmarked }) => {
            const probabilityStyles = {
                'Very High': 'bg-gradient-to-r from-red-500 to-rose-500 text-white',
                High: 'bg-gradient-to-r from-orange-500 to-amber-500 text-white',
                Medium: 'bg-gradient-to-r from-yellow-500 to-amber-400 text-white',
                Low: 'bg-gradient-to-r from-emerald-500 to-green-500 text-white',
            };
            const questionsAll = SUBJECT_QUESTIONS[selectedSubject?.id] || MOCK_QUESTIONS;
            const questions = selectedChapter && questionsAll[0]?.chapterId
                ? questionsAll.filter(q => q.chapterId === selectedChapter.id)
                : questionsAll;
            return (
                <div className="animate-in slide-in-from-right-8">
                    {/* Chapter Header */}
                    <div className="mb-8 pb-6 border-b border-gray-200 dark:border-gray-700">
                        <div className="flex items-center gap-3 mb-3">
                            <ImportanceBadge level={selectedChapter.importance} />
                            <span className="text-sm text-gray-500 dark:text-gray-400 font-medium flex items-center gap-1">
                                <Icons.FileText className="w-4 h-4" /> {selectedChapter.pyqCount} Questions Expected
                            </span>
                        </div>
                        <h2 className="text-2xl font-bold text-gray-900 dark:text-white">{selectedChapter.title}</h2>
                        <p className="text-gray-500 dark:text-gray-400 mt-1">Previous year questions and AI explanations</p>
                    </div>
                    
                    {/* Questions List */}
                    <div className="space-y-5">
                        {questions.map((q, idx) => (
                            <div key={q.id} className="group bg-white dark:bg-gray-800/80 rounded-2xl border border-gray-200 dark:border-gray-700 hover:border-indigo-300 dark:hover:border-indigo-600 transition-all duration-300 hover:shadow-lg hover:shadow-indigo-500/10 overflow-hidden">
                                {/* Question Number Bar */}
                                <div className="bg-gradient-to-r from-indigo-500 to-purple-500 px-5 py-2 flex items-center justify-between">
                                    <span className="text-white font-bold text-sm">Question {idx + 1}</span>
                                    <div className="flex items-center gap-2">
                                        <span className="bg-white/20 text-white text-xs font-semibold px-2 py-0.5 rounded">{q.year}</span>
                                        <span className="bg-white text-indigo-600 text-xs font-bold px-2 py-0.5 rounded">{q.marks} Marks</span>
                                    </div>
                                </div>
                                
                                <div className="p-5">
                                    {/* Tags & Probability */}
                                    <div className="flex flex-wrap items-center gap-2 mb-4">
                                        {q.tags?.map(tag => (
                                            <span key={tag} className="px-2.5 py-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs rounded-full font-medium">
                                                {tag}
                                            </span>
                                        ))}
                                        {q.probability && (
                                            <span className={`px-2.5 py-1 text-xs rounded-full font-bold shadow-sm ${probabilityStyles[q.probability] || probabilityStyles.Medium}`}>
                                                {q.probability} Probability
                                            </span>
                                        )}
                                        <button 
                                            onClick={() => onToggleBookmark(q)} 
                                            title={isBookmarked(q.id) ? 'Remove bookmark' : 'Bookmark'} 
                                            className={`ml-auto p-2 rounded-full transition-all ${isBookmarked(q.id) ? 'bg-yellow-100 dark:bg-yellow-900/50' : 'bg-gray-100 dark:bg-gray-700 hover:bg-yellow-50 dark:hover:bg-yellow-900/30'}`}
                                        >
                                            {isBookmarked(q.id) ? (
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" className="w-5 h-5 text-yellow-500" fill="currentColor"><path d="M6 2h12a1 1 0 011 1v18l-7-4-7 4V3a1 1 0 011-1z"/></svg>
                                            ) : (
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" className="w-5 h-5 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 2h12a1 1 0 011 1v18l-7-4-7 4V3a1 1 0 011-1z"/></svg>
                                            )}
                                        </button>
                                    </div>
                                    
                                    {/* Question Text */}
                                    <p className="text-gray-800 dark:text-gray-100 font-medium leading-relaxed text-base">{q.text}</p>
                                    
                                    {/* Actions */}
                                    <div className="mt-5 flex flex-wrap items-center gap-3 pt-4 border-t border-gray-100 dark:border-gray-700">
                                        <button 
                                            onClick={() => handleExplain(q)} 
                                            className={`text-sm px-4 py-2 rounded-full font-semibold flex items-center gap-2 transition-all ${
                                                explanations[q.id] 
                                                    ? 'bg-indigo-600 text-white hover:bg-indigo-700' 
                                                    : 'bg-gradient-to-r from-indigo-500 to-purple-500 text-white hover:from-indigo-600 hover:to-purple-600 shadow-md hover:shadow-lg'
                                            }`}
                                        >
                                            <Icons.Bot className="w-4 h-4" />
                                            {explanations[q.id] ? 'Hide Explanation' : 'Explain with AI'}
                                        </button>
                                    </div>
                                    
                                    {/* AI Explanation */}
                                    {explainingId === q.id && (
                                        <div className="mt-5 bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-900/30 dark:to-purple-900/30 rounded-xl p-5 border border-indigo-200 dark:border-indigo-800 animate-in">
                                            <h4 className="font-bold text-indigo-900 dark:text-indigo-300 mb-3 flex items-center gap-2">
                                                <div className="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center">
                                                    <Icons.Bot className="w-4 h-4 text-white" />
                                                </div>
                                                AI Tutor Explanation
                                            </h4>
                                            {explanations[q.id] === 'loading' ? (
                                                <div className="flex items-center gap-3 text-indigo-600 dark:text-indigo-300 py-4">
                                                    <Icons.Loader2 className="w-5 h-5 animate-spin" />
                                                    <span className="font-medium">Generating explanation...</span>
                                                </div>
                                            ) : (
                                                <AiText text={explanations[q.id]} className="text-gray-700 dark:text-gray-200 leading-relaxed" />
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const PracticeQuestionsView = ({ selectedSubject, selectedChapter, practiceQuestions, setPracticeQuestions, loadingPractice, generatingChapterId, bookmarks, onToggleBookmark, isBookmarked, handleExplain, explanations, explainingId }) => {
            const handleGeneratePractice = async (chapter) => {
                if (practiceQuestions[chapter.id]) return; // Already generated
                
                const pyqList = SUBJECT_QUESTIONS[selectedSubject?.id] || MOCK_QUESTIONS;
                const relatedPyqs = pyqList.filter(q => q.chapterId === chapter.id).slice(0, 5);
                const pyqContext = relatedPyqs.map(q => `- ${q.text}`).join('\n');
                
                loadingPractice(chapter.id);
                
                const prompt = `You are an expert question designer for "${selectedSubject.title}". Based on these sample PYQs for the chapter "${chapter.title}":
${pyqContext}

Generate exactly 20 unique, challenging practice questions that:
1) Follow the same difficulty and style as the PYQs
2) Cover different aspects of the chapter
3) Are suitable for exam preparation
4) Range from simple to advanced

Format each question as:
Q1. [Question text]
Q2. [Question text]
... and so on.

Generate ALL 20 questions:`;
                
                const response = await callGemini(prompt, "Generate exactly 20 practice questions in the specified format. Be thorough and educational.");
                const questions = response.split('\n').filter(line => line.match(/^Q\d+\./)).map((line, idx) => ({
                    id: `practice_${chapter.id}_${idx}`,
                    chapterId: chapter.id,
                    year: 'Practice',
                    marks: '1-3',
                    text: line.replace(/^Q\d+\.\s*/, '').trim(),
                    tags: ['Practice', 'Generated'],
                    probability: 'Medium'
                }));
                
                // Properly update state using setState to persist questions
                setPracticeQuestions(prev => ({ ...prev, [chapter.id]: questions }));
                loadingPractice(null); // Clear loading state
            };
            
            const questions = practiceQuestions[selectedChapter.id] || [];
            
            return (
                <div className="animate-in slide-in-from-right-8">
                    {/* Chapter Header */}
                    <div className="mb-8 pb-6 border-b border-gray-200 dark:border-gray-700">
                        <div className="flex items-center gap-3 mb-3">
                            <span className="inline-flex items-center gap-1.5 px-3 py-1 bg-gradient-to-r from-emerald-500 to-green-500 text-white text-xs rounded-full font-bold shadow-sm">
                                <Icons.Zap className="w-3 h-3" /> AI Generated
                            </span>
                            <span className="text-sm text-gray-500 dark:text-gray-400 font-medium">{questions.length} Practice Questions</span>
                        </div>
                        <h2 className="text-2xl font-bold text-gray-900 dark:text-white">{selectedChapter.title}</h2>
                        <p className="text-gray-500 dark:text-gray-400 mt-1">AI-generated practice questions for exam prep</p>
                        
                        {!questions.length && (
                            <button 
                                onClick={() => handleGeneratePractice(selectedChapter)} 
                                disabled={generatingChapterId === selectedChapter.id} 
                                className="mt-5 px-6 py-3 bg-gradient-to-r from-emerald-500 to-green-500 hover:from-emerald-600 hover:to-green-600 text-white rounded-xl font-semibold flex items-center gap-2 shadow-lg hover:shadow-xl transition-all disabled:opacity-70"
                            >
                                {generatingChapterId === selectedChapter.id ? (
                                    <><Icons.Loader2 className="w-5 h-5 animate-spin" /> Generating 20 questions...</>
                                ) : (
                                    <><Icons.Zap className="w-5 h-5" /> Generate Practice Questions</>
                                )}
                            </button>
                        )}
                    </div>
                    
                    {/* Questions List */}
                    {questions.length > 0 ? (
                        <div className="space-y-5">
                            {questions.map((q, idx) => (
                                <div key={q.id} className="group bg-white dark:bg-gray-800/80 rounded-2xl border border-gray-200 dark:border-gray-700 hover:border-emerald-300 dark:hover:border-emerald-600 transition-all duration-300 hover:shadow-lg hover:shadow-emerald-500/10 overflow-hidden">
                                    {/* Question Number Bar */}
                                    <div className="bg-gradient-to-r from-emerald-500 to-green-500 px-5 py-2 flex items-center justify-between">
                                        <span className="text-white font-bold text-sm">Practice Q{idx + 1}</span>
                                        <div className="flex items-center gap-2">
                                            <span className="bg-white/20 text-white text-xs font-semibold px-2 py-0.5 rounded">Generated</span>
                                            <span className="bg-white text-emerald-600 text-xs font-bold px-2 py-0.5 rounded">{q.marks} Marks</span>
                                        </div>
                                    </div>
                                    
                                    <div className="p-5">
                                        {/* Tags & Bookmark */}
                                        <div className="flex flex-wrap items-center gap-2 mb-4">
                                            {q.tags?.map(tag => (
                                                <span key={tag} className="px-2.5 py-1 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300 text-xs rounded-full font-medium">
                                                    {tag}
                                                </span>
                                            ))}
                                            <button 
                                                onClick={() => onToggleBookmark(q)} 
                                                title={isBookmarked(q.id) ? 'Remove bookmark' : 'Bookmark'} 
                                                className={`ml-auto p-2 rounded-full transition-all ${isBookmarked(q.id) ? 'bg-yellow-100 dark:bg-yellow-900/50' : 'bg-gray-100 dark:bg-gray-700 hover:bg-yellow-50 dark:hover:bg-yellow-900/30'}`}
                                            >
                                                {isBookmarked(q.id) ? (
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" className="w-5 h-5 text-yellow-500" fill="currentColor"><path d="M6 2h12a1 1 0 011 1v18l-7-4-7 4V3a1 1 0 011-1z"/></svg>
                                                ) : (
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" className="w-5 h-5 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 2h12a1 1 0 011 1v18l-7-4-7 4V3a1 1 0 011-1z"/></svg>
                                                )}
                                            </button>
                                        </div>
                                        
                                        {/* Question Text */}
                                        <p className="text-gray-800 dark:text-gray-100 font-medium leading-relaxed text-base">{q.text}</p>
                                        
                                        {/* Actions */}
                                        <div className="mt-5 flex flex-wrap items-center gap-3 pt-4 border-t border-gray-100 dark:border-gray-700">
                                            <button 
                                                onClick={() => handleExplain(q)} 
                                                className={`text-sm px-4 py-2 rounded-full font-semibold flex items-center gap-2 transition-all ${
                                                    explanations[q.id] 
                                                        ? 'bg-emerald-600 text-white hover:bg-emerald-700' 
                                                        : 'bg-gradient-to-r from-emerald-500 to-green-500 text-white hover:from-emerald-600 hover:to-green-600 shadow-md hover:shadow-lg'
                                                }`}
                                            >
                                                <Icons.Bot className="w-4 h-4" />
                                                {explanations[q.id] ? 'Hide Explanation' : 'Explain with AI'}
                                            </button>
                                        </div>
                                        
                                        {/* AI Explanation */}
                                        {explainingId === q.id && (
                                            <div className="mt-5 bg-gradient-to-br from-emerald-50 to-green-50 dark:from-emerald-900/30 dark:to-green-900/30 rounded-xl p-5 border border-emerald-200 dark:border-emerald-800 animate-in">
                                                <h4 className="font-bold text-emerald-900 dark:text-emerald-300 mb-3 flex items-center gap-2">
                                                    <div className="w-8 h-8 rounded-full bg-gradient-to-br from-emerald-500 to-green-500 flex items-center justify-center">
                                                        <Icons.Bot className="w-4 h-4 text-white" />
                                                    </div>
                                                    AI Tutor Explanation
                                                </h4>
                                                {explanations[q.id] === 'loading' ? (
                                                    <div className="flex items-center gap-3 text-emerald-600 dark:text-emerald-300 py-4">
                                                        <Icons.Loader2 className="w-5 h-5 animate-spin" />
                                                        <span className="font-medium">Generating explanation...</span>
                                                    </div>
                                                ) : (
                                                    <AiText text={explanations[q.id]} className="text-gray-700 dark:text-gray-200 leading-relaxed" />
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : generatingChapterId !== selectedChapter.id ? (
                        <div className="text-center py-12">
                            <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-br from-emerald-100 to-green-100 dark:from-emerald-900/30 dark:to-green-900/30 flex items-center justify-center">
                                <Icons.Zap className="w-8 h-8 text-emerald-500" />
                            </div>
                            <p className="text-gray-500 dark:text-gray-400 font-medium">No questions generated yet</p>
                            <p className="text-gray-400 dark:text-gray-500 text-sm mt-1">Click the button above to generate 20 practice questions</p>
                        </div>
                    ) : null}
                </div>
            );
        };

        // --- Main App ---

        function App() {
            const [viewState, setViewState] = useState('SUBJECTS');
            const [selectedSubject, setSelectedSubject] = useState(null);
            const [selectedChapter, setSelectedChapter] = useState(null);
            const [mode, setMode] = useState('PYQ');

            // AI State
            const [explainingId, setExplainingId] = useState(null);
            const [explanations, setExplanations] = useState({});
            
            // Practice Questions State
            const [practiceQuestions, setPracticeQuestions] = useState({});
            const [generatingChapterId, setGeneratingChapterId] = useState(null);
            
            // Viva State (Lifted to App)
            const [isAiVivaActive, setIsAiVivaActive] = useState(false);
            const [vivaChat, setVivaChat] = useState([]);
            const [vivaInput, setVivaInput] = useState("");
            const [isVivaLoading, setIsVivaLoading] = useState(false);
            const chatEndRef = useRef(null);

            // Tools: Bookmarks
            const [showBookmarks, setShowBookmarks] = useState(false);
            const [bookmarks, setBookmarks] = useState(() => {
                const saved = localStorage.getItem('exammode_bookmarks');
                return saved ? JSON.parse(saved) : {};
            });
            const isBookmarked = (id) => Boolean(bookmarks[id]);
            const toggleBookmark = (q) => {
                setBookmarks(prev => {
                    const next = { ...prev };
                    if (next[q.id]) delete next[q.id]; else next[q.id] = { id: q.id, text: q.text, marks: q.marks, chapterId: q.chapterId || selectedChapter?.id, subjectId: selectedSubject?.id };
                    return next;
                });
            };

            const handleSelectSubject = (subject, defaultMode = 'PYQ') => {
                setSelectedSubject(subject);
                setViewState('CHAPTERS');
                setMode(defaultMode);
                setIsAiVivaActive(false);
            };

            const handleSelectChapter = (chapter) => {
                if (mode === 'VIVA') return;
                setSelectedChapter(chapter);
                setViewState('QUESTIONS');
            };

            const handleBack = () => {
                if (viewState === 'QUESTIONS') {
                    setViewState('CHAPTERS');
                    setSelectedChapter(null);
                } else if (viewState === 'CHAPTERS') {
                    setViewState('SUBJECTS');
                    setSelectedSubject(null);
                    setIsAiVivaActive(false);
                }
            };

            const handleExplain = async (question) => {
                if (explanations[question.id]) {
                    setExplainingId(explainingId === question.id ? null : question.id);
                    return;
                }
                setExplainingId(question.id);
                setExplanations(prev => ({ ...prev, [question.id]: 'loading' }));
                const prompt = `You are an expert academic tutor. Explain this question: "${question.text}"`;
                const response = await callGemini(prompt, "Provide a clear, academic explanation.");
                setExplanations(prev => ({ ...prev, [question.id]: cleanAiText(response) }));
            };

            const startAiViva = async () => {
                setIsAiVivaActive(true);
                setVivaChat([{ role: 'ai', text: 'Starting session...', loading: true }]);
                setIsVivaLoading(true);
                const pyqContext = buildPyqContext(selectedSubject);
                const prompt = `You are starting a viva prep session for "${selectedSubject.title}". Begin with a warm greeting, then ask ONE moderate-difficulty foundational question from this PYQ pool to assess the student's baseline knowledge. Be encouraging.\nPYQs:\n${pyqContext}\n\nStart with: [Warm greeting] + [ONE foundational question]`;
                const response = await callGemini(prompt, TEACHER_SYSTEM_INSTRUCTION);
                setVivaChat([{ role: 'ai', text: cleanAiText(response) }]);
                setIsVivaLoading(false);
            };

            const handleVivaSubmit = async (e) => {
                e.preventDefault();
                if (!vivaInput.trim() || isVivaLoading) return;
                const userMsg = vivaInput;
                setVivaInput("");
                setVivaChat(prev => [...prev, { role: 'user', text: userMsg }]);
                setIsVivaLoading(true);
                setVivaChat(prev => [...prev, { role: 'ai', text: '', loading: true }]);
                
                const lastAiMsg = vivaChat[vivaChat.length - 1]?.text || "";
                const pyqContext = buildPyqContext(selectedSubject);
                const conversationContext = vivaChat.slice(-6).map(m => `${m.role === 'user' ? 'Student' : 'Teacher'}: ${m.text}`).join('\n');
                
                const prompt = `You are mentoring a student in ${selectedSubject.title}.\nConversation so far:\n${conversationContext}\n---\nStudent just answered: "${userMsg}"\nPYQ pool (draw next questions from these only):\n${pyqContext}\n\nRespond as a teacher:\n1) Evaluate their understanding (0-5 score). Identify what they got right and where they need improvement.\n2) If answer is weak: Offer a hint or guiding question (Socratic method) to help them think deeper.\n3) If answer is strong: Acknowledge it, explain why, and ask a follow-up to deepen their understanding OR move to a related harder question.\n4) End with exactly ONE next question from the PYQ pool (fresh question, not a repeat). Make it slightly harder if they did well, stay at current level if they struggled.\n5) Be specific, encouraging, and educational. Connect their answer to broader concepts.`;
                
                                const response = await callGemini(prompt, TEACHER_SYSTEM_INSTRUCTION);
                                const cleaned = cleanAiText(response);
                
                setVivaChat(prev => {
                    const newChat = [...prev];
                    newChat.pop();
                                    return [...newChat, { role: 'ai', text: cleaned }];
                });
                setIsVivaLoading(false);
            };

            useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [vivaChat]);

            useEffect(() => {
                localStorage.setItem('exammode_bookmarks', JSON.stringify(bookmarks));
            }, [bookmarks]);

            const goToBookmark = (bm) => {
                const subjectList = [...THEORY_SUBJECTS, ...LAB_SUBJECTS];
                const subject = subjectList.find(s => s.id === bm.subjectId) || selectedSubject;
                if (subject) {
                    setSelectedSubject(subject);
                    setViewState('CHAPTERS');
                    setMode('PYQ');
                    const chaptersSource = subject.groupedChapters ? Object.values(subject.groupedChapters).flat() : subject.chapters;
                    const chapter = chaptersSource.find(c => c.id === bm.chapterId) || chaptersSource[0];
                    if (chapter) {
                        setSelectedChapter(chapter);
                        setViewState('QUESTIONS');
                    }
                }
                setShowBookmarks(false);
            };

            return (
                <div className="min-h-screen rainbow-bg">
                    <header className="app-header">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 h-16 flex items-center justify-between overflow-hidden">
                            <div className="flex items-center gap-2 sm:gap-3 min-w-0">
                                <button onClick={() => window.location.href = '/'} className="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition flex-shrink-0" title="Back to Home">
                                    <Icons.ArrowLeft className="w-5 h-5 text-gray-600 dark:text-gray-400" />
                                </button>
                                <img src="Logo%20F.jpeg" alt="UniAssist" className="w-8 h-8 rounded-lg object-contain flex-shrink-0" />
                                <div className="min-w-0">
                                    <h1 className="text-base sm:text-lg font-bold tracking-tight text-gray-900 dark:text-white truncate">UniAssist</h1>
                                    <p className="text-xs text-gray-500 dark:text-gray-400 -mt-0.5 hidden sm:block">AI Study Companion</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-2 sm:gap-3 flex-shrink-0">
                                <button
                                    onClick={() => window.darkModeToggle()}
                                    className="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition"
                                    title="Toggle dark/light mode"
                                >
                                    <svg className="w-5 h-5 text-gray-600 dark:text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                                    </svg>
                                </button>
                                <button
                                    onClick={() => window.location.href = 'profile'}
                                    className="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition"
                                    title="Profile"
                                >
                                    <Icons.User className="w-5 h-5 text-gray-600 dark:text-gray-300" />
                                </button>
                            </div>
                        </div>
                    </header>
                    <div className="max-w-7xl mx-auto px-4 py-8 flex gap-6 overflow-x-hidden">
                        <main className="flex-1 min-w-0 overflow-x-hidden">
                        <nav className="flex items-center text-sm mb-8 font-medium glass-card rounded-full px-4 py-2 w-fit max-w-full overflow-x-auto">
                            <span className={`${viewState === 'SUBJECTS' ? 'text-indigo-600 dark:text-indigo-400 font-semibold' : 'text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white cursor-pointer'} transition-colors whitespace-nowrap`} onClick={() => { setViewState('SUBJECTS'); setSelectedSubject(null); }}>🏠 Home</span>
                            {selectedSubject && <><Icons.ChevronRight className="w-4 h-4 mx-2 text-gray-400 flex-shrink-0" /><span className={`${viewState === 'CHAPTERS' ? 'text-indigo-600 dark:text-indigo-400 font-semibold' : 'text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white cursor-pointer'} transition-colors truncate max-w-[120px] md:max-w-none`} onClick={() => { setViewState('CHAPTERS'); setSelectedChapter(null); }}>{selectedSubject.title}</span></>}
                            {selectedChapter && <><Icons.ChevronRight className="w-4 h-4 mx-2 text-gray-400 flex-shrink-0" /><span className="text-indigo-600 dark:text-indigo-400 font-semibold truncate max-w-[100px] md:max-w-none">{selectedChapter.title}</span></>}
                        </nav>
                        {mode === 'VIVA' && (
                            <div className="mb-6 bg-indigo-50 border border-indigo-100 p-4 rounded-xl flex items-start gap-3">
                                <div className="bg-white p-2 rounded-lg shadow-sm"><Icons.Mic className="w-5 h-5 text-indigo-600" /></div>
                                <div>
                                    <h4 className="font-semibold text-indigo-900">Viva Voce Practice</h4>
                                    <p className="text-sm text-indigo-700 mt-1">Practice viva-style questions by talking with the AI teacher. You’ll get instant feedback, hints, and adaptive follow-ups.</p>
                                </div>
                            </div>
                        )}
                        <div className="min-h-[600px]">
                            {viewState === 'SUBJECTS' && <SubjectsView onSelectSubject={handleSelectSubject} onOpenBookmarks={() => setShowBookmarks(true)} />}
                            
                            {viewState === 'CHAPTERS' && (
                                <ChaptersView 
                                    selectedSubject={selectedSubject}
                                    handleSelectChapter={handleSelectChapter}
                                    mode={mode}
                                    setMode={setMode}
                                    setIsAiVivaActive={setIsAiVivaActive}
                                    isAiVivaActive={isAiVivaActive}
                                    vivaChat={vivaChat}
                                    vivaInput={vivaInput}
                                    setVivaInput={setVivaInput}
                                    isVivaLoading={isVivaLoading}
                                    handleVivaSubmit={handleVivaSubmit}
                                    startAiViva={startAiViva}
                                    chatEndRef={chatEndRef}
                                />
                            )}
                            
                            {viewState === 'QUESTIONS' && mode === 'PRACTICE' ? (
                                <PracticeQuestionsView 
                                    selectedSubject={selectedSubject}
                                    selectedChapter={selectedChapter}
                                    practiceQuestions={practiceQuestions}
                                    setPracticeQuestions={setPracticeQuestions}
                                    loadingPractice={setGeneratingChapterId}
                                    generatingChapterId={generatingChapterId}
                                    bookmarks={bookmarks}
                                    onToggleBookmark={toggleBookmark}
                                    isBookmarked={isBookmarked}
                                    handleExplain={handleExplain}
                                    explanations={explanations}
                                    explainingId={explainingId}
                                />
                            ) : viewState === 'QUESTIONS' ? (
                                <QuestionsView 
                                    selectedSubject={selectedSubject}
                                    selectedChapter={selectedChapter}
                                    handleExplain={handleExplain}
                                    explanations={explanations}
                                    explainingId={explainingId}
                                    bookmarks={bookmarks}
                                    onToggleBookmark={toggleBookmark}
                                    isBookmarked={isBookmarked}
                                />
                            ) : null}
                        </div>
                    </main>
                </div>
                    <BookmarksModal 
                        open={showBookmarks}
                        onClose={() => setShowBookmarks(false)}
                        bookmarks={bookmarks}
                        onGo={goToBookmark}
                    />
                    <footer className="border-t border-gray-200 dark:border-gray-700 mt-12 py-8 text-center text-sm text-gray-400 dark:text-gray-500 bg-white dark:bg-gray-800">
                        <p>&copy; 2024 ExamMode. <span className="text-indigo-500 font-medium">AI-Driven Insights</span>.</p>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>